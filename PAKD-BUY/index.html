<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAKD BUY 4.0 ‚Äì H&D Aluminum Strategy</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#0e1520;color:#dce6f4;height:100vh;overflow:hidden;font-size:14px;}
.mono{font-family:'JetBrains Mono',monospace;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:#0e1520;}
::-webkit-scrollbar-thumb{background:#2a3f58;border-radius:3px;}

.inp{width:100%;background:#141f30;border:1px solid #2a3f58;color:#dce6f4;border-radius:4px;padding:5px 8px;font-size:.82rem;transition:border-color .15s;}
.inp:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.15);}
.inp-xs{padding:4px 6px;font-size:.78rem;}
.inp-sm{padding:5px 7px;font-size:.80rem;}
select.inp option{background:#141f30;}
.inp[readonly]{background:#0c1420;color:#4d6a82;cursor:not-allowed;}
.lbl{display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#7ba3be;margin-bottom:3px;}
.card{background:#131e2e;border:1px solid #1e3347;border-radius:8px;padding:13px;}
.card-inset{background:#0f1928;border:1px solid #1a2e42;border-radius:6px;padding:10px;}
.sh{font-size:.71rem;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:#6b9ab8;border-bottom:1px solid #1e3347;padding-bottom:7px;margin-bottom:11px;display:flex;align-items:center;gap:6px;}
.tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:4px;font-size:.73rem;font-weight:800;font-family:'JetBrains Mono',monospace;white-space:nowrap;}
.tg{background:#041f0d;color:#4ade80;border:1px solid #166534;}
.ty{background:#1c1500;color:#fcd34d;border:1px solid #854d0e;}
.tr{background:#1c0505;color:#fc8181;border:1px solid #991b1b;}
.tb{background:#04102e;color:#93c5fd;border:1px solid #1d4ed8;}
.tp{background:#0f0528;color:#d8b4fe;border:1px solid #6d28d9;}
.ts{background:#131e2e;color:#94a3b8;border:1px solid #2a3f58;}
.to{background:#1a0e00;color:#fb923c;border:1px solid #c2410c;}
.btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:5px;font-size:.78rem;font-weight:700;cursor:pointer;border:none;transition:all .15s;font-family:'Inter',sans-serif;}
.btn-ghost{background:transparent;border:1px dashed #2a3f58;color:#60a5fa;}
.btn-ghost:hover{background:#071830;border-color:#3b82f6;}
.btn-solid{background:#0f2040;color:#93c5fd;border:1px solid #1e3a5f;}
.btn-solid:hover{background:#1e3a5f;color:#fff;}
.btn-sm{padding:4px 9px;font-size:.73rem;}
.btn-xs{padding:3px 7px;font-size:.67rem;}
.btn-danger{background:transparent;border:none;color:#4a7090;padding:2px 5px;cursor:pointer;border-radius:3px;font-size:.82rem;}
.btn-danger:hover{color:#fc8181;background:#3b0a0a30;}
.btn-success{background:#041f0d;border:1px solid #166534;color:#4ade80;}
.btn-success:hover{background:#166534;color:#fff;}
.btn-warning{background:#1c1500;border:1px solid #854d0e;color:#fcd34d;}
.btn-warning:hover{background:#854d0e;color:#fff;}
.btn-export{background:#0a1a2e;border:1px solid #2a3f58;color:#93c5fd;}
.btn-export:hover{background:#1e3a5f;color:#fff;}
.tbl{width:100%;border-collapse:collapse;font-size:.82rem;}
.tbl th{background:#0c1726;color:#7ba3be;font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;padding:7px 8px;text-align:center;border-bottom:1px solid #1e3347;white-space:nowrap;}
.tbl td{padding:4px 5px;border-bottom:1px solid #111d2c;vertical-align:middle;}
.tbl tbody tr:hover td{background:#0d1a28;}
.tbl tfoot td{border-top:1px solid #1d4ed8;padding:7px 9px;font-weight:700;}
.tbl .inp{background:#0c1726;border-color:#1e3347;}
.tbl .inp:focus{background:#0e1e32;border-color:#3b82f6;}
.kpi{padding:11px 13px;background:#0c1726;border:1px solid #1e3347;border-radius:7px;}
.kpi-l{font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#6b9ab8;margin-bottom:4px;}
.kpi-v{font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:800;line-height:1.15;}
.kpi-s{font-size:.7rem;color:#5a7a92;margin-top:3px;}
.nav-tab{padding:6px 13px;font-size:.77rem;font-weight:700;cursor:pointer;border-radius:5px;border:1px solid transparent;color:#5a7a92;transition:all .15s;background:transparent;}
.nav-tab.on{background:#131e2e;border-color:#1e3347;color:#93c5fd;}
.nav-tab:not(.on):hover{color:#93c5fd;}
.status-btn{flex:1;padding:4px 8px;font-size:.72rem;font-weight:700;border-radius:4px;cursor:pointer;transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;}
.status-btn.s-stock{background:#041f0d;border-color:#166534;color:#4ade80;}
.status-btn.s-transit{background:#1c1500;border-color:#854d0e;color:#fcd34d;}
.status-btn.off{background:transparent;border-color:#1e3347;color:#4a7090;}
.sku-card{background:#0c1726;border:1px solid #1e3347;border-radius:7px;padding:11px 13px;transition:border-color .15s;}
.sku-card:hover{border-color:#2a4a68;}
.sku-card.warn{border-color:#991b1b;background:#0e0808;}
.sku-card.ok{border-color:#166534;}
.sku-card.alert-low{border-color:#c2410c;background:#140800;}
.chart-box{background:#0c1726;border:1px solid #1e3347;border-radius:7px;padding:11px;}
.div-line{border-top:1px solid #1e3347;margin:8px 0;}
/* spinner */
.spinner{width:18px;height:18px;border:2px solid #1e3347;border-top-color:#3b82f6;border-radius:50%;animation:spin .7s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
/* stock alert bar */
.stock-bar{height:5px;border-radius:3px;background:#1e3347;overflow:hidden;}
.stock-bar-fill{height:100%;border-radius:3px;transition:width .3s;}
/* pulse animation for warning */
@keyframes pulse-warn{0%,100%{opacity:1}50%{opacity:.6}}
.pulse{animation:pulse-warn 1.5s infinite;}
@media print{
  .no-print{display:none!important;}
  body{background:#fff;color:#000;height:auto;overflow:auto;}
  .card,.kpi,.sku-card{background:#fff;border:1px solid #ccc;}
  .tbl th{background:#f3f4f6;color:#374151;}
}
</style>
</head>
<body>
<div id="root" style="height:100vh;display:flex;flex-direction:column;overflow:hidden;"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo,useCallback} = React;

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ALLOYS  = ["A1050","A1052","A1060","A3003","A3003 CT","A3105","A5052","A5083","A6061","A6063"];
const TEMPERS = ["H14","H16","H18","H24","H32","H34","H111","O","T5","T6"];
const THICKS  = ["0.4","0.5","0.6","0.7","0.8","0.9","1.0","1.2","1.5","2.0","2.5","3.0","4.0","5.0","6.0"];
const WIDTHS  = ["600","800","1000","1200","1220","1250","1500","1524","2000"];
const LENGTHS = ["Coil","1000","1200","2000","2400","2500","3000","4000","6000","Custom"];

// Link l·∫•y d·ªØ li·ªáu t·ªìn kho (tab ƒë·∫ßu ti√™n c√≥ gid=0)
const GSHEET_INVENTORY = "https://docs.google.com/spreadsheets/d/1iNyB0XTf3rqZyHcmujYuuKlXh6QXTQqr-LQ1f6IEGxU/export?format=csv&gid=0";

// Link l·∫•y d·ªØ li·ªáu Min Stock
// C·∫¢NH B√ÅO: Anh nh·ªõ thay YOUR_MINSTOCK_GID b·∫±ng d√£y s·ªë gid th·ª±c t·∫ø c·ªßa tab MinStock nh√© (khi click sang tab Min Stock tr√™n file Google Sheet, anh nh√¨n l√™n thanh ƒë·ªãa ch·ªâ c·ªßa tr√¨nh duy·ªát s·∫Ω th·∫•y th√¥ng s·ªë gid=...)
const GSHEET_MINSTOCK  = "https://docs.google.com/spreadsheets/d/1iNyB0XTf3rqZyHcmujYuuKlXh6QXTQqr-LQ1f6IEGxU/export?format=csv&gid=1080747466";

const skuKey   = r => `${r.alloy}|${r.temper}|${r.thickness}|${r.width}|${r.length}`;
const skuLabel = r => `${r.alloy} ${r.temper}  ${r.thickness}√ó${r.width}√ó${r.length}`;
const skuShort = r => `${r.alloy} ${r.temper} ${r.thickness}mm`;

const uid = () => Date.now() + Math.random();
const fv  = v => (isNaN(v)||!isFinite(v)) ? '0' : new Intl.NumberFormat('vi-VN').format(Math.round(v));
const fu  = v => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:1}).format(v||0);
const pn  = s => parseFloat(String(s).replace(/\./g,'').replace(/,/g,''))||0;

// ‚îÄ‚îÄ CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCsv(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\r/g,''));
  return lines.slice(1).map(line => {
    const vals = line.split(',').map(v=>v.trim().replace(/\r/g,''));
    const obj = {};
    headers.forEach((h,i) => obj[h] = vals[i]||'');
    return obj;
  }).filter(r => r.alloy && r.alloy !== '');
}

async function fetchCsv(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  return parseCsv(text);
}

// ‚îÄ‚îÄ ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const weightedAvg = rows => {
  const qty = rows.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0), 0);
  const val = rows.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0)*(parseFloat(r.avgCost)||0), 0);
  return qty > 0 ? val/qty : 0;
};

const groupBySku = rows => {
  const map = {};
  rows.forEach(r => {
    const k = skuKey(r);
    if (!map[k]) map[k] = {key:k,label:skuLabel(r),alloy:r.alloy,temper:r.temper,thickness:r.thickness,width:r.width,length:r.length,inStock:[],inTransit:[]};
    if (r.status==='IN_STOCK') map[k].inStock.push(r);
    else map[k].inTransit.push(r);
  });
  return Object.values(map);
};

const calcInvoice = (products, exRate) => {
  const usd = products.reduce((s,p)=>s+(p.qtyKg/1000)*p.priceFC, 0);
  return {invoiceUSD:usd, invoiceVND:usd*exRate};
};

const calcLanded = (invoiceVND, totalKg, inp) => {
  const mgmt    = invoiceVND*(inp.managementFee/100);
  const tax     = invoiceVND*(inp.importTax/100);
  const freight = Math.max(0, inp.freightTotal);
  const proc    = inp.processingCost*totalKg;
  const total   = invoiceVND+mgmt+tax+freight+proc;
  return {mgmt, tax, freight, proc, landedVND:total, landedPerKg:totalKg>0?total/totalKg:0};
};

const calcFinance = (invoiceVND, land, totalKg, inp) => {
  const days = inp.leadTime + inp.holdingTime;
  let fin = 0;
  if (inp.paymentMethod==='TT') {
    fin = (invoiceVND+land.tax+land.freight)*(inp.capitalCostPercent/100)*(days/365);
  } else {
    fin = invoiceVND*(inp.lcOpenFee/100)
        + invoiceVND*(inp.lcInterest/100)*(inp.lcDays/365)
        + (invoiceVND*inp.lcMargin/100+land.tax+land.freight)*(inp.capitalCostPercent/100)*(days/365);
  }
  return {finVND:fin, finPerKg:totalKg>0?fin/totalKg:0};
};

const calcProductBreakdown = (products, land, fin, totalKg, inp) => {
  return products.map(p => {
    const ratio  = totalKg>0 ? p.qtyKg/totalKg : 0;
    const invVND = (p.qtyKg/1000)*p.priceFC*inp.exchangeRate;
    const mgmt   = invVND*(inp.managementFee/100);
    const tax    = invVND*(inp.importTax/100);
    const freight= land.freight*ratio;
    const proc   = inp.processingCost*p.qtyKg;
    const finRow = fin.finVND*ratio;
    const landedRow = invVND+mgmt+tax+freight+proc;
    const physPerKg = p.qtyKg>0 ? landedRow/p.qtyKg : 0;
    const econPerKg = physPerKg + (p.qtyKg>0 ? finRow/p.qtyKg : 0);
    return {...p, invVND, landedRow, finRow, physPerKg, econPerKg};
  });
};

const calcSkuBlend = (inventory, purchaseRows, sellingPrices, globalContractPrice, inputs, minStockMap) => {
  const skuGroups = groupBySku(inventory);
  return purchaseRows.map(p => {
    const k   = skuKey(p);
    const grp = skuGroups.find(g=>g.key===k);
    const stockRows   = grp ? grp.inStock   : [];
    const transitRows = grp ? grp.inTransit : [];
    const allExisting = [...stockRows, ...transitRows];
    const avgCurrent  = weightedAvg(allExisting);
    const avgStock    = weightedAvg(stockRows);
    const avgTransit  = weightedAvg(transitRows);
    const qtyStock    = stockRows.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0);
    const qtyTransit  = transitRows.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0);
    const qtyExisting = qtyStock + qtyTransit;
    const newRow   = {qtyKg:p.qtyKg, avgCost:p.physPerKg||0};
    const avgAfter = weightedAvg([...allExisting.map(r=>({qtyKg:parseFloat(r.qtyKg)||0,avgCost:parseFloat(r.avgCost)||0})), newRow]);
    const qtyAfter = qtyExisting + p.qtyKg;
    const finPerKg = p.qtyKg>0 ? p.finRow/p.qtyKg : 0;
    const custFin  = avgAfter*(inputs.lendingRate/100)*(inputs.customerCreditDays/365);
    const breakEven = avgAfter + finPerKg + custFin;
    const spKey1 = p.alloy+' '+p.temper;
    const spKey2 = p.alloy;
    const sp = sellingPrices.find(s=>s.alloy===spKey1) || sellingPrices.find(s=>s.alloy===spKey2);
    const sellPrice = sp ? sp.price : globalContractPrice;
    const realProfit = sellPrice*(1-inputs.businessRiskPercent/100) - breakEven;
    const isRisk     = breakEven > sellPrice;
    // Min stock
    const minStock   = minStockMap[k] || 0;
    const available  = qtyAfter;
    const stockRatio = minStock > 0 ? available / minStock : 999;
    const stockStatus = stockRatio < 0.8 ? 'LOW' : stockRatio > 2 ? 'EXCESS' : 'OK';
    return {
      ...p, skuKey:k, skuLbl:skuLabel(p),
      avgCurrent, avgStock, avgTransit,
      qtyStock, qtyTransit, qtyExisting,
      avgAfter, qtyAfter,
      breakEven, custFin, sellPrice, realProfit, isRisk,
      minStock, available, stockRatio, stockStatus
    };
  });
};

// ‚îÄ‚îÄ DEFAULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const defInventory = [
  {id:1,alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'2400',status:'IN_STOCK',qtyKg:3000,avgCost:90000},
  {id:2,alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'2400',status:'IN_TRANSIT',qtyKg:5000,avgCost:105000},
  {id:3,alloy:'A3003',temper:'H14',thickness:'0.8',width:'1000',length:'Coil',status:'IN_STOCK',qtyKg:2000,avgCost:93000},
  {id:4,alloy:'A3003',temper:'H14',thickness:'0.8',width:'1000',length:'Coil',status:'IN_TRANSIT',qtyKg:4000,avgCost:99000},
  {id:5,alloy:'A1052',temper:'H14',thickness:'1.2',width:'1200',length:'Coil',status:'IN_STOCK',qtyKg:1500,avgCost:88000},
];
const defMinStock = [
  {id:1,alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'2400',minStockKg:5000},
  {id:2,alloy:'A3003',temper:'H14',thickness:'0.8',width:'1000',length:'Coil',minStockKg:4000},
];
const defSP = [
  {id:1,alloy:'A5052 H32',price:109000},
  {id:2,alloy:'A5052 H34',price:110500},
  {id:3,alloy:'A3003 H14',price:101000},
  {id:4,alloy:'A1052 H14',price:97000},
  {id:5,alloy:'A6061 T6', price:115000},
];
const defProducts = [
  {id:1,alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'2400',qtyKg:5000,priceFC:4250},
  {id:2,alloy:'A3003',temper:'H14',thickness:'0.8',width:'1000',length:'Coil',qtyKg:3000,priceFC:4050},
];
const defInputs = {
  supplierName:'Yuwon Steel',creator:'Nguy·ªÖn VƒÉn A',
  paymentMethod:'LC',capitalCostPercent:6.5,
  lcMargin:10,lcDays:90,lcOpenFee:0.2,lcInterest:5.8,
  exchangeRate:26150,managementFee:1.0,
  leadTime:30,holdingTime:60,
  freightTotal:45000000,importTax:0,processingCost:200,
  contractPrice:105000,marketPrice:102000,
  businessRiskPercent:2.0,customerCreditDays:30,lendingRate:12.0,
};

// ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Ic = {
  Plus:    ()=><svg style={{width:13,height:13}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>,
  X:       ()=><svg style={{width:12,height:12}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
  Ship:    ()=><svg style={{width:15,height:15}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
  Chart:   ()=><svg style={{width:15,height:15}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
  Save:    ()=><svg style={{width:15,height:15}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>,
  Tag:     ()=><svg style={{width:15,height:15}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
  Print:   ()=><svg style={{width:15,height:15}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>,
  Refresh: ()=><svg style={{width:13,height:13}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
  Download:()=><svg style={{width:13,height:13}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
  Alert:   ()=><svg style={{width:13,height:13}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
  Database:()=><svg style={{width:13,height:13}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>,
};

// ‚îÄ‚îÄ SKU SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SkuSel = ({row, onChange}) => {
  const S = (f,v) => onChange({...row,[f]:v});
  return (
    <div style={{display:'flex',gap:'3px',alignItems:'center'}}>
      <select className="inp inp-xs" style={{minWidth:70}} value={row.alloy}     onChange={e=>S('alloy',e.target.value)}>{ALLOYS.map(a=><option key={a}>{a}</option>)}</select>
      <select className="inp inp-xs" style={{minWidth:46}} value={row.temper}    onChange={e=>S('temper',e.target.value)}>{TEMPERS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#3a5570',fontSize:'.75rem',flexShrink:0}}>‚Ä¢</span>
      <select className="inp inp-xs" style={{minWidth:44}} value={row.thickness} onChange={e=>S('thickness',e.target.value)}>{THICKS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#3a5570',fontSize:'.75rem',flexShrink:0}}>√ó</span>
      <select className="inp inp-xs" style={{minWidth:52}} value={row.width}     onChange={e=>S('width',e.target.value)}>{WIDTHS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#3a5570',fontSize:'.75rem',flexShrink:0}}>√ó</span>
      <select className="inp inp-xs" style={{minWidth:56}} value={row.length}    onChange={e=>S('length',e.target.value)}>{LENGTHS.map(a=><option key={a}>{a}</option>)}</select>
    </div>
  );
};

// ‚îÄ‚îÄ STOCK STATUS BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const StockBar = ({available, minStock}) => {
  if (!minStock) return <span style={{fontSize:'.65rem',color:'#3a5570'}}>‚Äî</span>;
  const ratio = Math.min(available/minStock, 2.5);
  const pct   = Math.min((ratio/2.5)*100, 100);
  const color = ratio < 0.8 ? '#ef4444' : ratio < 1 ? '#f59e0b' : ratio > 2 ? '#6366f1' : '#22c55e';
  return (
    <div style={{minWidth:80}}>
      <div style={{display:'flex',justifyContent:'space-between',fontSize:'.6rem',color:'#5a7a92',marginBottom:2}}>
        <span className="mono">{fv(available)}kg</span>
        <span style={{color:color,fontWeight:700}}>{Math.round(ratio*100)}%</span>
      </div>
      <div className="stock-bar"><div className="stock-bar-fill" style={{width:`${pct}%`,background:color}}/></div>
      <div style={{fontSize:'.58rem',color:'#3a5570',marginTop:1}}>min {fv(minStock)}kg</div>
    </div>
  );
};

// ‚îÄ‚îÄ EXPORT UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const exportCsv = (blends, inputs) => {
  const rows = [
    ['SKU','Alloy','Temper','Thickness','Width','Length','Qty Kg','Avg Cost After','Break-even','Sell Price','Profit/kg','Min Stock','Stock Status','Warning'],
    ...blends.map(b => [
      b.skuLbl, b.alloy, b.temper, b.thickness, b.width, b.length,
      b.qtyAfter, Math.round(b.avgAfter), Math.round(b.breakEven),
      Math.round(b.sellPrice), Math.round(b.realProfit),
      b.minStock, b.available, b.stockStatus,
      b.isRisk ? 'R·ª¶I RO' : b.stockStatus==='LOW' ? 'THI·∫æU H√ÄNG' : b.stockStatus==='EXCESS' ? 'D∆Ø H√ÄNG' : 'OK'
    ])
  ];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `PAKD_BUY_${new Date().toLocaleDateString('vi-VN').replace(/\//g,'-')}.csv`;
  a.click(); URL.revokeObjectURL(url);
};

// ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const App = () => {
  const [tab, setTab]             = useState('main');
  const [inputs, setInputs]       = useState(defInputs);
  const [products, setProducts]   = useState(defProducts);
  const [inventory, setInvs]      = useState(defInventory);
  const [minStockRows, setMinStockRows] = useState(defMinStock);
  const [sellingPrices, setSP]    = useState(defSP);
  const [scenarios, setScenarios] = useState([]);
  const [dbStatus, setDbStatus]   = useState({loading:false, error:null, lastSync:null, source:'local'});
  const chartRef  = useRef(null);
  const chartInst = useRef(null);

  const setInp = useCallback((f,v)=>setInputs(p=>({...p,[f]:v})),[]);

  // Min stock map by SKU key
  const minStockMap = useMemo(()=>{
    const m = {};
    minStockRows.forEach(r => { m[skuKey(r)] = parseFloat(r.minStockKg)||0; });
    return m;
  },[minStockRows]);

  // ‚îÄ‚îÄ FETCH GOOGLE SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const syncGoogleSheet = async () => {
    setDbStatus(p=>({...p,loading:true,error:null}));
    try {
      const [invData, msData] = await Promise.all([fetchCsv(GSHEET_INVENTORY), fetchCsv(GSHEET_MINSTOCK)]);
      
      // Map inventory rows
      const invRows = invData.map((r,i) => ({
        id: uid()+i,
        alloy: r.alloy||'A5052',
        temper: r.temper||'H32',
        thickness: r.thickness||'1.0',
        width: r.width||'1200',
        length: r.length||'Coil',
        status: (r.status||'IN_STOCK').toUpperCase(),
        qtyKg: parseFloat(r.qtykg||r.qty_kg||r['qty kg']||0),
        avgCost: parseFloat(r.avgcost||r.avg_cost||r['avg cost']||0),
      }));
      
      // Map min stock rows
      const msRows = msData.map((r,i) => ({
        id: uid()+i,
        alloy: r.alloy||'A5052',
        temper: r.temper||'H32',
        thickness: r.thickness||'1.0',
        width: r.width||'1200',
        length: r.length||'Coil',
        minStockKg: parseFloat(r.minstockkg||r.min_stock_kg||r['minstockkg']||r['min stock kg']||0),
      }));

      if (invRows.length > 0) setInvs(invRows);
      if (msRows.length > 0) setMinStockRows(msRows);
      setDbStatus({loading:false,error:null,lastSync:new Date().toLocaleTimeString('vi-VN'),source:'gsheet'});
    } catch(e) {
      setDbStatus(p=>({...p,loading:false,error:e.message||'Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Google Sheet'}));
    }
  };

  // COMPUTE
  const result = useMemo(()=>{
    const totalKg = products.reduce((s,p)=>s+p.qtyKg, 0);
    if (totalKg<=0) return null;
    const inv   = calcInvoice(products, inputs.exchangeRate);
    const land  = calcLanded(inv.invoiceVND, totalKg, inputs);
    const fin   = calcFinance(inv.invoiceVND, land, totalKg, inputs);
    const rows  = calcProductBreakdown(products, land, fin, totalKg, inputs);
    const blends= calcSkuBlend(inventory, rows, sellingPrices, inputs.contractPrice, inputs, minStockMap);
    const allInvRows   = inventory.map(r=>({qtyKg:parseFloat(r.qtyKg)||0,avgCost:parseFloat(r.avgCost)||0}));
    const newPurchRows = rows.map(r=>({qtyKg:r.qtyKg,avgCost:r.physPerKg}));
    const globalAvgBefore = weightedAvg(allInvRows);
    const globalAvgAfter  = weightedAvg([...allInvRows,...newPurchRows]);
    const custFin         = globalAvgAfter*(inputs.lendingRate/100)*(inputs.customerCreditDays/365);
    const globalBreakEven = globalAvgAfter + fin.finPerKg + custFin;
    const hasRisk = blends.some(b=>b.isRisk);
    const hasLowStock = blends.some(b=>b.stockStatus==='LOW');
    const totalContainer = totalKg / 1000;
    const containerOk = totalContainer >= 24.5 && totalContainer <= 26.5;
    const rec = !hasRisk ? {txt:'NH·∫¨P B·∫¢O TO√ÄN',cls:'tg'}
              :  hasRisk ? {txt:'C√ì SKU R·ª¶I RO', cls:'tr'}
              : {txt:'NH·∫¨P C√ÇN B·∫∞NG',cls:'tb'};
    return {totalKg, ...inv, ...land, ...fin, rows, blends,
            globalAvgBefore, globalAvgAfter, globalBreakEven, custFin,
            hasRisk, hasLowStock, rec, totalContainer, containerOk};
  },[inputs, products, inventory, sellingPrices, minStockMap]);

  // CHART
  useEffect(()=>{
    if (!result || !chartRef.current) return;
    if (chartInst.current) chartInst.current.destroy();
    const labels = result.blends.map(b=>`${b.alloy} ${b.temper} ${b.thickness}mm`);
    chartInst.current = new Chart(chartRef.current.getContext('2d'),{
      type:'bar',
      data:{labels,datasets:[
        {label:'BQ Hi·ªán t·∫°i',  data:result.blends.map(b=>b.avgCurrent), backgroundColor:'#1e3a5f',borderRadius:3},
        {label:'L√¥ m·ªõi',       data:result.blends.map(b=>b.physPerKg),  backgroundColor:'#14532d',borderRadius:3},
        {label:'BQ Sau nh·∫≠p',  data:result.blends.map(b=>b.avgAfter),   backgroundColor:'#1d4ed8',borderRadius:3},
        {label:'Break-even',   data:result.blends.map(b=>b.breakEven),  backgroundColor:'#5b21b6',borderRadius:3},
        {label:'Gi√° b√°n Hƒê',   data:result.blends.map(b=>b.sellPrice),  backgroundColor:'#166534',borderRadius:3},
      ]},
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'bottom',labels:{color:'#7ba3be',font:{size:10},padding:8,usePointStyle:true}},
          tooltip:{callbacks:{label:c=>c.dataset.label+': '+fv(c.parsed.y)+' ƒë/kg'}}
        },
        scales:{
          x:{grid:{color:'#1a2a3a'},ticks:{color:'#5a7a92',font:{size:9}}},
          y:{grid:{color:'#1a2a3a'},beginAtZero:false,
             min:result.blends.length?Math.min(...result.blends.flatMap(b=>[b.avgCurrent||0,b.physPerKg||0]))*0.97:0,
             ticks:{color:'#5a7a92',font:{size:9},callback:v=>fv(v)}}
        }
      }
    });
  },[result]);

  // CRUD products
  const addProduct = () => setProducts(p=>[...p,{id:uid(),alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'Coil',qtyKg:1000,priceFC:4000}]);
  const delProduct = id => { if(products.length>1) setProducts(p=>p.filter(r=>r.id!==id)); };
  const setProduct = (id,patch) => setProducts(p=>p.map(r=>r.id===id?{...r,...patch}:r));
  // CRUD inventory
  const addInv  = () => setInvs(p=>[...p,{id:uid(),alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'Coil',status:'IN_STOCK',qtyKg:0,avgCost:0}]);
  const delInv  = id => setInvs(p=>p.filter(r=>r.id!==id));
  const setInv  = (id,patch) => setInvs(p=>p.map(r=>r.id===id?{...r,...patch}:r));
  // CRUD min stock
  const addMS   = () => setMinStockRows(p=>[...p,{id:uid(),alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'Coil',minStockKg:0}]);
  const delMS   = id => setMinStockRows(p=>p.filter(r=>r.id!==id));
  const setMS   = (id,patch) => setMinStockRows(p=>p.map(r=>r.id===id?{...r,...patch}:r));
  // CRUD SP
  const addSP   = () => setSP(p=>[...p,{id:uid(),alloy:'A5052 H32',price:0}]);
  const delSP   = id => setSP(p=>p.filter(r=>r.id!==id));
  const setSpR  = (id,f,v) => setSP(p=>p.map(r=>r.id===id?{...r,[f]:v}:r));

  const saveScenario = () => {
    if (!result) return;
    setScenarios(p=>[...p,{
      id:uid(),
      name:`${new Date().toLocaleDateString('vi-VN')} ¬∑ ${products.map(p=>p.alloy+' '+p.temper).join('+')}`,
      date:new Date().toLocaleDateString('vi-VN'),
      totalKg:result.totalKg, invoiceUSD:result.invoiceUSD,
      globalAvgBefore:result.globalAvgBefore, globalAvgAfter:result.globalAvgAfter,
      globalBreakEven:result.globalBreakEven, hasRisk:result.hasRisk,
      blendCount:result.blends.length, containerTons:result.totalContainer,
      inputs:{...inputs}, products:[...products]
    }]);
  };

  const bg1='#0e1520', bg2='#131e2e', bg3='#0c1726', bg4='#0a1220';
  const border1='#1e3347', border2='#2a3f58';

  return (
    <div style={{height:'100vh',display:'flex',flexDirection:'column',overflow:'hidden'}}>

      {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
      <div style={{background:bg2,borderBottom:`1px solid ${border1}`,padding:'8px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
        <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
          <div style={{background:'linear-gradient(135deg,#1d4ed8,#6d28d9)',borderRadius:'7px',width:'30px',height:'30px',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:900,fontSize:'15px',color:'#fff',fontFamily:'JetBrains Mono'}}>P</div>
          <div>
            <div style={{fontWeight:900,fontSize:'15px',letterSpacing:'-.02em',color:'#dce6f4'}}>PAKD BUY <span style={{color:'#60a5fa',fontFamily:'JetBrains Mono',fontSize:'12px'}}>4.0</span></div>
            <div style={{fontSize:'11px',color:'#5a7a92',fontWeight:700,textTransform:'uppercase',letterSpacing:'.06em'}}>SKU ¬∑ GSheet DB ¬∑ MinStock ¬∑ Container Check ¬∑ Export</div>
          </div>
          <div style={{width:'1px',height:'24px',background:border1,margin:'0 4px'}}/>
          {[{k:'main',l:'üìä Ph√¢n t√≠ch'},{k:'inventory',l:'üì¶ T·ªìn kho'},{k:'minstock',l:'üìè Min Stock'},{k:'selling',l:'üè∑Ô∏è Gi√° b√°n'},{k:'scenario',l:'üíæ Scenarios'}]
            .map(t=><button key={t.k} onClick={()=>setTab(t.k)} className={`nav-tab ${tab===t.k?'on':''}`}>{t.l}</button>)}
        </div>
        <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
          {/* DB Sync indicator */}
          <div style={{display:'flex',alignItems:'center',gap:6,background:bg4,border:`1px solid ${border1}`,borderRadius:5,padding:'3px 9px',fontSize:'.68rem'}}>
            <Ic.Database/>
            {dbStatus.loading ? (
              <span style={{color:'#60a5fa',display:'flex',alignItems:'center',gap:4}}><div className="spinner" style={{width:12,height:12}}/> ƒêang t·∫£i...</span>
            ) : dbStatus.error ? (
              <span style={{color:'#fc8181'}} title={dbStatus.error}>‚ö† GSheet l·ªói</span>
            ) : dbStatus.lastSync ? (
              <span style={{color:'#4ade80'}}>‚úì {dbStatus.lastSync}</span>
            ) : (
              <span style={{color:'#5a7a92'}}>Local data</span>
            )}
            <button onClick={syncGoogleSheet} disabled={dbStatus.loading} className="btn btn-ghost" style={{padding:'1px 6px',fontSize:'.65rem',gap:3,marginLeft:2,opacity:dbStatus.loading?.5:1}}>
              <Ic.Refresh/> Sync
            </button>
          </div>
          {result && <span className={`tag ${result.rec.cls}`}>{result.rec.txt}</span>}
          {result && (
            <span className={`tag ${result.containerOk?'tg':result.totalContainer<24?'tr':'ty'}`}>
              üì¶ {result.totalContainer.toFixed(1)}T
            </span>
          )}
          {result && result.hasLowStock && <span className="tag tr pulse"><Ic.Alert/> Thi·∫øu h√†ng</span>}
          <button className="btn btn-export btn-sm" onClick={()=>result&&exportCsv(result.blends,inputs)} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Download/> CSV</button>
          <button className="btn btn-success btn-sm" onClick={saveScenario} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Save/> L∆∞u</button>
          <button className="btn btn-solid btn-sm" onClick={()=>window.print()} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Print/> In A4</button>
        </div>
      </div>

      {/* ‚îÄ‚îÄ BODY ‚îÄ‚îÄ */}
      <div style={{flex:1,display:'flex',minHeight:0,overflow:'hidden'}}>

        {/* ‚ïê‚ïê‚ïê‚ïê TAB MAIN ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='main' && (
          <div style={{display:'flex',width:'100%',height:'100%',minHeight:0}}>

            {/* LEFT CONFIG */}
            <div style={{width:'248px',flexShrink:0,background:bg2,borderRight:`1px solid ${border1}`,overflowY:'auto',padding:'10px',display:'flex',flexDirection:'column',gap:'9px'}}>
              <div className="card">
                <div className="sh"><Ic.Ship/>Th√¥ng s·ªë nh·∫≠p kh·∫©u</div>
                <label className="lbl" style={{color:'#60a5fa'}}>T·ª∑ gi√° USD/VND</label>
                <input className="inp mono" style={{fontSize:'1.05rem',fontWeight:800,color:'#60a5fa',textAlign:'right',marginBottom:9}} value={fv(inputs.exchangeRate)} onChange={e=>setInp('exchangeRate',pn(e.target.value))} />
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px',marginBottom:7}}>
                  <div><label className="lbl" style={{color:'#d8b4fe'}}>H·ªá s·ªë QL %</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#d8b4fe'}} value={inputs.managementFee} onChange={e=>setInp('managementFee',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl">Thu·∫ø NK %</label><input type="number" className="inp inp-xs" value={inputs.importTax} onChange={e=>setInp('importTax',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl">C∆∞·ªõc VND t·ªïng</label><input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(inputs.freightTotal)} onChange={e=>setInp('freightTotal',pn(e.target.value))}/></div>
                  <div><label className="lbl">Gia c√¥ng ƒë/kg</label><input type="number" className="inp inp-xs" value={inputs.processingCost} onChange={e=>setInp('processingCost',pn(e.target.value))}/></div>
                  <div><label className="lbl">Lead time ng√†y</label><input type="number" className="inp inp-xs" value={inputs.leadTime} onChange={e=>setInp('leadTime',parseInt(e.target.value)||0)}/></div>
                  <div><label className="lbl">Hold time ng√†y</label><input type="number" className="inp inp-xs" value={inputs.holdingTime} onChange={e=>setInp('holdingTime',parseInt(e.target.value)||0)}/></div>
                </div>
                <div style={{display:'flex',gap:'5px',marginBottom:6}}>
                  {['TT','LC'].map(m=>(
                    <button key={m} className={`status-btn ${inputs.paymentMethod===m?(m==='TT'?'s-stock':'s-transit'):'off'}`} onClick={()=>setInp('paymentMethod',m)}>
                      {m==='TT'?'T/T':'L/C'}
                    </button>
                  ))}
                </div>
                {inputs.paymentMethod==='LC' ? (
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px',background:bg4,padding:'7px',borderRadius:'4px',border:`1px solid ${border1}`}}>
                    <div><label className="lbl">Margin%</label><input type="number" className="inp inp-xs" value={inputs.lcMargin} onChange={e=>setInp('lcMargin',parseFloat(e.target.value)||0)}/></div>
                    <div><label className="lbl">Days</label><input type="number" className="inp inp-xs" value={inputs.lcDays} onChange={e=>setInp('lcDays',parseInt(e.target.value)||0)}/></div>
                    <div><label className="lbl">Int%</label><input type="number" step=".1" className="inp inp-xs" value={inputs.lcInterest} onChange={e=>setInp('lcInterest',parseFloat(e.target.value)||0)}/></div>
                  </div>
                ) : (
                  <div><label className="lbl">L√£i su·∫•t v·ªën %/nƒÉm</label><input type="number" step=".1" className="inp inp-xs" value={inputs.capitalCostPercent} onChange={e=>setInp('capitalCostPercent',parseFloat(e.target.value)||0)}/></div>
                )}
              </div>

              <div className="card">
                <div className="sh"><Ic.Tag/>Tham chi·∫øu b√°n</div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px',marginBottom:7}}>
                  <div><label className="lbl" style={{color:'#4ade80'}}>Gi√° Hƒê/KH ƒë/kg</label><input className="inp inp-xs mono" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(inputs.contractPrice)} onChange={e=>setInp('contractPrice',pn(e.target.value))}/></div>
                  <div><label className="lbl">TT Spot ƒë/kg</label><input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(inputs.marketPrice)} onChange={e=>setInp('marketPrice',pn(e.target.value))}/></div>
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px'}}>
                  <div><label className="lbl" style={{color:'#fc8181'}}>R·ªßi ro KD%</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#fc8181'}} value={inputs.businessRiskPercent} onChange={e=>setInp('businessRiskPercent',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl" style={{color:'#d8b4fe'}}>C√¥ng n·ª£ ng√†y</label><input type="number" className="inp inp-xs" style={{color:'#d8b4fe'}} value={inputs.customerCreditDays} onChange={e=>setInp('customerCreditDays',parseInt(e.target.value)||0)}/></div>
                  <div><label className="lbl" style={{color:'#fcd34d'}}>L√£i vay%/nƒÉm</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#fcd34d'}} value={inputs.lendingRate} onChange={e=>setInp('lendingRate',parseFloat(e.target.value)||0)}/></div>
                </div>
              </div>

              {/* Container status */}
              {result && (
                <div style={{background:bg4,border:`1px solid ${result.containerOk?'#166534':result.totalContainer<24?'#991b1b':'#854d0e'}`,borderRadius:6,padding:'9px 11px'}}>
                  <div style={{fontSize:'.65rem',color:'#5a7a92',fontWeight:700,textTransform:'uppercase',letterSpacing:'.06em',marginBottom:5}}>Container 25‚Äì26T</div>
                  <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                    <div className="mono" style={{fontSize:'1.4rem',fontWeight:900,color:result.containerOk?'#4ade80':result.totalContainer<24?'#fc8181':'#fcd34d'}}>{result.totalContainer.toFixed(2)}<span style={{fontSize:'.65rem',color:'#5a7a92',marginLeft:3}}>t·∫•n</span></div>
                    <span className={`tag ${result.containerOk?'tg':result.totalContainer<24?'tr':'ty'}`}>
                      {result.containerOk?'‚úì ƒê·ª¶ T·∫¢I':result.totalContainer<24?'THI·∫æU T·∫¢I':'D∆Ø T·∫¢I'}
                    </span>
                  </div>
                  <div style={{marginTop:6}}>
                    <div className="stock-bar" style={{height:7}}>
                      <div className="stock-bar-fill" style={{
                        width:`${Math.min((result.totalContainer/26.5)*100,100)}%`,
                        background:result.containerOk?'#22c55e':result.totalContainer<24?'#ef4444':'#f59e0b'
                      }}/>
                    </div>
                    <div style={{display:'flex',justifyContent:'space-between',fontSize:'.58rem',color:'#3a5570',marginTop:2}}>
                      <span>24.5T</span><span>26.5T</span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* CENTER */}
            <div style={{flex:1,minWidth:0,display:'flex',flexDirection:'column',background:bg1,borderRight:`1px solid ${border1}`}}>

              <div style={{padding:'9px 13px',borderBottom:`1px solid ${border1}`,display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
                <div style={{display:'flex',alignItems:'center',gap:'9px'}}>
                  <Ic.Ship/>
                  <span style={{fontWeight:800,fontSize:'.88rem',color:'#dce6f4'}}>L√¥ h√†ng d·ª± ƒë·ªãnh mua</span>
                  <span className="tag tb">{products.length} SKU</span>
                  {result && <span className="tag ts mono">{fv(result.totalKg)} kg</span>}
                  {result && <span className="tag ty mono">{fu(result.invoiceUSD)}</span>}
                </div>
                <button className="btn btn-ghost btn-sm" onClick={addProduct} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m SKU</button>
              </div>

              <div style={{overflowY:'auto',maxHeight:'28%',padding:'7px 13px'}}>
                <table className="tbl">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th style={{textAlign:'left',paddingLeft:5}}>SKU: Alloy ¬∑ Temper ¬∑ D√†y √ó R·ªông √ó D√†i</th>
                      <th>KL kg</th><th>USD/T·∫•n</th><th>Invoice</th><th>V·ªÅ kho ƒë/kg</th><th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {products.map((p,i)=>{
                      const rb = result?.rows?.find(r=>r.id===p.id);
                      return (
                        <tr key={p.id}>
                          <td style={{textAlign:'center',color:'#4a7090',fontSize:'.75rem'}} className="mono">{i+1}</td>
                          <td style={{paddingLeft:5}}><SkuSel row={p} onChange={patch=>setProduct(p.id,patch)}/></td>
                          <td style={{width:90}}>
                            <input className="inp inp-xs mono" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(p.qtyKg)} onChange={e=>setProduct(p.id,{qtyKg:pn(e.target.value)})}/>
                          </td>
                          <td style={{width:80}}>
                            <input type="number" className="inp inp-xs mono" style={{textAlign:'right',color:'#fcd34d'}} value={p.priceFC} onChange={e=>setProduct(p.id,{priceFC:parseFloat(e.target.value)||0})}/>
                          </td>
                          <td className="mono" style={{textAlign:'right',paddingRight:7,color:'#5a7a92',fontSize:'.78rem'}}>{fu((p.qtyKg/1000)*p.priceFC)}</td>
                          <td style={{textAlign:'right',paddingRight:7}}>
                            {rb ? <span className="mono" style={{fontSize:'.82rem',fontWeight:700,color:rb.physPerKg>(result?.globalAvgBefore||0)?'#fc8181':'#4ade80'}}>{fv(rb.physPerKg)}</span>
                                : <span style={{color:'#3a5570'}}>‚Äî</span>}
                          </td>
                          <td><button className="btn-danger" onClick={()=>delProduct(p.id)}><Ic.X/></button></td>
                        </tr>
                      );
                    })}
                  </tbody>
                  {result && (
                    <tfoot>
                      <tr>
                        <td colSpan={2} style={{textAlign:'right',color:'#5a7a92',fontSize:'.7rem',paddingRight:9}}>T·ªîNG / BQ</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:7,color:'#4ade80'}}>{fv(result.totalKg)}</td>
                        <td/>
                        <td className="mono" style={{textAlign:'right',paddingRight:7,color:'#fcd34d'}}>{fu(result.invoiceUSD)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:7,color:'#93c5fd'}}>{fv(result.landedPerKg)} avg</td>
                        <td/>
                      </tr>
                    </tfoot>
                  )}
                </table>
              </div>

              <div className="div-line" style={{margin:'0 13px'}}/>

              {/* SKU header */}
              <div style={{padding:'6px 13px 5px',flexShrink:0,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                <div style={{display:'flex',alignItems:'center',gap:'9px'}}>
                  <Ic.Chart/>
                  <span style={{fontWeight:800,fontSize:'.86rem',color:'#dce6f4'}}>Ph√¢n t√≠ch SKU ¬∑ Kho + ƒê∆∞·ªùng + L√¥ m·ªõi + MinStock</span>
                  <span style={{fontSize:'.7rem',color:'#4a7090'}}>‚Ü≥ Break-even t·ª´ BQ sau nh·∫≠p</span>
                </div>
                <div style={{display:'flex',gap:'9px',fontSize:'.68rem',color:'#5a7a92'}}>
                  <span><span className="tag tg" style={{fontSize:'.64rem'}}>IN_STOCK</span></span>
                  <span><span className="tag ty" style={{fontSize:'.64rem'}}>IN_TRANSIT</span></span>
                  <span><span className="tag to" style={{fontSize:'.64rem'}}>THI·∫æU H√ÄNG</span></span>
                </div>
              </div>

              {/* SKU Cards */}
              <div style={{flex:1,overflowY:'auto',padding:'5px 13px 11px'}}>
                {result?.blends?.length > 0 ? (
                  <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(350px,1fr))',gap:'9px'}}>
                    {result.blends.map((b,i)=>(
                      <div key={b.skuKey+i} className={`sku-card ${b.isRisk?'warn':b.stockStatus==='LOW'?'alert-low':b.realProfit>1000?'ok':''}`}>

                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:9}}>
                          <div>
                            <div style={{fontWeight:800,fontSize:'.88rem',color:'#dce6f4'}}>{b.alloy} {b.temper}</div>
                            <div style={{fontSize:'.72rem',color:'#5a7a92',marginTop:2,fontFamily:'JetBrains Mono'}}>{b.thickness}mm √ó {b.width} √ó {b.length}</div>
                          </div>
                          <div style={{display:'flex',gap:4,flexDirection:'column',alignItems:'flex-end'}}>
                            <span className={`tag ${b.isRisk?'tr':b.realProfit>0?'tg':'ty'}`}>
                              {b.isRisk ? '‚ö† R·ª¶I RO' : b.realProfit>0 ? '‚úì C√ì L√ÉI' : '‚âà H√íA V·ªêN'}
                            </span>
                            {b.stockStatus==='LOW' && <span className="tag to pulse"><Ic.Alert/> THI·∫æU H√ÄNG</span>}
                            {b.stockStatus==='EXCESS' && <span className="tag tp">D∆Ø H√ÄNG</span>}
                          </div>
                        </div>

                        {/* 3 pools */}
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'5px',marginBottom:9}}>
                          {[
                            {ico:'üü¢',lbl:'Trong kho',qty:b.qtyStock,  avg:b.avgStock,  bg:'#051809',br:'#166534',vc:'#4ade80',ac:'#22c55e'},
                            {ico:'üü°',lbl:'ƒêang v·ªÅ',  qty:b.qtyTransit,avg:b.avgTransit,bg:'#1c1400',br:'#854d0e',vc:'#fcd34d',ac:'#f59e0b'},
                            {ico:'üîµ',lbl:'L√¥ m·ªõi',   qty:b.qtyKg,     avg:b.physPerKg, bg:'#04102e',br:'#1d4ed8',vc:'#93c5fd',ac:'#60a5fa'},
                          ].map((x,j)=>(
                            <div key={j} style={{background:x.bg,border:`1px solid ${x.br}`,borderRadius:5,padding:'6px 8px'}}>
                              <div style={{fontSize:'.65rem',color:x.vc,fontWeight:700,marginBottom:3,opacity:.85}}>{x.ico} {x.lbl}</div>
                              <div className="mono" style={{fontSize:'.88rem',fontWeight:700,color:x.vc}}>{fv(x.qty)}<span style={{fontSize:'.62rem',opacity:.7}}> kg</span></div>
                              <div className="mono" style={{fontSize:'.72rem',color:x.ac,marginTop:1}}>{fv(x.avg)} ƒë/kg</div>
                            </div>
                          ))}
                        </div>

                        {/* Min Stock bar */}
                        {b.minStock > 0 && (
                          <div style={{background:bg4,border:`1px solid ${b.stockStatus==='LOW'?'#c2410c':b.stockStatus==='EXCESS'?'#6d28d9':border1}`,borderRadius:4,padding:'6px 8px',marginBottom:8}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                              <span style={{fontSize:'.63rem',color:'#5a7a92',fontWeight:700}}>üìè MIN STOCK AUDIT</span>
                              <span className={`tag ${b.stockStatus==='LOW'?'to':b.stockStatus==='EXCESS'?'tp':'tg'}`} style={{fontSize:'.62rem'}}>
                                {b.stockStatus==='LOW'?'‚ö† D∆Ø·ªöI MIN':b.stockStatus==='EXCESS'?'‚ñ≤ D∆Ø NHI·ªÄU':'‚úì ƒê·∫†T MIN'}
                              </span>
                            </div>
                            <StockBar available={b.available} minStock={b.minStock}/>
                          </div>
                        )}

                        {/* BQ flow */}
                        <div style={{display:'flex',alignItems:'stretch',gap:4,marginBottom:9,background:bg4,borderRadius:5,padding:'7px 9px'}}>
                          {[
                            {l:'BQ Hi·ªán t·∫°i',v:b.avgCurrent,q:b.qtyExisting,c:'#94a3b8'},
                            null,
                            {l:'BQ Sau nh·∫≠p',v:b.avgAfter,  q:b.qtyAfter,   c:b.avgAfter>b.avgCurrent?'#fc8181':'#93c5fd',bold:true},
                            null,
                            {l:'Break-even', v:b.breakEven, q:null,          c:'#d8b4fe'},
                          ].map((x,j)=> x===null ? (
                            <div key={j} style={{color:'#3a5570',fontSize:'1rem',alignSelf:'center',paddingTop:9}}>‚Üí</div>
                          ) : (
                            <div key={j} style={{flex:1,textAlign:'center'}}>
                              <div style={{fontSize:'.64rem',color:'#5a7a92',marginBottom:3}}>{x.l}</div>
                              <div className="mono" style={{fontSize:x.bold?'.95rem':'.84rem',fontWeight:x.bold?900:700,color:x.c}}>{fv(x.v)}</div>
                              {x.q!==null && <div style={{fontSize:'.63rem',color:'#3a5570',marginTop:2}}>{fv(x.q)} kg</div>}
                            </div>
                          ))}
                        </div>

                        {/* P&L */}
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-end'}}>
                          <div>
                            <div style={{fontSize:'.67rem',color:'#5a7a92'}}>Gi√° b√°n theo m√£</div>
                            <div className="mono" style={{fontSize:'.86rem',fontWeight:700,color:'#4ade80'}}>{fv(b.sellPrice)} ƒë/kg</div>
                          </div>
                          <div style={{textAlign:'right'}}>
                            <div style={{fontSize:'.67rem',color:'#5a7a92'}}>L√£i / L·ªó th·ª±c</div>
                            <div className="mono" style={{fontSize:'1rem',fontWeight:900,color:b.realProfit>=0?'#4ade80':'#fc8181'}}>
                              {b.realProfit>=0?'+':''}{fv(b.realProfit)} ƒë/kg
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{textAlign:'center',padding:'40px',color:'#4a7090',fontSize:'.85rem'}}>Nh·∫≠p d·ªØ li·ªáu l√¥ h√†ng ƒë·ªÉ xem ph√¢n t√≠ch SKU</div>
                )}
              </div>

              {/* Cost breakdown */}
              {result && (
                <div style={{padding:'6px 13px 9px',borderTop:`1px solid ${border1}`,flexShrink:0}}>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:'5px'}}>
                    {[
                      {l:'Invoice',      v:result.invoiceVND, c:'#5a7a92'},
                      {l:`QL ${inputs.managementFee}%`,v:result.mgmt,c:'#a78bfa'},
                      {l:'Thu·∫ø NK',      v:result.tax,        c:'#f59e0b'},
                      {l:'C∆∞·ªõc+Logs',    v:result.freight,    c:'#38bdf8'},
                      {l:'Gia c√¥ng',     v:result.proc,       c:'#2dd4bf'},
                      {l:'CP t√†i ch√≠nh', v:result.finVND,     c:'#f87171'},
                    ].map((x,i)=>(
                      <div key={i} style={{background:bg3,border:`1px solid ${border1}`,borderRadius:4,padding:'5px 7px',textAlign:'center'}}>
                        <div className="mono" style={{fontSize:'.76rem',fontWeight:700,color:x.c}}>{fv(x.v)}</div>
                        <div style={{fontSize:'.63rem',color:'#4a7090',marginTop:2}}>{x.l}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* RIGHT KPI */}
            <div style={{width:'234px',flexShrink:0,background:bg2,overflowY:'auto',padding:'10px',display:'flex',flexDirection:'column',gap:'9px'}}>
              {result ? (
                <>
                  <div className="kpi">
                    <div className="kpi-l">BQ To√†n kho Hi·ªán t·∫°i</div>
                    <div className="kpi-v" style={{color:'#94a3b8',fontSize:'1rem'}}>{fv(result.globalAvgBefore)}</div>
                    <div className="kpi-s">ƒë/kg ¬∑ {fv(inventory.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0))} kg</div>
                  </div>
                  <div className="kpi" style={{background:'#060f28',borderColor:'#1d4ed8'}}>
                    <div className="kpi-l" style={{color:'#60a5fa'}}>BQ Sau Nh·∫≠p (to√†n kho)</div>
                    <div className="kpi-v" style={{color:'#93c5fd'}}>{fv(result.globalAvgAfter)}</div>
                    <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                      <span className="kpi-s">ƒë/kg</span>
                      <span className={`tag ${result.globalAvgAfter>result.globalAvgBefore?'tr':'tg'} mono`} style={{fontSize:'.66rem'}}>
                        {result.globalAvgAfter>result.globalAvgBefore?'‚ñ≤':'‚ñº'} {fv(Math.abs(result.globalAvgAfter-result.globalAvgBefore))}
                      </span>
                    </div>
                  </div>
                  <div className="kpi" style={{background:'#0d0428',borderColor:'#6d28d9'}}>
                    <div className="kpi-l" style={{color:'#9333ea'}}>Break-even To√†n kho</div>
                    <div className="kpi-v" style={{color:'#d8b4fe',fontSize:'1.05rem'}}>{fv(result.globalBreakEven)}</div>
                    <div className="kpi-s">ƒë/kg ¬∑ gi√° b√°n t·ªëi thi·ªÉu</div>
                  </div>

                  {/* Stock Alerts summary */}
                  {result.blends.some(b=>b.minStock>0) && (
                    <div className="card-inset" style={{padding:'9px',border:`1px solid ${result.hasLowStock?'#c2410c':border1}`}}>
                      <div style={{fontSize:'.68rem',fontWeight:700,color:result.hasLowStock?'#fb923c':'#5a7a92',textTransform:'uppercase',marginBottom:6,display:'flex',alignItems:'center',gap:4}}>
                        <Ic.Alert/> MinStock Status
                      </div>
                      {result.blends.filter(b=>b.minStock>0).map((b,i)=>(
                        <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:5,padding:'4px 6px',background:bg1,borderRadius:4,border:`1px solid ${b.stockStatus==='LOW'?'#c2410c':b.stockStatus==='EXCESS'?'#6d28d9':border1}`}}>
                          <div>
                            <div style={{fontSize:'.72rem',fontWeight:700,color:'#dce6f4'}}>{b.alloy} {b.temper} {b.thickness}mm</div>
                            <div style={{fontSize:'.6rem',color:'#5a7a92'}}>{fv(b.available)}/{fv(b.minStock)} kg</div>
                          </div>
                          <span className={`tag ${b.stockStatus==='LOW'?'to':b.stockStatus==='EXCESS'?'tp':'tg'}`} style={{fontSize:'.6rem'}}>
                            {b.stockStatus==='LOW'?'THI·∫æU':b.stockStatus==='EXCESS'?'D∆Ø':'OK'}
                          </span>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* SKU risk mini */}
                  <div className="card-inset" style={{padding:'9px'}}>
                    <div style={{fontSize:'.68rem',fontWeight:700,color:'#5a7a92',textTransform:'uppercase',marginBottom:6}}>P&L per SKU</div>
                    {result.blends.map((b,i)=>(
                      <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:5,padding:'4px 6px',background:bg1,borderRadius:4,border:`1px solid ${b.isRisk?'#991b1b':border1}`}}>
                        <div style={{fontSize:'.72rem',fontWeight:700,color:'#dce6f4'}}>{b.alloy} {b.temper} {b.thickness}mm</div>
                        <span className="mono" style={{fontSize:'.7rem',color:b.realProfit>=0?'#4ade80':'#fc8181',fontWeight:700}}>
                          {b.realProfit>=0?'+':''}{fv(b.realProfit)}
                        </span>
                      </div>
                    ))}
                  </div>

                  <div className="chart-box" style={{height:185}}>
                    <div style={{fontSize:'.66rem',color:'#5a7a92',fontWeight:700,textTransform:'uppercase',marginBottom:4}}>Gi√° v·ªën theo SKU</div>
                    <canvas ref={chartRef} style={{height:155}}></canvas>
                  </div>

                  <div style={{display:'flex',flexDirection:'column',gap:5}}>
                    {[
                      {l:'vs H·ª£p ƒë·ªìng',ref:inputs.contractPrice,ok:result.globalBreakEven<=inputs.contractPrice,y:'B√ÅN ƒê∆Ø·ª¢C',n:'KH√îNG L√ÉI'},
                      {l:'vs TT Spot',  ref:inputs.marketPrice,  ok:result.globalBreakEven<=inputs.marketPrice,  y:'C·∫†NH TRANH',n:'CAO H∆†N TT'},
                    ].map((d,i)=>(
                      <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',background:bg4,border:`1px solid ${border1}`,borderRadius:5,padding:'6px 9px'}}>
                        <div>
                          <div style={{fontSize:'.66rem',color:'#5a7a92'}}>{d.l}</div>
                          <div className="mono" style={{fontSize:'.85rem',fontWeight:700,color:'#dce6f4'}}>{fv(d.ref)}</div>
                        </div>
                        <span className={`tag ${d.ok?'tg':'tr'}`}>{d.ok?d.y:d.n}</span>
                      </div>
                    ))}
                  </div>

                  <div style={{textAlign:'center',padding:'9px',borderRadius:7,border:`1px solid ${result.rec.cls==='tg'?'#166534':result.rec.cls==='tb'?'#1d4ed8':'#991b1b'}`,background:result.rec.cls==='tg'?'#020d05':result.rec.cls==='tb'?'#030a1c':'#0c0202'}}>
                    <div style={{fontSize:'.66rem',color:'#4a7090',marginBottom:3}}>KHUY·∫æN NGH·ªä</div>
                    <div style={{fontSize:'1rem',fontWeight:900,color:result.rec.cls==='tg'?'#4ade80':result.rec.cls==='tb'?'#93c5fd':'#fc8181'}}>{result.rec.txt}</div>
                  </div>
                </>
              ) : (
                <div style={{textAlign:'center',padding:'40px',color:'#4a7090',fontSize:'.82rem'}}>Nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem KPI</div>
              )}
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB INVENTORY ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='inventory' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto',background:bg1}}>
            <div style={{maxWidth:'1100px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:15}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1.05rem',color:'#dce6f4'}}>üì¶ T·ªìn kho chi ti·∫øt theo SKU</h2>
                  <p style={{fontSize:'.78rem',color:'#5a7a92',marginTop:3}}>
                    Ngu·ªìn: <span style={{color:dbStatus.source==='gsheet'?'#4ade80':'#5a7a92'}}>{dbStatus.source==='gsheet'?'Google Sheet (ƒë·ªìng b·ªô)':'Local data'}</span>
                    {dbStatus.lastSync && <span style={{color:'#3a5570',marginLeft:6}}>C·∫≠p nh·∫≠t: {dbStatus.lastSync}</span>}
                  </p>
                </div>
                <div style={{display:'flex',gap:8}}>
                  <button className="btn btn-ghost btn-sm" onClick={syncGoogleSheet} disabled={dbStatus.loading} style={{display:'flex',alignItems:'center',gap:4}}>
                    {dbStatus.loading?<div className="spinner"/>:<Ic.Refresh/>} Sync GSheet
                  </button>
                  <button className="btn btn-ghost btn-sm" onClick={addInv} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m d√≤ng</button>
                </div>
              </div>
              {dbStatus.error && (
                <div style={{background:'#1c0505',border:'1px solid #991b1b',borderRadius:6,padding:'9px 13px',marginBottom:13,fontSize:'.78rem',color:'#fc8181',display:'flex',alignItems:'center',gap:8}}>
                  <Ic.Alert/> L·ªói k·∫øt n·ªëi Google Sheet: {dbStatus.error}. ƒêang d√πng d·ªØ li·ªáu local.
                </div>
              )}

              <table className="tbl" style={{background:bg3,borderRadius:8,overflow:'hidden'}}>
                <thead>
                  <tr><th>#</th><th style={{textAlign:'left',paddingLeft:5}}>SKU</th><th>Tr·∫°ng th√°i</th><th>S·ªë l∆∞·ª£ng kg</th><th>Gi√° v·ªën ƒë/kg</th><th>T·ªïng VND</th><th></th></tr>
                </thead>
                <tbody>
                  {inventory.map((r,i)=>(
                    <tr key={r.id}>
                      <td style={{textAlign:'center',color:'#4a7090',fontSize:'.75rem'}} className="mono">{i+1}</td>
                      <td style={{paddingLeft:5}}><SkuSel row={r} onChange={patch=>setInv(r.id,patch)}/></td>
                      <td style={{textAlign:'center',width:165}}>
                        <div style={{display:'flex',gap:4,justifyContent:'center'}}>
                          <button className={`status-btn ${r.status==='IN_STOCK'?'s-stock':'off'}`} style={{padding:'3px 7px'}} onClick={()=>setInv(r.id,{status:'IN_STOCK'})}>üü¢ Kho</button>
                          <button className={`status-btn ${r.status==='IN_TRANSIT'?'s-transit':'off'}`} style={{padding:'3px 7px'}} onClick={()=>setInv(r.id,{status:'IN_TRANSIT'})}>üü° ƒê∆∞·ªùng</button>
                        </div>
                      </td>
                      <td style={{width:105}}><input className="inp inp-xs mono" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(r.qtyKg)} onChange={e=>setInv(r.id,{qtyKg:pn(e.target.value)})}/></td>
                      <td style={{width:115}}><input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(r.avgCost)} onChange={e=>setInv(r.id,{avgCost:pn(e.target.value)})}/></td>
                      <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#93c5fd',fontSize:'.78rem'}}>{fv((parseFloat(r.qtyKg)||0)*(parseFloat(r.avgCost)||0))}</td>
                      <td><button className="btn-danger" onClick={()=>delInv(r.id)}><Ic.X/></button></td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr>
                    <td colSpan={3} style={{textAlign:'right',paddingRight:9,color:'#5a7a92',fontSize:'.7rem'}}>T·ªîNG</td>
                    <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#4ade80'}}>{fv(inventory.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0))} kg</td>
                    <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#94a3b8'}}>{fv(weightedAvg(inventory.map(r=>({qtyKg:parseFloat(r.qtyKg)||0,avgCost:parseFloat(r.avgCost)||0}))))} ƒë/kg avg</td>
                    <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#93c5fd'}}>{fv(inventory.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0)*(parseFloat(r.avgCost)||0),0))}</td>
                    <td/>
                  </tr>
                </tfoot>
              </table>

              <div style={{marginTop:15}}>
                <div style={{fontSize:'.75rem',fontWeight:800,color:'#4a7090',textTransform:'uppercase',letterSpacing:'.06em',marginBottom:9}}>T√≥m t·∫Øt theo SKU (Kho + ƒê∆∞·ªùng pooled)</div>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(230px,1fr))',gap:'9px'}}>
                  {groupBySku(inventory).map(g=>{
                    const all = [...g.inStock,...g.inTransit];
                    const qtyS = g.inStock.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0);
                    const qtyT = g.inTransit.reduce((s,r)=>s+(parseFloat(r.qtyKg)||0),0);
                    const avgAll = weightedAvg(all.map(r=>({qtyKg:parseFloat(r.qtyKg)||0,avgCost:parseFloat(r.avgCost)||0})));
                    const msKg = minStockMap[g.key] || 0;
                    const total = qtyS + qtyT;
                    const ratio = msKg > 0 ? total/msKg : null;
                    return (
                      <div key={g.key} className={`sku-card ${ratio!==null&&ratio<0.8?'alert-low':ratio!==null&&ratio>0.8&&ratio<1?'warn':''}`}>
                        <div style={{fontWeight:800,fontSize:'.82rem',color:'#dce6f4',marginBottom:5}}>{g.label}</div>
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:5,marginBottom:6}}>
                          <div style={{background:'#051809',border:'1px solid #166534',borderRadius:4,padding:'5px 7px'}}>
                            <div style={{fontSize:'.66rem',color:'#22c55e',fontWeight:700,opacity:.8}}>üü¢ Kho</div>
                            <div className="mono" style={{fontSize:'.85rem',fontWeight:700,color:'#4ade80'}}>{fv(qtyS)} kg</div>
                          </div>
                          <div style={{background:'#1c1400',border:'1px solid #854d0e',borderRadius:4,padding:'5px 7px'}}>
                            <div style={{fontSize:'.66rem',color:'#f59e0b',fontWeight:700,opacity:.8}}>üü° ƒê∆∞·ªùng</div>
                            <div className="mono" style={{fontSize:'.85rem',fontWeight:700,color:'#fcd34d'}}>{fv(qtyT)} kg</div>
                          </div>
                        </div>
                        {msKg > 0 && <div style={{marginBottom:6}}><StockBar available={total} minStock={msKg}/></div>}
                        <div style={{display:'flex',justifyContent:'space-between'}}>
                          <span style={{fontSize:'.7rem',color:'#5a7a92'}}>T·ªïng <strong className="mono" style={{color:'#dce6f4'}}>{fv(total)} kg</strong></span>
                          <span style={{fontSize:'.7rem',color:'#5a7a92'}}>BQ <strong className="mono" style={{color:'#93c5fd'}}>{fv(avgAll)} ƒë/kg</strong></span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB MIN STOCK ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='minstock' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto',background:bg1}}>
            <div style={{maxWidth:'900px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:15}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1.05rem',color:'#dce6f4'}}>üìè Min Stock per SKU</h2>
                  <p style={{fontSize:'.78rem',color:'#5a7a92',marginTop:3}}>L∆∞·ª£ng t·ªìn kho t·ªëi thi·ªÉu (OnHand + InTransit). C·∫£nh b√°o khi Available d∆∞·ªõi ng∆∞·ª°ng n√†y.</p>
                </div>
                <div style={{display:'flex',gap:8}}>
                  <button className="btn btn-ghost btn-sm" onClick={syncGoogleSheet} disabled={dbStatus.loading} style={{display:'flex',alignItems:'center',gap:4}}>
                    {dbStatus.loading?<div className="spinner"/>:<Ic.Refresh/>} Sync GSheet
                  </button>
                  <button className="btn btn-ghost btn-sm" onClick={addMS} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m SKU</button>
                </div>
              </div>

              <table className="tbl" style={{background:bg3,borderRadius:8,overflow:'hidden'}}>
                <thead>
                  <tr><th>#</th><th style={{textAlign:'left',paddingLeft:5}}>SKU</th><th>Min Stock kg</th><th>Hi·ªán t·∫°i kg</th><th>Tr·∫°ng th√°i</th><th></th></tr>
                </thead>
                <tbody>
                  {minStockRows.map((r,i)=>{
                    const k = skuKey(r);
                    const grp = groupBySku(inventory).find(g=>g.key===k);
                    const curQty = grp ? [...grp.inStock,...grp.inTransit].reduce((s,x)=>s+(parseFloat(x.qtyKg)||0),0) : 0;
                    const ratio = r.minStockKg > 0 ? curQty/r.minStockKg : null;
                    const status = ratio===null?'‚Äî':ratio<0.8?'THI·∫æU':ratio<1?'G·∫¶N MIN':ratio>2?'D∆Ø':'OK';
                    const statusColor = ratio===null?'#5a7a92':ratio<0.8?'#ef4444':ratio<1?'#f59e0b':ratio>2?'#818cf8':'#22c55e';
                    return (
                      <tr key={r.id}>
                        <td style={{textAlign:'center',color:'#4a7090',fontSize:'.75rem'}} className="mono">{i+1}</td>
                        <td style={{paddingLeft:5}}><SkuSel row={r} onChange={patch=>setMS(r.id,patch)}/></td>
                        <td style={{width:130}}>
                          <input className="inp inp-xs mono" style={{textAlign:'right',color:'#d8b4fe',fontWeight:700}} value={fv(r.minStockKg)} onChange={e=>setMS(r.id,{minStockKg:pn(e.target.value)})}/>
                        </td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#93c5fd',fontSize:'.82rem'}}>{fv(curQty)}</td>
                        <td style={{textAlign:'center'}}>
                          <span className="mono" style={{fontSize:'.75rem',fontWeight:700,color:statusColor}}>{status}</span>
                          {ratio!==null && <div style={{fontSize:'.6rem',color:'#3a5570',marginTop:2}}>{Math.round(ratio*100)}% of min</div>}
                        </td>
                        <td><button className="btn-danger" onClick={()=>delMS(r.id)}><Ic.X/></button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>

              <div className="card-inset" style={{marginTop:13}}>
                <p style={{fontSize:'.78rem',color:'#5a7a92',lineHeight:1.8}}>
                  üí° Logic: <strong style={{color:'#fc8181'}}>{'<'}80% MinStock</strong> = Thi·∫øu h√†ng ¬∑ <strong style={{color:'#f59e0b'}}>80‚Äì100%</strong> = G·∫ßn ng∆∞·ª°ng ¬∑ <strong style={{color:'#4ade80'}}>100‚Äì200%</strong> = OK ¬∑ <strong style={{color:'#818cf8'}}>{'>'}200%</strong> = D∆∞ h√†ng
                </p>
                <p style={{fontSize:'.78rem',color:'#5a7a92',marginTop:6}}>
                  üîó MinStock ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Google Sheet tab MinStock. B·∫°n c√≥ th·ªÉ s·ª≠a tr·ª±c ti·∫øp t·∫°i ƒë√¢y ho·∫∑c c·∫≠p nh·∫≠t trong GSheet v√† b·∫•m Sync.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB SELLING PRICES ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='selling' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto',background:bg1}}>
            <div style={{maxWidth:'700px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:15}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1.05rem',color:'#dce6f4'}}>üè∑Ô∏è Gi√° b√°n theo m√°c nh√¥m</h2>
                  <p style={{fontSize:'.78rem',color:'#5a7a92',marginTop:3}}>Format: "Alloy Temper" (VD: A5052 H32). Tra theo Alloy+Temper tr∆∞·ªõc ‚Üí Alloy ‚Üí m·∫∑c ƒë·ªãnh</p>
                </div>
                <button className="btn btn-ghost btn-sm" onClick={addSP} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m</button>
              </div>
              <table className="tbl" style={{background:bg3,borderRadius:8,overflow:'hidden'}}>
                <thead><tr><th>#</th><th style={{textAlign:'left',paddingLeft:9}}>M√°c nh√¥m</th><th>Gi√° b√°n ƒë/kg</th><th>vs Gi√° Hƒê m·∫∑c ƒë·ªãnh</th><th></th></tr></thead>
                <tbody>
                  {sellingPrices.map((sp,i)=>{
                    const diff = sp.price - inputs.contractPrice;
                    return (
                      <tr key={sp.id}>
                        <td style={{textAlign:'center',color:'#4a7090',fontSize:'.75rem'}} className="mono">{i+1}</td>
                        <td style={{paddingLeft:9}}><input className="inp inp-sm" style={{width:155}} value={sp.alloy} onChange={e=>setSpR(sp.id,'alloy',e.target.value)}/></td>
                        <td style={{width:145}}><input className="inp inp-sm mono" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(sp.price)} onChange={e=>setSpR(sp.id,'price',pn(e.target.value))}/></td>
                        <td style={{textAlign:'center'}}><span className={`tag ${diff>=0?'tg':'tr'} mono`}>{diff>=0?'+':''}{fv(diff)}</span></td>
                        <td><button className="btn-danger" onClick={()=>delSP(sp.id)}><Ic.X/></button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div className="card-inset" style={{marginTop:13}}>
                <p style={{fontSize:'.78rem',color:'#5a7a92',lineHeight:1.8}}>
                  üí° Logic tra: <strong style={{color:'#93c5fd'}}>A5052 H32</strong> ‚Üí <strong style={{color:'#94a3b8'}}>A5052</strong> ‚Üí <strong style={{color:'#4ade80'}}>Gi√° Hƒê m·∫∑c ƒë·ªãnh {fv(inputs.contractPrice)}</strong> ƒë/kg
                </p>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB SCENARIOS ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='scenario' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto',background:bg1}}>
            <div style={{maxWidth:'1020px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:15}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1.05rem',color:'#dce6f4'}}>üíæ Scenarios l∆∞u tr·ªØ</h2>
                  <p style={{fontSize:'.78rem',color:'#5a7a92',marginTop:3}}>So s√°nh c√°c ph∆∞∆°ng √°n nh·∫≠p h√†ng theo th·ªùi gian</p>
                </div>
                <div style={{display:'flex',gap:8}}>
                  <button className="btn btn-export btn-sm" onClick={()=>result&&exportCsv(result.blends,inputs)} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Download/> Export CSV</button>
                  <button className="btn btn-success btn-sm" onClick={saveScenario} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Save/> L∆∞u scenario</button>
                </div>
              </div>
              {scenarios.length===0 ? (
                <div className="card" style={{textAlign:'center',padding:44,border:`1px dashed ${border2}`}}>
                  <div style={{fontSize:'2rem',marginBottom:11}}>üíæ</div>
                  <div style={{color:'#7ba3be',fontWeight:700,fontSize:'.9rem'}}>Ch∆∞a c√≥ scenario</div>
                  <div style={{fontSize:'.76rem',color:'#4a7090',marginTop:7}}>Nh·∫•n "L∆∞u Scenario" sau khi nh·∫≠p ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu</div>
                </div>
              ) : (
                <table className="tbl" style={{background:bg3,borderRadius:8,overflow:'hidden'}}>
                  <thead>
                    <tr><th>#</th><th style={{textAlign:'left',paddingLeft:9}}>T√™n</th><th>Container</th><th>KL</th><th>Invoice</th><th>BQ tr∆∞·ªõc</th><th>BQ sau</th><th>Break-even</th><th>R·ªßi ro</th><th></th></tr>
                  </thead>
                  <tbody>
                    {scenarios.map((s,i)=>(
                      <tr key={s.id}>
                        <td style={{textAlign:'center',color:'#4a7090',fontSize:'.75rem'}} className="mono">{i+1}</td>
                        <td style={{paddingLeft:9}}>
                          <div style={{fontWeight:700,fontSize:'.82rem',color:'#dce6f4'}}>{s.name}</div>
                          <div style={{fontSize:'.68rem',color:'#5a7a92',marginTop:1}}>{s.date}</div>
                        </td>
                        <td style={{textAlign:'center'}}>
                          <span className={`tag ${s.containerTons>=24.5&&s.containerTons<=26.5?'tg':s.containerTons<24?'tr':'ty'}`}>{s.containerTons?.toFixed(1)}T</span>
                        </td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#4ade80'}}>{fv(s.totalKg)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#fcd34d'}}>{fu(s.invoiceUSD)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#94a3b8'}}>{fv(s.globalAvgBefore)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#93c5fd',fontWeight:700}}>{fv(s.globalAvgAfter)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:9,color:'#d8b4fe'}}>{fv(s.globalBreakEven)}</td>
                        <td style={{textAlign:'center'}}><span className={`tag ${s.hasRisk?'tr':'tg'}`}>{s.hasRisk?'‚ö† R·ªßi ro':'‚úì An to√†n'}</span></td>
                        <td style={{textAlign:'center'}}>
                          <div style={{display:'flex',gap:4,justifyContent:'center'}}>
                            <button className="btn btn-solid btn-xs" onClick={()=>{setProducts(s.products);setInputs(s.inputs);setTab('main');}}>T·∫£i</button>
                            <button className="btn-danger" onClick={()=>setScenarios(p=>p.filter(x=>x.id!==s.id))}><Ic.X/></button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
