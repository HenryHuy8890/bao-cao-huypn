<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAKD BUY 3.1 ‚Äì SKU Aluminum Strategy</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#05080f;color:#c4cfde;height:100vh;overflow:hidden;}
.mono{font-family:'JetBrains Mono',monospace;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:#070c14;}
::-webkit-scrollbar-thumb{background:#182436;border-radius:2px;}
.inp{width:100%;background:#0a111c;border:1px solid #162030;color:#c4cfde;border-radius:4px;padding:5px 8px;font-size:.8rem;transition:border-color .15s;}
.inp:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.12);}
.inp-xs{padding:3px 5px;font-size:.72rem;}
.inp-sm{padding:4px 7px;font-size:.76rem;}
select.inp option{background:#0a111c;}
.inp[readonly]{background:#060a10;color:#3a5060;cursor:not-allowed;}
.lbl{display:block;font-size:.57rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#3a5060;margin-bottom:3px;}
.card{background:#080f1a;border:1px solid #111e2d;border-radius:8px;padding:12px;}
.card-inset{background:#050b14;border:1px solid #0d1a27;border-radius:6px;padding:10px;}
.sh{font-size:.58rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#2a4055;border-bottom:1px solid #0d1a27;padding-bottom:6px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.tag{display:inline-flex;align-items:center;padding:1px 7px;border-radius:3px;font-size:.6rem;font-weight:800;font-family:'JetBrains Mono',monospace;}
.tg{background:#041a0b;color:#34d399;border:1px solid #064e1e;}
.ty{background:#1a1200;color:#fbbf24;border:1px solid #4d3400;}
.tr{background:#1a0404;color:#f87171;border:1px solid #4d0f0f;}
.tb{background:#030f25;color:#60a5fa;border:1px solid #0c2455;}
.tp{background:#0d0520;color:#c084fc;border:1px solid #3b1060;}
.ts{background:#0d1218;color:#94a3b8;border:1px solid #1e2d3d;}
.btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:5px;font-size:.73rem;font-weight:700;cursor:pointer;border:none;transition:all .15s;font-family:'Inter',sans-serif;}
.btn-ghost{background:transparent;border:1px dashed #162a3e;color:#3b82f6;}
.btn-ghost:hover{background:#051425;border-color:#2563eb;}
.btn-solid{background:#0f2040;color:#60a5fa;border:1px solid #1e3a5f;}
.btn-solid:hover{background:#1e3a5f;color:#93c5fd;}
.btn-sm{padding:3px 8px;font-size:.66rem;}
.btn-xs{padding:2px 6px;font-size:.62rem;}
.btn-danger{background:transparent;border:none;color:#2a3d50;padding:2px 5px;cursor:pointer;border-radius:3px;font-size:.8rem;}
.btn-danger:hover{color:#f87171;background:#3b0a0a22;}
.btn-success{background:#041a0b;border:1px solid #065f27;color:#34d399;}
.btn-success:hover{background:#065f27;color:#fff;}
.tbl{width:100%;border-collapse:collapse;font-size:.77rem;}
.tbl th{background:#050b14;color:#2a4055;font-size:.57rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;padding:6px 7px;text-align:center;border-bottom:1px solid #0d1a27;white-space:nowrap;}
.tbl td{padding:3px 4px;border-bottom:1px solid #09111d;vertical-align:middle;}
.tbl tbody tr:hover td{background:#070e18;}
.tbl tfoot td{border-top:1px solid #1e3a5f;padding:6px 8px;font-weight:700;}
.tbl .inp{background:#050b14;border-color:#0d1a27;}
.tbl .inp:focus{background:#070f1c;border-color:#2563eb;}
.kpi{padding:10px 12px;background:#050b14;border:1px solid #0d1a27;border-radius:7px;}
.kpi-l{font-size:.54rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#2a4055;margin-bottom:3px;}
.kpi-v{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:800;line-height:1.15;}
.kpi-s{font-size:.6rem;color:#2a4055;margin-top:3px;}
.nav-tab{padding:6px 12px;font-size:.7rem;font-weight:700;cursor:pointer;border-radius:5px;border:1px solid transparent;color:#2a4055;transition:all .15s;background:transparent;}
.nav-tab.on{background:#080f1a;border-color:#111e2d;color:#60a5fa;}
.nav-tab:not(.on):hover{color:#6b8da8;}
.status-btn{flex:1;padding:4px 8px;font-size:.65rem;font-weight:700;border-radius:4px;cursor:pointer;transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;}
.status-btn.s-stock{background:#041a0b;border-color:#065f27;color:#34d399;}
.status-btn.s-transit{background:#1a1200;border-color:#713f12;color:#fbbf24;}
.status-btn.off{background:transparent;border-color:#0d1a27;color:#2a4055;}
.sku-card{background:#050b14;border:1px solid #0d1a27;border-radius:6px;padding:10px 12px;transition:border-color .15s;}
.sku-card:hover{border-color:#162030;}
.sku-card.warn{border-color:#4d0f0f;background:#0a0505;}
.sku-card.ok{border-color:#064e1e;}
.chart-box{background:#050b14;border:1px solid #0d1a27;border-radius:7px;padding:10px;}
.div-line{border-top:1px solid #0d1a27;margin:8px 0;}
@media print{
  .no-print{display:none!important;}
  body{background:#fff;color:#000;height:auto;overflow:auto;}
  .card,.kpi,.sku-card{background:#fff;border:1px solid #ccc;}
  .tbl th{background:#f3f4f6;color:#374151;}
}
</style>
</head>
<body>
<div id="root" style="height:100vh;display:flex;flex-direction:column;overflow:hidden;"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo,useCallback} = React;

const ALLOYS  = ["A1050","A1060","A3003","A3003 CT","A3105","A5052","A5083","A6061","A6063"];
const TEMPERS = ["H14","H16","H18","H24","H32","H34","H111","O","T5","T6"];
const THICKS  = ["0.4","0.5","0.6","0.7","0.8","0.9","1.0","1.2","1.5","2.0","2.5","3.0","4.0","5.0","6.0"];
const WIDTHS  = ["600","800","1000","1200","1220","1250","1500","1524","2000"];
const LENGTHS = ["Coil","1000","1200","2000","2400","2500","3000","4000","6000","Custom"];

// SKU identity: h·ªón h·ª£p ‚Üí cu·ªôn kh√¥ng c·∫ßn length ri√™ng bi·ªát (length=Coil)
const skuKey   = r => `${r.alloy}|${r.temper}|${r.thickness}|${r.width}|${r.length}`;
const skuLabel = r => `${r.alloy} ${r.temper}  ${r.thickness}√ó${r.width}√ó${r.length}`;

const uid = () => Date.now() + Math.random();
const fv  = v => (isNaN(v)||!isFinite(v)) ? '0' : new Intl.NumberFormat('vi-VN').format(Math.round(v));
const fu  = v => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:1}).format(v||0);
const pn  = s => parseFloat(String(s).replace(/\./g,'').replace(/,/g,''))||0;

// ‚îÄ‚îÄ PURE ENGINE FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const weightedAvg = rows => {
  const qty = rows.reduce((s,r)=>s+(r.qtyKg||r.qty||0), 0);
  const val = rows.reduce((s,r)=>s+(r.qtyKg||r.qty||0)*r.avgCost, 0);
  return qty > 0 ? val/qty : 0;
};

const groupBySku = rows => {
  const map = {};
  rows.forEach(r => {
    const k = skuKey(r);
    if (!map[k]) map[k] = {
      key:k, label:skuLabel(r),
      alloy:r.alloy, temper:r.temper, thickness:r.thickness, width:r.width, length:r.length,
      inStock:[], inTransit:[]
    };
    if (r.status==='IN_STOCK') map[k].inStock.push(r);
    else map[k].inTransit.push(r);
  });
  return Object.values(map);
};

const calcInvoice = (products, exRate) => {
  const usd = products.reduce((s,p)=>s+(p.qtyKg/1000)*p.priceFC, 0);
  return {invoiceUSD:usd, invoiceVND:usd*exRate};
};

const calcLanded = (invoiceVND, totalKg, inp) => {
  const mgmt    = invoiceVND*(inp.managementFee/100);
  const tax     = invoiceVND*(inp.importTax/100);
  const freight = Math.max(0, inp.freightTotal);
  const proc    = inp.processingCost*totalKg;
  const total   = invoiceVND+mgmt+tax+freight+proc;
  return {mgmt, tax, freight, proc, landedVND:total, landedPerKg:totalKg>0?total/totalKg:0};
};

const calcFinance = (invoiceVND, land, totalKg, inp) => {
  const days = inp.leadTime + inp.holdingTime;
  let fin = 0;
  if (inp.paymentMethod==='TT') {
    fin = (invoiceVND+land.tax+land.freight)*(inp.capitalCostPercent/100)*(days/365);
  } else {
    fin = invoiceVND*(inp.lcOpenFee/100)
        + invoiceVND*(inp.lcInterest/100)*(inp.lcDays/365)
        + (invoiceVND*inp.lcMargin/100+land.tax+land.freight)*(inp.capitalCostPercent/100)*(days/365);
  }
  return {finVND:fin, finPerKg:totalKg>0?fin/totalKg:0};
};

const calcProductBreakdown = (products, land, fin, totalKg, inp) => {
  return products.map(p => {
    const ratio  = totalKg>0 ? p.qtyKg/totalKg : 0;
    const invVND = (p.qtyKg/1000)*p.priceFC*inp.exchangeRate;
    const mgmt   = invVND*(inp.managementFee/100);
    const tax    = invVND*(inp.importTax/100);
    const freight= land.freight*ratio;
    const proc   = inp.processingCost*p.qtyKg;
    const finRow = fin.finVND*ratio;
    const landedRow = invVND+mgmt+tax+freight+proc;
    const physPerKg = p.qtyKg>0 ? landedRow/p.qtyKg : 0;
    const econPerKg = physPerKg + (p.qtyKg>0 ? finRow/p.qtyKg : 0);
    return {...p, invVND, landedRow, finRow, physPerKg, econPerKg};
  });
};

// ‚îÄ‚îÄ KEY: SKU-level blend: t·ªìn kho + ƒëi ƒë∆∞·ªùng + l√¥ m·ªõi c√πng 1 SKU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const calcSkuBlend = (inventory, purchaseRows, sellingPrices, globalContractPrice, inputs) => {
  const skuGroups = groupBySku(inventory);

  return purchaseRows.map(p => {
    const k   = skuKey(p);
    const grp = skuGroups.find(g=>g.key===k);

    const stockRows   = grp ? grp.inStock   : [];
    const transitRows = grp ? grp.inTransit : [];
    const allExisting = [...stockRows, ...transitRows];

    // BQ hi·ªán t·∫°i (kho + ƒë∆∞·ªùng)
    const avgCurrent  = weightedAvg(allExisting);
    const avgStock    = weightedAvg(stockRows);
    const avgTransit  = weightedAvg(transitRows);
    const qtyStock    = stockRows.reduce((s,r)=>s+r.qtyKg,0);
    const qtyTransit  = transitRows.reduce((s,r)=>s+r.qtyKg,0);
    const qtyExisting = qtyStock + qtyTransit;

    // BQ sau nh·∫≠p = blend c·ªßa c·∫£ 3 l·ªõp
    const newRow  = {qtyKg:p.qtyKg, avgCost:p.physPerKg||0};
    const avgAfter= weightedAvg([...allExisting, newRow]);
    const qtyAfter= qtyExisting + p.qtyKg;

    // Break-even T·ª™ avgAfter (ƒë√∫ng nghi·ªáp v·ª• th∆∞∆°ng m·∫°i kim lo·∫°i)
    const finPerKg = p.qtyKg>0 ? p.finRow/p.qtyKg : 0;
    const custFin  = avgAfter*(inputs.lendingRate/100)*(inputs.customerCreditDays/365);
    const breakEven = avgAfter + finPerKg + custFin;

    // Gi√° b√°n tra b·∫£ng
    const spKey1 = p.alloy+' '+p.temper;
    const spKey2 = p.alloy;
    const sp = sellingPrices.find(s=>s.alloy===spKey1) || sellingPrices.find(s=>s.alloy===spKey2);
    const sellPrice = sp ? sp.price : globalContractPrice;

    const realProfit = sellPrice*(1-inputs.businessRiskPercent/100) - breakEven;
    const isRisk     = breakEven > sellPrice;

    return {
      ...p, skuKey:k, skuLbl:skuLabel(p),
      avgCurrent, avgStock, avgTransit,
      qtyStock, qtyTransit, qtyExisting,
      avgAfter, qtyAfter,
      breakEven, custFin, sellPrice, realProfit, isRisk
    };
  });
};

// ‚îÄ‚îÄ DEFAULT STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const defInventory = [
  {id:1, alloy:'A5052', temper:'H32', thickness:'1.0', width:'1200', length:'2400', status:'IN_STOCK',   qtyKg:3000, avgCost:90000},
  {id:2, alloy:'A5052', temper:'H32', thickness:'1.0', width:'1200', length:'2400', status:'IN_TRANSIT', qtyKg:5000, avgCost:105000},
  {id:3, alloy:'A3003', temper:'H14', thickness:'0.8', width:'1000', length:'Coil', status:'IN_STOCK',   qtyKg:2000, avgCost:93000},
  {id:4, alloy:'A3003', temper:'H14', thickness:'0.8', width:'1000', length:'Coil', status:'IN_TRANSIT', qtyKg:4000, avgCost:99000},
  {id:5, alloy:'A1050', temper:'H14', thickness:'1.2', width:'1200', length:'Coil', status:'IN_STOCK',   qtyKg:1500, avgCost:88000},
];
const defSP = [
  {id:1, alloy:'A5052 H32', price:109000},
  {id:2, alloy:'A5052 H34', price:110500},
  {id:3, alloy:'A3003 H14', price:101000},
  {id:4, alloy:'A1050 H14', price: 97000},
  {id:5, alloy:'A6061 T6',  price:115000},
];
const defProducts = [
  {id:1, alloy:'A5052', temper:'H32', thickness:'1.0', width:'1200', length:'2400', qtyKg:5000, priceFC:4250},
  {id:2, alloy:'A3003', temper:'H14', thickness:'0.8', width:'1000', length:'Coil', qtyKg:3000, priceFC:4050},
];
const defInputs = {
  supplierName:'Yuwon Steel', creator:'Nguy·ªÖn VƒÉn A',
  paymentMethod:'LC', capitalCostPercent:6.5,
  lcMargin:10, lcDays:90, lcOpenFee:0.2, lcInterest:5.8,
  exchangeRate:26150, managementFee:1.0,
  leadTime:30, holdingTime:60,
  freightTotal:45000000, importTax:0, processingCost:200,
  contractPrice:105000, marketPrice:102000,
  businessRiskPercent:2.0, customerCreditDays:30, lendingRate:12.0,
};

// ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Ic = {
  Plus:  ()=><svg style={{width:12,height:12}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>,
  X:     ()=><svg style={{width:11,height:11}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
  Ship:  ()=><svg style={{width:14,height:14}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
  Chart: ()=><svg style={{width:14,height:14}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
  Save:  ()=><svg style={{width:14,height:14}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>,
  Tag:   ()=><svg style={{width:14,height:14}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
  Print: ()=><svg style={{width:14,height:14}} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>,
};

// ‚îÄ‚îÄ SKU SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SkuSel = ({row, onChange}) => {
  const S = (f,v) => onChange({...row,[f]:v});
  return (
    <div style={{display:'flex',gap:'3px',alignItems:'center'}}>
      <select className="inp inp-xs" style={{minWidth:68}} value={row.alloy}    onChange={e=>S('alloy',e.target.value)}>{ALLOYS.map(a=><option key={a}>{a}</option>)}</select>
      <select className="inp inp-xs" style={{minWidth:44}} value={row.temper}   onChange={e=>S('temper',e.target.value)}>{TEMPERS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#162030',fontSize:'.7rem',flexShrink:0}}>‚Ä¢</span>
      <select className="inp inp-xs" style={{minWidth:44}} value={row.thickness} onChange={e=>S('thickness',e.target.value)}>{THICKS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#162030',fontSize:'.7rem',flexShrink:0}}>√ó</span>
      <select className="inp inp-xs" style={{minWidth:50}} value={row.width}    onChange={e=>S('width',e.target.value)}>{WIDTHS.map(a=><option key={a}>{a}</option>)}</select>
      <span style={{color:'#162030',fontSize:'.7rem',flexShrink:0}}>√ó</span>
      <select className="inp inp-xs" style={{minWidth:56}} value={row.length}   onChange={e=>S('length',e.target.value)}>{LENGTHS.map(a=><option key={a}>{a}</option>)}</select>
    </div>
  );
};

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const App = () => {
  const [tab, setTab]           = useState('main');
  const [inputs, setInputs]     = useState(defInputs);
  const [products, setProducts] = useState(defProducts);
  const [inventory, setInvs]    = useState(defInventory);
  const [sellingPrices, setSP]  = useState(defSP);
  const [scenarios, setScenarios] = useState([]);
  const chartRef  = useRef(null);
  const chartInst = useRef(null);

  const setInp = useCallback((f,v)=>setInputs(p=>({...p,[f]:v})),[]);

  // ‚îÄ‚îÄ COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const result = useMemo(()=>{
    const totalKg = products.reduce((s,p)=>s+p.qtyKg, 0);
    if (totalKg<=0) return null;
    const inv   = calcInvoice(products, inputs.exchangeRate);
    const land  = calcLanded(inv.invoiceVND, totalKg, inputs);
    const fin   = calcFinance(inv.invoiceVND, land, totalKg, inputs);
    const rows  = calcProductBreakdown(products, land, fin, totalKg, inputs);
    const blends= calcSkuBlend(inventory, rows, sellingPrices, inputs.contractPrice, inputs);

    // Global pooled avg (to√†n b·ªô h√†ng, kh√¥ng ph√¢n bi·ªát SKU)
    const allInvRows  = inventory.map(r=>({qtyKg:r.qtyKg, avgCost:r.avgCost}));
    const newPurchRows = rows.map(r=>({qtyKg:r.qtyKg, avgCost:r.physPerKg}));
    const globalAvgBefore = weightedAvg(allInvRows);
    const globalAvgAfter  = weightedAvg([...allInvRows, ...newPurchRows]);
    const custFin         = globalAvgAfter*(inputs.lendingRate/100)*(inputs.customerCreditDays/365);
    const globalBreakEven = globalAvgAfter + fin.finPerKg + custFin;

    const hasRisk = blends.some(b=>b.isRisk);
    const rec = !hasRisk ? {txt:'NH·∫¨P B·∫¢O TO√ÄN',cls:'tg'}
              :  hasRisk ? {txt:'C√ì SKU R·ª¶I RO', cls:'tr'}
              : {txt:'NH·∫¨P C√ÇN B·∫∞NG',cls:'tb'};

    return {totalKg, ...inv, ...land, ...fin, rows, blends,
            globalAvgBefore, globalAvgAfter, globalBreakEven, custFin,
            hasRisk, rec};
  },[inputs, products, inventory, sellingPrices]);

  // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(()=>{
    if (!result || !chartRef.current) return;
    if (chartInst.current) chartInst.current.destroy();
    const labels = result.blends.map(b=>`${b.alloy} ${b.temper} ${b.thickness}mm`);
    chartInst.current = new Chart(chartRef.current.getContext('2d'),{
      type:'bar',
      data:{
        labels,
        datasets:[
          {label:'BQ Hi·ªán t·∫°i',  data:result.blends.map(b=>b.avgCurrent), backgroundColor:'#182e48',borderRadius:3},
          {label:'L√¥ m·ªõi v·ªÅ kho',data:result.blends.map(b=>b.physPerKg),  backgroundColor:'#0e3d24',borderRadius:3},
          {label:'BQ Sau nh·∫≠p',  data:result.blends.map(b=>b.avgAfter),   backgroundColor:'#1e3a5f',borderRadius:3},
          {label:'Break-even',   data:result.blends.map(b=>b.breakEven),  backgroundColor:'#3b0f60',borderRadius:3},
          {label:'Gi√° b√°n Hƒê',   data:result.blends.map(b=>b.sellPrice),  backgroundColor:'#064e1e',borderRadius:3},
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:true,position:'bottom',labels:{color:'#3a5060',font:{size:9},padding:8,usePointStyle:true}},
          tooltip:{callbacks:{label:c=>c.dataset.label+': '+fv(c.parsed.y)+' ƒë/kg'}}
        },
        scales:{
          x:{grid:{color:'#090f18'},ticks:{color:'#2a4055',font:{size:8}}},
          y:{grid:{color:'#090f18'},beginAtZero:false,
             min:result.blends.length ? Math.min(...result.blends.flatMap(b=>[b.avgCurrent,b.physPerKg]))*0.97 : 0,
             ticks:{color:'#2a4055',font:{size:8},callback:v=>fv(v)}}
        }
      }
    });
  },[result]);

  // ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const addProduct = () => setProducts(p=>[...p,{id:uid(),alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'Coil',qtyKg:1000,priceFC:4000}]);
  const delProduct = id => { if(products.length>1) setProducts(p=>p.filter(r=>r.id!==id)); };
  const setProduct = (id,patch) => setProducts(p=>p.map(r=>r.id===id?{...r,...patch}:r));
  const addInv = () => setInvs(p=>[...p,{id:uid(),alloy:'A5052',temper:'H32',thickness:'1.0',width:'1200',length:'Coil',status:'IN_STOCK',qtyKg:0,avgCost:0}]);
  const delInv = id => setInvs(p=>p.filter(r=>r.id!==id));
  const setInv = (id,patch) => setInvs(p=>p.map(r=>r.id===id?{...r,...patch}:r));
  const addSP  = () => setSP(p=>[...p,{id:uid(),alloy:'A5052 H32',price:0}]);
  const delSP  = id => setSP(p=>p.filter(r=>r.id!==id));
  const setSpR = (id,f,v) => setSP(p=>p.map(r=>r.id===id?{...r,[f]:v}:r));
  const saveScenario = () => {
    if (!result) return;
    setScenarios(p=>[...p,{
      id:uid(),
      name:`${new Date().toLocaleDateString('vi-VN')} ¬∑ ${products.map(p=>p.alloy+' '+p.temper).join('+')}`,
      date:new Date().toLocaleDateString('vi-VN'),
      totalKg:result.totalKg, invoiceUSD:result.invoiceUSD,
      globalAvgBefore:result.globalAvgBefore, globalAvgAfter:result.globalAvgAfter,
      globalBreakEven:result.globalBreakEven, hasRisk:result.hasRisk,
      blendCount:result.blends.length,
      inputs:{...inputs}, products:[...products]
    }]);
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  return (
    <div style={{height:'100vh',display:'flex',flexDirection:'column',overflow:'hidden'}}>

      {/* HEADER */}
      <div style={{background:'#060c17',borderBottom:'1px solid #0d1a27',padding:'7px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
        <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
          <div style={{background:'linear-gradient(135deg,#1d4ed8,#6d28d9)',borderRadius:'7px',width:'28px',height:'28px',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:900,fontSize:'14px',color:'#fff',fontFamily:'JetBrains Mono'}}>P</div>
          <div>
            <div style={{fontWeight:900,fontSize:'14px',letterSpacing:'-.02em'}}>PAKD BUY <span style={{color:'#3b82f6',fontFamily:'JetBrains Mono',fontSize:'11px'}}>3.1</span></div>
            <div style={{fontSize:'9px',color:'#2a4055',fontWeight:700,textTransform:'uppercase',letterSpacing:'.07em'}}>SKU-level ¬∑ T·ªìn kho + ƒêi ƒë∆∞·ªùng + L√¥ m·ªõi ¬∑ H&amp;D</div>
          </div>
          <div style={{width:'1px',height:'22px',background:'#0d1a27',margin:'0 4px'}}/>
          {[{k:'main',l:'üìä Ph√¢n t√≠ch'},{k:'inventory',l:'üì¶ T·ªìn kho'},{k:'selling',l:'üè∑Ô∏è Gi√° b√°n'},{k:'scenario',l:'üíæ Scenarios'}]
            .map(t=><button key={t.k} onClick={()=>setTab(t.k)} className={`nav-tab ${tab===t.k?'on':''}`}>{t.l}</button>)}
        </div>
        <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
          {result && <span className={`tag ${result.rec.cls}`}>{result.rec.txt}</span>}
          <button className="btn btn-success btn-sm" onClick={saveScenario} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Save/> L∆∞u</button>
          <button className="btn btn-solid btn-sm" onClick={()=>window.print()} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Print/> In A4</button>
        </div>
      </div>

      {/* BODY */}
      <div style={{flex:1,display:'flex',minHeight:0,overflow:'hidden'}}>

        {/* ‚ïê‚ïê MAIN TAB ‚ïê‚ïê */}
        {tab==='main' && (
          <div style={{display:'flex',width:'100%',height:'100%',minHeight:0}}>

            {/* LEFT CONFIG */}
            <div style={{width:'238px',flexShrink:0,background:'#060c17',borderRight:'1px solid #0d1a27',overflowY:'auto',padding:'10px',display:'flex',flexDirection:'column',gap:'8px'}}>
              <div className="card">
                <div className="sh"><Ic.Ship/>Th√¥ng s·ªë nh·∫≠p kh·∫©u</div>
                <div className="lbl" style={{color:'#60a5fa'}}>T·ª∑ gi√° USD/VND</div>
                <input className="inp mono" style={{fontSize:'.95rem',fontWeight:800,color:'#60a5fa',textAlign:'right',marginBottom:8}} value={fv(inputs.exchangeRate)} onChange={e=>setInp('exchangeRate',pn(e.target.value))} />
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'5px',marginBottom:6}}>
                  <div><label className="lbl" style={{color:'#c084fc'}}>H·ªá s·ªë QL %</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#c084fc'}} value={inputs.managementFee} onChange={e=>setInp('managementFee',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl">Thu·∫ø NK %</label><input type="number" className="inp inp-xs" value={inputs.importTax} onChange={e=>setInp('importTax',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl">C∆∞·ªõc VND t·ªïng</label><input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(inputs.freightTotal)} onChange={e=>setInp('freightTotal',pn(e.target.value))}/></div>
                  <div><label className="lbl">Gia c√¥ng ƒë/kg</label><input type="number" className="inp inp-xs" value={inputs.processingCost} onChange={e=>setInp('processingCost',pn(e.target.value))}/></div>
                  <div><label className="lbl">Lead time ng√†y</label><input type="number" className="inp inp-xs" value={inputs.leadTime} onChange={e=>setInp('leadTime',parseInt(e.target.value)||0)}/></div>
                  <div><label className="lbl">Hold time ng√†y</label><input type="number" className="inp inp-xs" value={inputs.holdingTime} onChange={e=>setInp('holdingTime',parseInt(e.target.value)||0)}/></div>
                </div>
                <div style={{display:'flex',gap:'4px',marginBottom:5}}>
                  {['TT','LC'].map(m=>(
                    <button key={m} className={`status-btn ${inputs.paymentMethod===m?(m==='TT'?'s-stock':'s-transit'):'off'}`} onClick={()=>setInp('paymentMethod',m)}>
                      {m==='TT'?'T/T':'L/C'}
                    </button>
                  ))}
                </div>
                {inputs.paymentMethod==='LC' ? (
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'3px',background:'#040a13',padding:'6px',borderRadius:'4px',border:'1px solid #0d1a27'}}>
                    <div><label className="lbl">Margin%</label><input type="number" className="inp inp-xs" value={inputs.lcMargin} onChange={e=>setInp('lcMargin',parseFloat(e.target.value)||0)}/></div>
                    <div><label className="lbl">Days</label><input type="number" className="inp inp-xs" value={inputs.lcDays} onChange={e=>setInp('lcDays',parseInt(e.target.value)||0)}/></div>
                    <div><label className="lbl">Int%</label><input type="number" step=".1" className="inp inp-xs" value={inputs.lcInterest} onChange={e=>setInp('lcInterest',parseFloat(e.target.value)||0)}/></div>
                  </div>
                ) : (
                  <div><label className="lbl">L√£i su·∫•t v·ªën %/nƒÉm</label><input type="number" step=".1" className="inp inp-xs" value={inputs.capitalCostPercent} onChange={e=>setInp('capitalCostPercent',parseFloat(e.target.value)||0)}/></div>
                )}
              </div>
              <div className="card">
                <div className="sh"><Ic.Tag/>Tham chi·∫øu b√°n</div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'5px',marginBottom:6}}>
                  <div><label className="lbl" style={{color:'#34d399'}}>Gi√° Hƒê/KH ƒë/kg</label><input className="inp inp-xs mono" style={{textAlign:'right',color:'#34d399',fontWeight:700}} value={fv(inputs.contractPrice)} onChange={e=>setInp('contractPrice',pn(e.target.value))}/></div>
                  <div><label className="lbl">TT Spot ƒë/kg</label><input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(inputs.marketPrice)} onChange={e=>setInp('marketPrice',pn(e.target.value))}/></div>
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px'}}>
                  <div><label className="lbl" style={{color:'#f87171'}}>R·ªßi ro KD%</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#f87171'}} value={inputs.businessRiskPercent} onChange={e=>setInp('businessRiskPercent',parseFloat(e.target.value)||0)}/></div>
                  <div><label className="lbl" style={{color:'#c084fc'}}>C√¥ng n·ª£ ng√†y</label><input type="number" className="inp inp-xs" style={{color:'#c084fc'}} value={inputs.customerCreditDays} onChange={e=>setInp('customerCreditDays',parseInt(e.target.value)||0)}/></div>
                  <div><label className="lbl" style={{color:'#fbbf24'}}>L√£i vay%/nƒÉm</label><input type="number" step=".1" className="inp inp-xs" style={{color:'#fbbf24'}} value={inputs.lendingRate} onChange={e=>setInp('lendingRate',parseFloat(e.target.value)||0)}/></div>
                </div>
              </div>
            </div>

            {/* CENTER */}
            <div style={{flex:1,minWidth:0,display:'flex',flexDirection:'column',background:'#05080f',borderRight:'1px solid #0d1a27'}}>

              {/* Purchase table header */}
              <div style={{padding:'8px 12px',borderBottom:'1px solid #0d1a27',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
                <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                  <Ic.Ship/>
                  <span style={{fontWeight:800,fontSize:'.82rem'}}>L√¥ h√†ng d·ª± ƒë·ªãnh mua</span>
                  <span className="tag tb">{products.length} SKU</span>
                  {result && <span className="tag ts mono">{fv(result.totalKg)} kg</span>}
                  {result && <span className="tag ty mono">{fu(result.invoiceUSD)}</span>}
                </div>
                <button className="btn btn-ghost btn-sm" onClick={addProduct} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m SKU</button>
              </div>

              {/* Purchase rows */}
              <div style={{overflowY:'auto',maxHeight:'30%',padding:'6px 12px'}}>
                <table className="tbl">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th style={{textAlign:'left',paddingLeft:4}}>SKU: Alloy ¬∑ Temper ¬∑ D√†y √ó R·ªông √ó D√†i</th>
                      <th>KL kg</th><th>USD/T·∫•n</th><th>Invoice</th><th>V·ªÅ kho ƒë/kg</th><th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {products.map((p,i)=>{
                      const rb = result?.rows?.find(r=>r.id===p.id);
                      return (
                        <tr key={p.id}>
                          <td style={{textAlign:'center',color:'#1e3a5f',fontSize:'.68rem'}} className="mono">{i+1}</td>
                          <td style={{paddingLeft:4}}><SkuSel row={p} onChange={patch=>setProduct(p.id,patch)}/></td>
                          <td style={{width:88}}>
                            <input className="inp inp-xs mono" style={{textAlign:'right',color:'#34d399',fontWeight:700}} value={fv(p.qtyKg)} onChange={e=>setProduct(p.id,{qtyKg:pn(e.target.value)})}/>
                          </td>
                          <td style={{width:78}}>
                            <input type="number" className="inp inp-xs mono" style={{textAlign:'right',color:'#fbbf24'}} value={p.priceFC} onChange={e=>setProduct(p.id,{priceFC:parseFloat(e.target.value)||0})}/>
                          </td>
                          <td className="mono" style={{textAlign:'right',paddingRight:6,color:'#3a5060',fontSize:'.7rem'}}>{fu((p.qtyKg/1000)*p.priceFC)}</td>
                          <td style={{textAlign:'right',paddingRight:6}}>
                            {rb ? <span className="mono" style={{fontSize:'.75rem',fontWeight:700,color:rb.physPerKg>(result?.globalAvgBefore||0)?'#f87171':'#34d399'}}>{fv(rb.physPerKg)}</span> : <span style={{color:'#1e3a5f'}}>‚Äî</span>}
                          </td>
                          <td><button className="btn-danger" onClick={()=>delProduct(p.id)}><Ic.X/></button></td>
                        </tr>
                      );
                    })}
                  </tbody>
                  {result && (
                    <tfoot>
                      <tr>
                        <td colSpan={2} style={{textAlign:'right',color:'#2a4055',fontSize:'.62rem',paddingRight:8}}>T·ªîNG / BQ</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:6,color:'#34d399'}}>{fv(result.totalKg)}</td>
                        <td/>
                        <td className="mono" style={{textAlign:'right',paddingRight:6,color:'#fbbf24'}}>{fu(result.invoiceUSD)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:6,color:'#60a5fa'}}>{fv(result.landedPerKg)} avg</td>
                        <td/>
                      </tr>
                    </tfoot>
                  )}
                </table>
              </div>

              <div className="div-line" style={{margin:'0 12px'}}/>

              {/* SKU Blend Cards header */}
              <div style={{padding:'5px 12px 4px',flexShrink:0,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                  <Ic.Chart/>
                  <span style={{fontWeight:800,fontSize:'.8rem'}}>Ph√¢n t√≠ch SKU ¬∑ Kho + ƒê∆∞·ªùng + L√¥ m·ªõi</span>
                  <span style={{fontSize:'.6rem',color:'#1e3a5f'}}>‚Ü≥ Break-even t√≠nh t·ª´ BQ sau nh·∫≠p (ƒë√∫ng nghi·ªáp v·ª•)</span>
                </div>
                <div style={{display:'flex',gap:'8px',fontSize:'.58rem',color:'#2a4055'}}>
                  <span><span className="tag tg" style={{fontSize:'.54rem'}}>IN_STOCK</span> Kho</span>
                  <span><span className="tag ty" style={{fontSize:'.54rem'}}>IN_TRANSIT</span> ƒêang v·ªÅ</span>
                </div>
              </div>

              {/* SKU Cards */}
              <div style={{flex:1,overflowY:'auto',padding:'4px 12px 10px'}}>
                {result?.blends?.length > 0 ? (
                  <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(330px,1fr))',gap:'8px'}}>
                    {result.blends.map((b,i)=>(
                      <div key={b.skuKey+i} className={`sku-card ${b.isRisk?'warn':b.realProfit>1000?'ok':''}`}>
                        {/* Header */}
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:8}}>
                          <div>
                            <div style={{fontWeight:800,fontSize:'.8rem',color:'#c4cfde'}}>{b.alloy} {b.temper}</div>
                            <div style={{fontSize:'.63rem',color:'#2a4055',marginTop:1,fontFamily:'JetBrains Mono'}}>{b.thickness}mm √ó {b.width} √ó {b.length}</div>
                          </div>
                          <span className={`tag ${b.isRisk?'tr':b.realProfit>0?'tg':'ty'}`} style={{fontSize:'.62rem'}}>
                            {b.isRisk ? '‚ö† R·ª¶I RO' : b.realProfit>0 ? '‚úì C√ì L√ÉI' : '‚âà H√íA V·ªêN'}
                          </span>
                        </div>

                        {/* 3 pools */}
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px',marginBottom:8}}>
                          {[
                            {ico:'üü¢',lbl:'Trong kho',qty:b.qtyStock,  avg:b.avgStock,  bg:'#040f08',br:'#064e1e',vc:'#34d399',ac:'#065f27'},
                            {ico:'üü°',lbl:'ƒêang v·ªÅ',  qty:b.qtyTransit,avg:b.avgTransit,bg:'#140d00',br:'#4d3400',vc:'#fbbf24',ac:'#78400c'},
                            {ico:'üîµ',lbl:'L√¥ m·ªõi',   qty:b.qtyKg,     avg:b.physPerKg, bg:'#030f25',br:'#0c2455',vc:'#60a5fa',ac:'#1e40af'},
                          ].map((x,j)=>(
                            <div key={j} style={{background:x.bg,border:`1px solid ${x.br}`,borderRadius:4,padding:'5px 7px'}}>
                              <div style={{fontSize:'.52rem',color:x.br,fontWeight:700,marginBottom:2}}>{x.ico} {x.lbl}</div>
                              <div className="mono" style={{fontSize:'.82rem',fontWeight:700,color:x.vc}}>{fv(x.qty)}<span style={{fontSize:'.55rem',color:x.br}}> kg</span></div>
                              <div className="mono" style={{fontSize:'.63rem',color:x.ac}}>{fv(x.avg)} ƒë/kg</div>
                            </div>
                          ))}
                        </div>

                        {/* Avg flow arrow */}
                        <div style={{display:'flex',alignItems:'stretch',gap:3,marginBottom:8,background:'#040a13',borderRadius:4,padding:'6px 8px'}}>
                          {[
                            {l:'BQ Hi·ªán t·∫°i', v:b.avgCurrent,q:b.qtyExisting,c:'#94a3b8'},
                            null,
                            {l:'BQ Sau nh·∫≠p', v:b.avgAfter,  q:b.qtyAfter,   c:b.avgAfter>b.avgCurrent?'#f87171':'#60a5fa', bold:true},
                            null,
                            {l:'Break-even',  v:b.breakEven, q:null,          c:'#c084fc'},
                          ].map((x,j)=> x===null ? (
                            <div key={j} style={{color:'#1e3a5f',fontSize:'.9rem',alignSelf:'center',paddingTop:8}}>‚Üí</div>
                          ) : (
                            <div key={j} style={{flex:1,textAlign:'center'}}>
                              <div style={{fontSize:'.5rem',color:'#2a4055',marginBottom:2}}>{x.l}</div>
                              <div className="mono" style={{fontSize:x.bold?'.88rem':'.78rem',fontWeight:x.bold?900:700,color:x.c}}>{fv(x.v)}</div>
                              {x.q!==null && <div style={{fontSize:'.5rem',color:'#1e3a5f',marginTop:1}}>{fv(x.q)} kg</div>}
                            </div>
                          ))}
                        </div>

                        {/* P&L row */}
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-end'}}>
                          <div>
                            <div style={{fontSize:'.55rem',color:'#2a4055'}}>Gi√° b√°n theo m√£</div>
                            <div className="mono" style={{fontSize:'.8rem',fontWeight:700,color:'#34d399'}}>{fv(b.sellPrice)} ƒë/kg</div>
                          </div>
                          <div style={{textAlign:'right'}}>
                            <div style={{fontSize:'.55rem',color:'#2a4055'}}>L√£i / L·ªó th·ª±c</div>
                            <div className="mono" style={{fontSize:'.9rem',fontWeight:900,color:b.realProfit>=0?'#34d399':'#f87171'}}>
                              {b.realProfit>=0?'+':''}{fv(b.realProfit)} ƒë/kg
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{textAlign:'center',padding:'40px',color:'#1e3a5f'}}>Nh·∫≠p d·ªØ li·ªáu l√¥ h√†ng ƒë·ªÉ xem ph√¢n t√≠ch SKU</div>
                )}
              </div>

              {/* Cost breakdown bar */}
              {result && (
                <div style={{padding:'5px 12px 8px',borderTop:'1px solid #0d1a27',flexShrink:0}}>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:'5px'}}>
                    {[
                      {l:'Invoice',      v:result.invoiceVND, c:'#3a5060'},
                      {l:`QL ${inputs.managementFee}%`,v:result.mgmt,    c:'#7c3aed'},
                      {l:'Thu·∫ø NK',      v:result.tax,        c:'#b45309'},
                      {l:'C∆∞·ªõc+Logs',    v:result.freight,    c:'#0369a1'},
                      {l:'Gia c√¥ng',     v:result.proc,       c:'#0f766e'},
                      {l:'CP t√†i ch√≠nh', v:result.finVND,     c:'#9f1239'},
                    ].map((x,i)=>(
                      <div key={i} style={{background:'#060c17',border:'1px solid #0d1a27',borderRadius:4,padding:'4px 6px',textAlign:'center'}}>
                        <div className="mono" style={{fontSize:'.68rem',fontWeight:700,color:x.c}}>{fv(x.v)}</div>
                        <div style={{fontSize:'.5rem',color:'#1e3a5f',marginTop:1}}>{x.l}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* RIGHT KPI */}
            <div style={{width:'224px',flexShrink:0,background:'#060c17',overflowY:'auto',padding:'10px',display:'flex',flexDirection:'column',gap:'8px'}}>
              {result ? (
                <>
                  <div className="kpi">
                    <div className="kpi-l">BQ To√†n kho Hi·ªán t·∫°i</div>
                    <div className="kpi-v" style={{color:'#94a3b8',fontSize:'.95rem'}}>{fv(result.globalAvgBefore)}</div>
                    <div className="kpi-s">ƒë/kg ¬∑ {fv(inventory.reduce((s,r)=>s+r.qtyKg,0))} kg</div>
                  </div>
                  <div className="kpi" style={{background:'#030f25',borderColor:'#0c2455'}}>
                    <div className="kpi-l" style={{color:'#2563eb'}}>BQ Sau Nh·∫≠p (to√†n kho)</div>
                    <div className="kpi-v" style={{color:'#60a5fa'}}>{fv(result.globalAvgAfter)}</div>
                    <div style={{display:'flex',alignItems:'center',gap:5,marginTop:3}}>
                      <span className="kpi-s">ƒë/kg</span>
                      <span className={`tag ${result.globalAvgAfter>result.globalAvgBefore?'tr':'tg'} mono`} style={{fontSize:'.58rem'}}>
                        {result.globalAvgAfter>result.globalAvgBefore?'‚ñ≤':'‚ñº'} {fv(Math.abs(result.globalAvgAfter-result.globalAvgBefore))}
                      </span>
                    </div>
                  </div>
                  <div className="kpi" style={{background:'#0d0520',borderColor:'#3b1060'}}>
                    <div className="kpi-l" style={{color:'#6d28d9'}}>Break-even To√†n kho</div>
                    <div className="kpi-v" style={{color:'#c084fc',fontSize:'1rem'}}>{fv(result.globalBreakEven)}</div>
                    <div className="kpi-s">ƒë/kg ¬∑ gi√° b√°n t·ªëi thi·ªÉu</div>
                  </div>

                  {/* SKU risk mini */}
                  <div className="card-inset" style={{padding:8}}>
                    <div style={{fontSize:'.56rem',fontWeight:700,color:'#1e3a5f',textTransform:'uppercase',marginBottom:5}}>SKU Risk</div>
                    {result.blends.map((b,i)=>(
                      <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4,padding:'3px 5px',background:'#05080f',borderRadius:3,border:`1px solid ${b.isRisk?'#4d0f0f':'#0d1a27'}`}}>
                        <div style={{fontSize:'.62rem',fontWeight:700,color:'#c4cfde'}}>{b.alloy} {b.temper} {b.thickness}mm</div>
                        <span className="mono" style={{fontSize:'.6rem',color:b.realProfit>=0?'#34d399':'#f87171',fontWeight:700}}>
                          {b.realProfit>=0?'+':''}{fv(b.realProfit)}
                        </span>
                      </div>
                    ))}
                  </div>

                  <div className="chart-box" style={{height:185}}>
                    <div style={{fontSize:'.54rem',color:'#1e3a5f',fontWeight:700,textTransform:'uppercase',marginBottom:3}}>Gi√° v·ªën theo SKU</div>
                    <canvas ref={chartRef} style={{height:158}}></canvas>
                  </div>

                  <div style={{display:'flex',flexDirection:'column',gap:4}}>
                    {[
                      {l:'vs H·ª£p ƒë·ªìng', ref:inputs.contractPrice,ok:result.globalBreakEven<=inputs.contractPrice,y:'B√ÅN ƒê∆Ø·ª¢C',n:'KH√îNG L√ÉI'},
                      {l:'vs TT Spot',  ref:inputs.marketPrice,  ok:result.globalBreakEven<=inputs.marketPrice,  y:'C·∫†NH TRANH',n:'CAO H∆†N TT'},
                    ].map((d,i)=>(
                      <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',background:'#040a13',border:'1px solid #0d1a27',borderRadius:5,padding:'5px 8px'}}>
                        <div>
                          <div style={{fontSize:'.54rem',color:'#1e3a5f'}}>{d.l}</div>
                          <div className="mono" style={{fontSize:'.78rem',fontWeight:700}}>{fv(d.ref)}</div>
                        </div>
                        <span className={`tag ${d.ok?'tg':'tr'}`}>{d.ok?d.y:d.n}</span>
                      </div>
                    ))}
                  </div>

                  <div style={{textAlign:'center',padding:'7px',borderRadius:6,
                    border:`1px solid ${result.rec.cls==='tg'?'#064e1e':result.rec.cls==='tb'?'#0c2455':'#4d0f0f'}`,
                    background:result.rec.cls==='tg'?'#020a04':result.rec.cls==='tb'?'#03091a':'#0a0202'}}>
                    <div style={{fontSize:'.54rem',color:'#1e3a5f',marginBottom:2}}>KHUY·∫æN NGH·ªä</div>
                    <div style={{fontSize:'.95rem',fontWeight:900,color:result.rec.cls==='tg'?'#34d399':result.rec.cls==='tb'?'#60a5fa':'#f87171'}}>{result.rec.txt}</div>
                  </div>
                </>
              ) : (
                <div style={{textAlign:'center',padding:'40px',color:'#1e3a5f',fontSize:'.78rem'}}>Nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem KPI</div>
              )}
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê INVENTORY TAB ‚ïê‚ïê */}
        {tab==='inventory' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto'}}>
            <div style={{maxWidth:'1000px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1rem'}}>üì¶ T·ªìn kho chi ti·∫øt theo SKU</h2>
                  <p style={{fontSize:'.72rem',color:'#2a4055',marginTop:2}}>M·ªói d√≤ng = 1 SKU ƒë·∫ßy ƒë·ªß (alloy + temper + d√†y √ó r·ªông √ó d√†i) + tr·∫°ng th√°i IN_STOCK / IN_TRANSIT</p>
                </div>
                <button className="btn btn-ghost btn-sm" onClick={addInv} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m d√≤ng</button>
              </div>
              <table className="tbl" style={{background:'#060c17',borderRadius:8,overflow:'hidden'}}>
                <thead>
                  <tr>
                    <th>#</th>
                    <th style={{textAlign:'left',paddingLeft:4}}>SKU</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>S·ªë l∆∞·ª£ng kg</th>
                    <th>Gi√° v·ªën ƒë/kg</th>
                    <th>T·ªïng gi√° tr·ªã VND</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {inventory.map((r,i)=>(
                    <tr key={r.id}>
                      <td style={{textAlign:'center',color:'#1e3a5f',fontSize:'.68rem'}} className="mono">{i+1}</td>
                      <td style={{paddingLeft:4}}><SkuSel row={r} onChange={patch=>setInv(r.id,patch)}/></td>
                      <td style={{textAlign:'center',width:160}}>
                        <div style={{display:'flex',gap:3,justifyContent:'center'}}>
                          <button className={`status-btn ${r.status==='IN_STOCK'?'s-stock':'off'}`} style={{fontSize:'.6rem',padding:'2px 6px'}} onClick={()=>setInv(r.id,{status:'IN_STOCK'})}>üü¢ Kho</button>
                          <button className={`status-btn ${r.status==='IN_TRANSIT'?'s-transit':'off'}`} style={{fontSize:'.6rem',padding:'2px 6px'}} onClick={()=>setInv(r.id,{status:'IN_TRANSIT'})}>üü° ƒê∆∞·ªùng</button>
                        </div>
                      </td>
                      <td style={{width:100}}>
                        <input className="inp inp-xs mono" style={{textAlign:'right',color:'#34d399',fontWeight:700}} value={fv(r.qtyKg)} onChange={e=>setInv(r.id,{qtyKg:pn(e.target.value)})}/>
                      </td>
                      <td style={{width:110}}>
                        <input className="inp inp-xs mono" style={{textAlign:'right'}} value={fv(r.avgCost)} onChange={e=>setInv(r.id,{avgCost:pn(e.target.value)})}/>
                      </td>
                      <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#60a5fa',fontSize:'.72rem'}}>{fv(r.qtyKg*r.avgCost)}</td>
                      <td><button className="btn-danger" onClick={()=>delInv(r.id)}><Ic.X/></button></td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr>
                    <td colSpan={3} style={{textAlign:'right',paddingRight:8,color:'#2a4055',fontSize:'.62rem'}}>T·ªîNG</td>
                    <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#34d399'}}>{fv(inventory.reduce((s,r)=>s+r.qtyKg,0))} kg</td>
                    <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#94a3b8'}}>
                      {fv(weightedAvg(inventory.map(r=>({qtyKg:r.qtyKg,avgCost:r.avgCost}))))} ƒë/kg avg
                    </td>
                    <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#60a5fa'}}>{fv(inventory.reduce((s,r)=>s+r.qtyKg*r.avgCost,0))}</td>
                    <td/>
                  </tr>
                </tfoot>
              </table>

              {/* SKU summary cards */}
              <div style={{marginTop:14}}>
                <div style={{fontSize:'.68rem',fontWeight:800,color:'#1e3a5f',textTransform:'uppercase',letterSpacing:'.06em',marginBottom:8}}>
                  T√≥m t·∫Øt theo SKU (Kho + ƒê∆∞·ªùng pooled)
                </div>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(220px,1fr))',gap:'8px'}}>
                  {groupBySku(inventory).map(g=>{
                    const all = [...g.inStock,...g.inTransit];
                    const qtyS = g.inStock.reduce((s,r)=>s+r.qtyKg,0);
                    const qtyT = g.inTransit.reduce((s,r)=>s+r.qtyKg,0);
                    const avgAll = weightedAvg(all.map(r=>({qtyKg:r.qtyKg,avgCost:r.avgCost})));
                    return (
                      <div key={g.key} className="sku-card">
                        <div style={{fontWeight:800,fontSize:'.75rem',color:'#c4cfde',marginBottom:4}}>{g.label}</div>
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,marginBottom:5}}>
                          <div style={{background:'#040f08',border:'1px solid #064e1e',borderRadius:3,padding:'4px 6px'}}>
                            <div style={{fontSize:'.52rem',color:'#064e1e'}}>üü¢ Kho</div>
                            <div className="mono" style={{fontSize:'.8rem',fontWeight:700,color:'#34d399'}}>{fv(qtyS)} kg</div>
                          </div>
                          <div style={{background:'#140d00',border:'1px solid #4d3400',borderRadius:3,padding:'4px 6px'}}>
                            <div style={{fontSize:'.52rem',color:'#4d3400'}}>üü° ƒê∆∞·ªùng</div>
                            <div className="mono" style={{fontSize:'.8rem',fontWeight:700,color:'#fbbf24'}}>{fv(qtyT)} kg</div>
                          </div>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-between'}}>
                          <span style={{fontSize:'.6rem',color:'#2a4055'}}>T·ªïng <strong className="mono" style={{color:'#c4cfde'}}>{fv(qtyS+qtyT)} kg</strong></span>
                          <span style={{fontSize:'.6rem',color:'#2a4055'}}>BQ <strong className="mono" style={{color:'#60a5fa'}}>{fv(avgAll)} ƒë/kg</strong></span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê SELLING PRICES TAB ‚ïê‚ïê */}
        {tab==='selling' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto'}}>
            <div style={{maxWidth:'680px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1rem'}}>üè∑Ô∏è Gi√° b√°n theo m√°c nh√¥m</h2>
                  <p style={{fontSize:'.72rem',color:'#2a4055',marginTop:2}}>Format: "Alloy Temper" (VD: A5052 H32). Tra theo Alloy+Temper tr∆∞·ªõc ‚Üí Alloy ‚Üí m·∫∑c ƒë·ªãnh</p>
                </div>
                <button className="btn btn-ghost btn-sm" onClick={addSP} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Plus/> Th√™m</button>
              </div>
              <table className="tbl" style={{background:'#060c17',borderRadius:8,overflow:'hidden'}}>
                <thead><tr><th>#</th><th style={{textAlign:'left',paddingLeft:8}}>M√°c nh√¥m</th><th>Gi√° b√°n ƒë/kg</th><th>vs Gi√° Hƒê m·∫∑c ƒë·ªãnh</th><th></th></tr></thead>
                <tbody>
                  {sellingPrices.map((sp,i)=>{
                    const diff = sp.price - inputs.contractPrice;
                    return (
                      <tr key={sp.id}>
                        <td style={{textAlign:'center',color:'#1e3a5f',fontSize:'.68rem'}} className="mono">{i+1}</td>
                        <td style={{paddingLeft:8}}><input className="inp inp-sm" style={{width:150}} value={sp.alloy} onChange={e=>setSpR(sp.id,'alloy',e.target.value)}/></td>
                        <td style={{width:140}}><input className="inp inp-sm mono" style={{textAlign:'right',color:'#34d399',fontWeight:700}} value={fv(sp.price)} onChange={e=>setSpR(sp.id,'price',pn(e.target.value))}/></td>
                        <td style={{textAlign:'center'}}><span className={`tag ${diff>=0?'tg':'tr'} mono`}>{diff>=0?'+':''}{fv(diff)}</span></td>
                        <td><button className="btn-danger" onClick={()=>delSP(sp.id)}><Ic.X/></button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div className="card-inset" style={{marginTop:12}}>
                <p style={{fontSize:'.72rem',color:'#2a4055',lineHeight:1.7}}>
                  üí° Logic tra: <strong style={{color:'#60a5fa'}}>A5052 H32</strong> ‚Üí <strong style={{color:'#94a3b8'}}>A5052</strong> ‚Üí <strong style={{color:'#34d399'}}>Gi√° Hƒê m·∫∑c ƒë·ªãnh {fv(inputs.contractPrice)}</strong> ƒë/kg
                </p>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê SCENARIOS TAB ‚ïê‚ïê */}
        {tab==='scenario' && (
          <div style={{flex:1,padding:'18px',overflowY:'auto'}}>
            <div style={{maxWidth:'900px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                <div>
                  <h2 style={{fontWeight:900,fontSize:'1rem'}}>üíæ Scenarios l∆∞u tr·ªØ</h2>
                  <p style={{fontSize:'.72rem',color:'#2a4055',marginTop:2}}>So s√°nh c√°c ph∆∞∆°ng √°n nh·∫≠p h√†ng theo th·ªùi gian</p>
                </div>
                <button className="btn btn-success btn-sm" onClick={saveScenario} style={{display:'flex',alignItems:'center',gap:4}}><Ic.Save/> L∆∞u scenario</button>
              </div>
              {scenarios.length===0 ? (
                <div className="card" style={{textAlign:'center',padding:40,border:'1px dashed #162030'}}>
                  <div style={{fontSize:'2rem',marginBottom:10}}>üíæ</div>
                  <div style={{color:'#2a4055',fontWeight:700}}>Ch∆∞a c√≥ scenario</div>
                  <div style={{fontSize:'.72rem',color:'#1e3a5f',marginTop:6}}>Nh·∫•n "L∆∞u Scenario" sau khi nh·∫≠p ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu</div>
                </div>
              ) : (
                <table className="tbl" style={{background:'#060c17',borderRadius:8,overflow:'hidden'}}>
                  <thead>
                    <tr><th>#</th><th style={{textAlign:'left',paddingLeft:8}}>T√™n</th><th>KL</th><th>Invoice</th><th>BQ tr∆∞·ªõc</th><th>BQ sau</th><th>Break-even</th><th>R·ªßi ro</th><th></th></tr>
                  </thead>
                  <tbody>
                    {scenarios.map((s,i)=>(
                      <tr key={s.id}>
                        <td style={{textAlign:'center',color:'#1e3a5f',fontSize:'.68rem'}} className="mono">{i+1}</td>
                        <td style={{paddingLeft:8}}>
                          <div style={{fontWeight:700,fontSize:'.76rem',color:'#c4cfde'}}>{s.name}</div>
                          <div style={{fontSize:'.6rem',color:'#2a4055'}}>{s.date}</div>
                        </td>
                        <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#34d399'}}>{fv(s.totalKg)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#fbbf24'}}>{fu(s.invoiceUSD)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#94a3b8'}}>{fv(s.globalAvgBefore)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#60a5fa',fontWeight:700}}>{fv(s.globalAvgAfter)}</td>
                        <td className="mono" style={{textAlign:'right',paddingRight:8,color:'#c084fc'}}>{fv(s.globalBreakEven)}</td>
                        <td style={{textAlign:'center'}}><span className={`tag ${s.hasRisk?'tr':'tg'}`}>{s.hasRisk?'‚ö† R·ªßi ro':'‚úì An to√†n'}</span></td>
                        <td style={{textAlign:'center'}}>
                          <div style={{display:'flex',gap:3,justifyContent:'center'}}>
                            <button className="btn btn-solid btn-xs" onClick={()=>{setProducts(s.products);setInputs(s.inputs);setTab('main');}}>T·∫£i</button>
                            <button className="btn-danger" onClick={()=>setScenarios(p=>p.filter(x=>x.id!==s.id))}><Ic.X/></button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
