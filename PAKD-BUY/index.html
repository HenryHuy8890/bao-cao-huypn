<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAKD BUY 2.1 - Advanced Corporate Sourcing</title>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: {
                        corporate: { 900: '#0f172a', 800: '#1e293b', 600: '#334155', accent: '#3b82f6' },
                        stock: { light: '#f0f9ff', border: '#bae6fd', text: '#0369a1' },
                        batch: { light: '#f0fdf4', border: '#bbf7d0', text: '#15803d' }
                    }
                } 
            }
        }
    </script>

    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; font-size: 11pt; }
            @page { size: A4; margin: 1.0cm; }
            .print-container { display: block !important; }
            .screen-container { display: none !important; }
        }
        
        .print-container { display: none; font-family: 'Times New Roman', serif; color: #000; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
        .print-table th, .print-table td { border: 1px solid #333; padding: 5px; text-align: center; }
        .print-table th { background-color: #f3f4f6; font-weight: bold; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 5px 8px; font-size: 0.9rem; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .input-group-header { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #475569; padding-bottom: 4px; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const formatVND = (v) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(v);
        const formatUSD = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(v);
        const formatNum = (v) => new Intl.NumberFormat('vi-VN').format(v);
        const parseNum = (v) => parseFloat(v) || 0;

        // --- ICONS ---
        const Icons = {
            Exchange: () => <svg className="w-3 h-3 text-slate-400 mx-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>,
            Warehouse: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            Ship: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Briefcase: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
        };

        // --- DUAL UNIT INPUT COMPONENT (Kg <-> Ton) ---
        const DualPriceInput = ({ label, valuePerKg, onChange }) => {
            // valuePerKg is the source of truth
            const valKg = valuePerKg;
            const valTon = valuePerKg * 1000;

            const handleKgChange = (e) => onChange(parseNum(e.target.value));
            const handleTonChange = (e) => onChange(parseNum(e.target.value) / 1000);

            return (
                <div className="mb-2">
                    <label className="input-label">{label}</label>
                    <div className="flex items-center gap-1">
                        <div className="flex-1 relative">
                            <input type="text" value={valKg ? formatNum(valKg) : ''} onChange={(e) => handleKgChange({target: {value: e.target.value.replace(/\./g,'')}})} className="input-field pr-8 text-right font-medium" placeholder="0" />
                            <span className="absolute right-2 top-1.5 text-[10px] text-slate-400">đ/kg</span>
                        </div>
                        <Icons.Exchange />
                        <div className="flex-1 relative">
                            <input type="text" value={valTon ? formatNum(valTon) : ''} onChange={(e) => handleTonChange({target: {value: e.target.value.replace(/\./g,'')}})} className="input-field pr-8 text-right bg-slate-50 text-slate-600" placeholder="0" />
                            <span className="absolute right-2 top-1.5 text-[10px] text-slate-400">đ/tấn</span>
                        </div>
                    </div>
                </div>
            );
        };

        const DualWeightInput = ({ label, valueKg, onChange }) => {
            const valKg = valueKg;
            const valTon = valueKg / 1000;

            const handleKgChange = (e) => onChange(parseNum(e.target.value));
            const handleTonChange = (e) => onChange(parseNum(e.target.value) * 1000);

            return (
                <div className="mb-2">
                    <label className="input-label">{label}</label>
                    <div className="flex items-center gap-1">
                        <div className="flex-1 relative">
                            <input type="text" value={valKg ? formatNum(valKg) : ''} onChange={(e) => handleKgChange({target: {value: e.target.value.replace(/\./g,'')}})} className="input-field pr-6 text-right font-bold" />
                            <span className="absolute right-2 top-1.5 text-[10px] text-slate-400">kg</span>
                        </div>
                        <Icons.Exchange />
                        <div className="flex-1 relative">
                            <input type="text" value={valTon ? formatNum(valTon) : ''} onChange={(e) => handleTonChange({target: {value: e.target.value.replace(/\./g,'')}})} className="input-field pr-8 text-right bg-slate-50 text-slate-600" />
                            <span className="absolute right-2 top-1.5 text-[10px] text-slate-400">tấn</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const PAKD_BUY_V2_1 = () => {
            // 1. STATE
            const [inventory, setInventory] = useState({
                stockQty: 500000, stockAvgCost: 15800,
                transitQty: 100000, transitAvgCost: 15600
            });

            const [inputs, setInputs] = useState({
                supplierName: 'Yuwon Steel', origin: 'China', creator: 'Nguyễn Văn A',
                paymentMethod: 'LC',
                ttRatio: 100, capitalCostPercent: 6.5,
                lcMargin: 10, lcDays: 90, lcOpenFee: 0.2, lcInterest: 5.8,
                exchangeRate: 25450, // Tỷ giá
                managementFee: 3.0, // Hệ số quản lý %
                leadTime: 30, holdingTime: 60,
                freightTotal: 45000000, importTax: 0, processingCost: 200,
                contractPrice: 16500, marketPrice: 16200
            });

            const [product, setProduct] = useState({
                name: 'Thép cuộn HRC Q235',
                weight: 200000,
                priceFC: 575 // USD/TẤN
            });

            const [result, setResult] = useState({});
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // --- CORE ENGINE ---
            useEffect(() => {
                // 1. Tính giá trị Invoice quy đổi (Logic: priceFC là USD/Tấn)
                const invoiceUSD = (product.weight / 1000) * product.priceFC;
                const invoiceVND = invoiceUSD * inputs.exchangeRate;
                
                // 2. Tính giá sau Hệ số Quản lý (Management Value)
                // Logic: Giá này bao gồm Invoice + Overhead quản lý
                const landedValueHD = invoiceVND * (1 + inputs.managementFee / 100);
                const mgmtCostVND = landedValueHD - invoiceVND;
                
                // --- TÁCH BIỆT: GIÁ TRỊ HÀNG HÓA THUẦN (Dùng cho Bình Quân) ---
                const pureGoodsValueVND = landedValueHD;

                // 3. Tính các chi phí Logistics & Thuế & Tài chính (Cụ thể cho lô mới)
                const taxVND = invoiceVND * (inputs.importTax / 100); 
                const freightVND = inputs.freightTotal;
                const processingVND = inputs.processingCost * product.weight;

                let finCostVND = 0;
                const totalDays = inputs.leadTime + inputs.holdingTime;
                
                if (inputs.paymentMethod === 'TT') {
                    const cashOutflow = invoiceVND + taxVND + freightVND;
                    finCostVND = cashOutflow * (inputs.capitalCostPercent / 100) * (totalDays / 365);
                } else {
                    const openFee = invoiceVND * (inputs.lcOpenFee / 100);
                    const lcInterest = invoiceVND * (inputs.lcInterest / 100) * (inputs.lcDays / 365);
                    const equityUsed = (invoiceVND * inputs.lcMargin/100) + taxVND + freightVND;
                    const equityCost = equityUsed * (inputs.capitalCostPercent / 100) * (totalDays / 365);
                    finCostVND = openFee + lcInterest + equityCost;
                }

                // --- TÁCH BIỆT: CHI PHÍ RIÊNG CỦA LÔ MỚI (Không đẩy vào Bình Quân tồn kho cũ) ---
                const newBatchOnlyCostVND = taxVND + freightVND + processingVND + finCostVND;

                // 4. Tổng hợp Giá Vốn Lô Mới (Full Landed Cost per Kg) - Để xem xét hiệu quả lô này
                const newBatchFullCost = (pureGoodsValueVND + newBatchOnlyCostVND) / product.weight;

                // 5. ENGINE BÌNH QUÂN (Weighted Average) - LOGIC MỚI: CHỈ BÌNH QUÂN GIÁ TRỊ HÀNG
                const currentTotalQty = inventory.stockQty + inventory.transitQty;
                const currentTotalValue = (inventory.stockQty * inventory.stockAvgCost) + (inventory.transitQty * inventory.transitAvgCost);
                const currentAvgCost = currentTotalQty > 0 ? currentTotalValue / currentTotalQty : 0;

                const newTotalQty = currentTotalQty + product.weight;
                // QUAN TRỌNG: Chỉ cộng giá trị hàng hóa thuần vào kho, tránh "lây nhiễm" chi phí logs/tài chính lô mới sang tồn kho cũ
                const newTotalValue = currentTotalValue + pureGoodsValueVND; 
                const newAvgCost = newTotalValue / newTotalQty;
                
                const deltaCost = newAvgCost - currentAvgCost;

                // 6. Logic Khuyến nghị
                let recommendation = "", recColor = "";
                if (newAvgCost <= inputs.contractPrice) { recommendation = "NHẬP BẢO TOÀN"; recColor = "text-green-600"; }
                else if (newAvgCost <= inputs.marketPrice) { recommendation = "NHẬP CÂN BẰNG"; recColor = "text-blue-600"; }
                else { recommendation = "RỦI RO CAO"; recColor = "text-red-600"; }

                setResult({
                    invoiceVND, mgmtCostVND, newBatchFullCost, finCostVND,
                    currentTotalQty, currentAvgCost, newTotalQty, newAvgCost, deltaCost,
                    recommendation, recColor
                });

                updateChart(currentAvgCost, newBatchFullCost, newAvgCost);

            }, [inputs, inventory, product]);

            const updateChart = (oldAvg, newBatch, newAvg) => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Hiện tại', 'Lô Mới (Full)', 'SAU NHẬP (BQ)'],
                        datasets: [{
                            label: 'Giá Vốn (VND/kg)',
                            data: [oldAvg, newBatch, newAvg],
                            backgroundColor: ['#94a3b8', newBatch < oldAvg ? '#22c55e' : '#ef4444', '#4f46e5'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: false, min: Math.min(oldAvg, newBatch) * 0.95 } }
                    }
                });
            };

            const handleInvChange = (field, val) => setInventory({...inventory, [field]: val});
            const handleInputChange = (e) => setInputs({...inputs, [e.target.name]: parseFloat(e.target.value)||e.target.value});

            return (
                <div className="flex h-full font-sans screen-container">
                    {/* LEFT: INPUTS */}
                    <div className="w-1/3 bg-white border-r border-slate-200 h-full overflow-y-auto custom-scroll p-5 flex flex-col gap-6">
                        <div className="flex items-center gap-2 text-corporate-900 mb-2">
                            <Icons.Warehouse />
                            <div>
                                <h1 className="text-xl font-extrabold tracking-tight leading-none">PAKD BUY 2.1</h1>
                                <span className="text-[10px] font-semibold text-slate-400 uppercase tracking-wider">Corporate Inventory Strategy</span>
                            </div>
                        </div>

                        {/* A. HIỆN TRẠNG KHO */}
                        <div className="bg-stock-light border border-stock-border rounded-lg p-4 shadow-sm relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-blue-400 opacity-10 rounded-bl-full -mr-8 -mt-8"></div>
                            <div className="input-group-header text-stock-text"><Icons.Warehouse /> A. HIỆN TRẠNG KHO</div>
                            <DualWeightInput label="1. Tồn kho hiện hữu" valueKg={inventory.stockQty} onChange={v => handleInvChange('stockQty', v)} />
                            <DualPriceInput label="Giá vốn Tồn kho" valuePerKg={inventory.stockAvgCost} onChange={v => handleInvChange('stockAvgCost', v)} />
                            <div className="my-3 border-t border-stock-border"></div>
                            <DualWeightInput label="2. Hàng đang đi đường" valueKg={inventory.transitQty} onChange={v => handleInvChange('transitQty', v)} />
                            <DualPriceInput label="Giá vốn Hàng về" valuePerKg={inventory.transitAvgCost} onChange={v => handleInvChange('transitAvgCost', v)} />
                        </div>

                        {/* B. LÔ MUA MỚI */}
                        <div className="bg-batch-light border border-batch-border rounded-lg p-4 shadow-sm relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-green-400 opacity-10 rounded-bl-full -mr-8 -mt-8"></div>
                            <div className="input-group-header text-batch-text"><Icons.Ship /> B. LÔ MUA MỚI</div>
                            
                            <div className="mb-4">
                                <label className="input-label text-blue-700">Tỷ giá áp dụng (USD → VND)</label>
                                <div className="relative">
                                    <input type="text" value={formatNum(inputs.exchangeRate)} onChange={e => handleInputChange({target: {name: 'exchangeRate', value: e.target.value.replace(/\./g,'')}})} className="input-field text-lg font-bold text-blue-800 border-blue-300 bg-white shadow-sm pl-8" />
                                    <span className="absolute left-3 top-2 text-blue-400">$</span>
                                    <span className="absolute right-3 top-2 text-xs text-slate-400">VND</span>
                                </div>
                            </div>

                            <DualWeightInput label="Khối lượng mua" valueKg={product.weight} onChange={v => setProduct({...product, weight: v})} />
                            
                            <div className="grid grid-cols-2 gap-3 mb-3">
                                <div><label className="input-label">Giá Invoice (USD / TẤN)</label><input type="number" value={product.priceFC} onChange={e=>setProduct({...product, priceFC: parseFloat(e.target.value)})} className="input-field font-bold text-green-700" /></div>
                                <div title="Chi phí quản lý, rủi ro, overhead"><label className="input-label text-purple-700 cursor-help">Hệ số quản lý (%) ⓘ</label><input type="number" name="managementFee" value={inputs.managementFee} onChange={handleInputChange} className="input-field bg-purple-50 border-purple-200 text-purple-700 font-bold" /></div>
                            </div>

                            <div className="bg-white p-2 rounded border border-green-100 mb-3">
                                <div className="flex gap-2 mb-2">
                                    <button onClick={()=>setInputs({...inputs, paymentMethod:'TT'})} className={`flex-1 text-[10px] font-bold py-1 rounded border ${inputs.paymentMethod==='TT'?'bg-slate-700 text-white':'bg-slate-100 text-slate-500'}`}>T/T (Tiền mặt)</button>
                                    <button onClick={()=>setInputs({...inputs, paymentMethod:'LC'})} className={`flex-1 text-[10px] font-bold py-1 rounded border ${inputs.paymentMethod==='LC'?'bg-indigo-600 text-white':'bg-slate-100 text-slate-500'}`}>L/C (Tín dụng)</button>
                                </div>
                                {inputs.paymentMethod === 'LC' && (
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="text-[9px] font-bold text-slate-500">Margin %</label><input name="lcMargin" value={inputs.lcMargin} onChange={handleInputChange} className="input-field text-xs h-6 px-1 text-center" /></div>
                                        <div><label className="text-[9px] font-bold text-slate-500">Days</label><input name="lcDays" value={inputs.lcDays} onChange={handleInputChange} className="input-field text-xs h-6 px-1 text-center" /></div>
                                        <div><label className="text-[9px] font-bold text-slate-500">Int %</label><input name="lcInterest" value={inputs.lcInterest} onChange={handleInputChange} className="input-field text-xs h-6 px-1 text-center" /></div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="input-label">Cước + Logs (TỔNG CHO LÔ MỚI – VND)</label><input type="text" value={formatNum(inputs.freightTotal)} onChange={e => handleInputChange({target: {name:'freightTotal', value: e.target.value.replace(/\./g,'')}})} className="input-field text-xs" /></div>
                                <div><label className="input-label">Gia công (VND/kg)</label><input type="number" name="processingCost" value={inputs.processingCost} onChange={handleInputChange} className="input-field text-xs" /></div>
                            </div>
                        </div>

                        {/* C. THAM CHIẾU */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm">
                            <div className="input-group-header"><Icons.Briefcase /> C. THAM CHIẾU GIÁ BÁN</div>
                            <DualPriceInput label="Giá Hợp đồng / Kế hoạch" valuePerKg={inputs.contractPrice} onChange={v => setInputs({...inputs, contractPrice: v})} />
                            <DualPriceInput label="Giá Thị trường Spot" valuePerKg={inputs.marketPrice} onChange={v => setInputs({...inputs, marketPrice: v})} />
                        </div>
                    </div>

                    {/* RIGHT: DASHBOARD */}
                    <div className="w-2/3 bg-slate-100 h-full overflow-y-auto custom-scroll p-6 flex flex-col">
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-corporate-900">Chiến Lược Giá Vốn</h2>
                                <p className="text-sm text-slate-500">Phân tích tác động pha loãng giá vốn & rủi ro</p>
                            </div>
                            <button onClick={()=>window.print()} className="bg-corporate-800 text-white px-4 py-2 rounded shadow hover:bg-corporate-900 flex items-center gap-2 text-sm font-bold transition-all">
                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                                In Tờ Trình (A4)
                            </button>
                        </div>

                        {/* EXECUTIVE SUMMARY */}
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            {/* Current State */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-wide">Giá Vốn BQ Hiện Tại</div>
                                <div className="text-2xl font-bold text-slate-600 mt-1">{formatNum(result.currentAvgCost)}</div>
                                <div className="w-full bg-slate-100 h-1 mt-2 rounded overflow-hidden"><div className="bg-slate-400 h-full" style={{width: '100%'}}></div></div>
                            </div>

                            {/* The Deal */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center relative overflow-hidden">
                                <div className="text-xs font-bold text-green-600 uppercase tracking-wide">Giá Về Kho H&D (Lô Mới)</div>
                                <div className="text-2xl font-bold text-green-700 mt-1">{formatNum(result.newBatchFullCost)}</div>
                                <div className="text-[10px] text-slate-400 mt-1 italic">Đã gồm {inputs.managementFee}% phí quản lý</div>
                                <div className="absolute right-2 top-2 text-green-100"><Icons.Ship /></div>
                            </div>

                            {/* The Result */}
                            <div className="bg-corporate-800 text-white p-4 rounded-xl shadow-lg flex flex-col justify-center relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-xs font-bold text-indigo-300 uppercase tracking-wide">Giá Bình Quân Mới</div>
                                    <div className="text-3xl font-bold mt-1">{formatNum(result.newAvgCost)}</div>
                                    <div className="text-xs font-medium mt-1 text-indigo-200 flex items-center gap-1">
                                        {result.deltaCost > 0 ? <span className="bg-red-500/20 px-1 rounded">▲ Tăng {formatNum(result.deltaCost)}</span> : <span className="bg-green-500/20 px-1 rounded">▼ Giảm {formatNum(Math.abs(result.deltaCost))}</span>}
                                        <span>đ/kg</span>
                                    </div>
                                </div>
                                <div className="absolute -right-4 -bottom-4 w-24 h-24 bg-white opacity-5 rounded-full blur-xl"></div>
                            </div>
                        </div>

                        {/* CHARTS & DECISION */}
                        <div className="grid grid-cols-2 gap-6 flex-1">
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Biểu đồ Tác động Giá Vốn</h3>
                                <div className="flex-1 relative min-h-[200px]">
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </div>

                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Ma Trận Quyết Định</h3>
                                    
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center p-3 rounded bg-slate-50 border border-slate-100">
                                            <div>
                                                <div className="text-xs text-slate-500">So với Hợp đồng</div>
                                                <div className="font-bold text-slate-700">{formatNum(inputs.contractPrice)}</div>
                                            </div>
                                            <div className={`px-3 py-1 rounded text-xs font-bold ${result.newAvgCost <= inputs.contractPrice ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {result.newAvgCost <= inputs.contractPrice ? 'CÓ LÃI' : 'LỖ VỊ THẾ'}
                                            </div>
                                        </div>

                                        <div className="flex justify-between items-center p-3 rounded bg-slate-50 border border-slate-100">
                                            <div>
                                                <div className="text-xs text-slate-500">So với Thị trường</div>
                                                <div className="font-bold text-slate-700">{formatNum(inputs.marketPrice)}</div>
                                            </div>
                                            <div className={`px-3 py-1 rounded text-xs font-bold ${result.newAvgCost <= inputs.marketPrice ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}`}>
                                                {result.newAvgCost <= inputs.marketPrice ? 'CẠNH TRANH' : 'CAO HƠN TT'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className={`mt-6 text-center p-4 rounded-xl border-2 transition-colors ${result.recColor === 'text-green-600' ? 'bg-green-50 border-green-200' : result.recColor === 'text-blue-600' ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'}`}>
                                    <div className="text-[10px] font-bold uppercase tracking-widest opacity-60">Khuyến nghị Hệ thống</div>
                                    <div className={`text-2xl font-black mt-1 ${result.recColor}`}>{result.recommendation}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* PRINT TEMPLATE (HIDDEN) */}
                    <div className="print-container p-10 font-serif">
                        <div className="text-center border-b-2 border-black pb-4 mb-6">
                            <h1 className="text-2xl font-bold uppercase">TỜ TRÌNH CHIẾN LƯỢC NHẬP HÀNG (PAKD 2.1)</h1>
                            <p className="italic mt-1">Ngày: {new Date().toLocaleDateString('vi-VN')} | Tham chiếu: Quản trị Giá vốn Bình quân</p>
                        </div>

                        <div className="mb-6">
                            <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm">I. THÔNG SỐ ĐẦU VÀO</h3>
                            <div className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                                <div className="flex justify-between"><span>Nhà cung cấp:</span> <strong>{inputs.supplierName}</strong></div>
                                <div className="flex justify-between"><span>Sản phẩm:</span> <strong>{product.name}</strong></div>
                                <div className="flex justify-between"><span>Khối lượng mua:</span> <strong>{formatNum(product.weight)} kg</strong></div>
                                <div className="flex justify-between"><span>Giá Invoice:</span> <strong>{formatUSD(product.priceFC)}/tấn</strong></div>
                                <div className="flex justify-between text-blue-800"><span>Tỷ giá áp dụng:</span> <strong>{formatNum(inputs.exchangeRate)} VND</strong></div>
                                <div className="flex justify-between text-purple-800"><span>Hệ số quản lý:</span> <strong>{inputs.managementFee}%</strong></div>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm">II. PHÂN TÍCH GIÁ VỐN LÔ HÀNG (LANDED COST)</h3>
                            <table className="print-table">
                                <thead>
                                    <tr>
                                        <th>Khoản mục</th>
                                        <th>Diễn giải</th>
                                        <th>Giá trị (VND)</th>
                                        <th>Đơn giá (đ/kg)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td className="text-left font-bold">1. Giá trị Invoice quy đổi</td>
                                        <td className="text-left italic text-xs">{formatUSD(product.priceFC)} * {formatNum(inputs.exchangeRate)}</td>
                                        <td className="text-right">{formatNum(result.invoiceVND)}</td>
                                        <td className="text-right">{formatNum(result.invoiceVND/product.weight)}</td>
                                    </tr>
                                    <tr>
                                        <td className="text-left font-bold text-purple-800">2. Phí Quản lý ({inputs.managementFee}%)</td>
                                        <td className="text-left italic text-xs">Overhead & Rủi ro</td>
                                        <td className="text-right">{formatNum(result.mgmtCostVND)}</td>
                                        <td className="text-right">{formatNum(result.mgmtCostVND/product.weight)}</td>
                                    </tr>
                                    <tr>
                                        <td className="text-left font-bold">3. Logistics & Thuế</td>
                                        <td className="text-left italic text-xs">Thuế NK, Cước, Gia công</td>
                                        <td className="text-right">{formatNum((result.newBatchFullCost * product.weight) - result.invoiceVND - result.mgmtCostVND - result.finCostVND)}</td>
                                        <td className="text-right">{formatNum(((result.newBatchFullCost * product.weight) - result.invoiceVND - result.mgmtCostVND - result.finCostVND)/product.weight)}</td>
                                    </tr>
                                    <tr>
                                        <td className="text-left font-bold text-red-800">4. Chi phí Tài chính</td>
                                        <td className="text-left italic text-xs">Lãi vay / Chi phí vốn ({inputs.paymentMethod})</td>
                                        <td className="text-right">{formatNum(result.finCostVND)}</td>
                                        <td className="text-right">{formatNum(result.finCostVND/product.weight)}</td>
                                    </tr>
                                    <tr className="bg-green-100">
                                        <td className="text-left font-bold uppercase">TỔNG GIÁ VỐN VỀ KHO H&D</td>
                                        <td></td>
                                        <td className="text-right font-bold text-lg">{formatNum(result.newBatchFullCost * product.weight)}</td>
                                        <td className="text-right font-bold text-lg">{formatNum(result.newBatchFullCost)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-8">
                            <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm">III. TÁC ĐỘNG GIÁ BÌNH QUÂN DOANH NGHIỆP</h3>
                            <div className="flex justify-between items-center border p-4 bg-yellow-50">
                                <div className="text-center">
                                    <div className="text-xs uppercase text-gray-500">Giá Bình Quân TRƯỚC Nhập</div>
                                    <div className="font-bold text-xl">{formatNum(result.currentAvgCost)}</div>
                                </div>
                                <div className="text-2xl text-gray-400">➔</div>
                                <div className="text-center">
                                    <div className="text-xs uppercase text-gray-500">Giá Lô Mới Quy Đổi</div>
                                    <div className="font-bold text-xl text-blue-600">{formatNum(result.newBatchFullCost)}</div>
                                </div>
                                <div className="text-2xl text-gray-400">➔</div>
                                <div className="text-center border-2 border-blue-600 p-2 bg-white rounded">
                                    <div className="text-xs uppercase text-blue-800 font-bold">GIÁ BÌNH QUÂN SAU NHẬP</div>
                                    <div className="font-black text-2xl text-blue-800">{formatNum(result.newAvgCost)}</div>
                                </div>
                            </div>
                            <div className="mt-2 text-right italic text-sm">
                                Kết luận: Lô hàng này làm <span className="font-bold">{result.deltaCost > 0 ? 'TĂNG' : 'GIẢM'}</span> giá vốn bình quân của công ty {formatNum(Math.abs(result.deltaCost))} đ/kg.
                            </div>
                        </div>

                        <div className="flex justify-between text-center mt-12 pt-8">
                            <div className="w-1/3"><strong>Người Lập</strong><br/><br/>{inputs.creator}</div>
                            <div className="w-1/3"><strong>Trưởng Phòng Mua Hàng</strong><br/><br/>(Ký duyệt)</div>
                            <div className="w-1/3"><strong>Ban Giám Đốc</strong><br/><br/>(Phê duyệt)</div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PAKD_BUY_V2_1 />);
    </script>
</body>
</html>
