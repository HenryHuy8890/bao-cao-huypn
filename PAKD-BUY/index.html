<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAKD BUY 2.0 - Corporate Inventory Strategy</title>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: {
                        corporate: { 900: '#1e1b4b', 800: '#312e81', 600: '#4f46e5' },
                        stock: { light: '#e0f2fe', dark: '#0284c7' }, // Sky blue for stock
                        newbatch: { light: '#f0fdf4', dark: '#16a34a' } // Green for new batch
                    }
                } 
            }
        }
    </script>

    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; font-size: 11pt; }
            @page { size: A4; margin: 1.5cm; }
            .print-container { display: block !important; }
            .screen-container { display: none !important; }
        }
        
        .print-container { display: none; font-family: 'Times New Roman', serif; color: #000; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
        .print-table th, .print-table td { border: 1px solid #333; padding: 6px; text-align: center; }
        .print-table th { background-color: #f3f4f6; font-weight: bold; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 4px; padding: 5px 8px; font-size: 0.9rem; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        
        .section-header { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e2e8f0; color: #475569; display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const formatVND = (v) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(v);
        const formatUSD = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(v);
        const formatNum = (v) => new Intl.NumberFormat('vi-VN').format(v);
        const parseNum = (v) => parseFloat(v) || 0;

        // --- ICONS ---
        const Icons = {
            Warehouse: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            Ship: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Chart: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Print: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
        };

        // --- PRINT TEMPLATE (UPDATED FOR CORPORATE VIEW) ---
        const PrintTemplate = ({ inputs, inventory, product, result }) => {
            const today = new Date();
            return (
                <div className="print-container p-8">
                    <div className="text-center mb-6 border-b-2 border-black pb-4">
                        <h1 className="text-2xl font-bold uppercase mb-1">TỜ TRÌNH CHIẾN LƯỢC NHẬP HÀNG (PAKD 2.0)</h1>
                        <p className="italic">Ngày lập: {today.getDate()}/{today.getMonth()+1}/{today.getFullYear()} | Tham chiếu: Quản trị Giá vốn Bình quân</p>
                    </div>

                    <div className="grid grid-cols-2 gap-8 mb-6">
                        <div>
                            <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm">A. Hiện trạng Doanh nghiệp</h3>
                            <table className="w-full text-sm">
                                <tbody>
                                    <tr><td>Tồn kho hiện hữu:</td><td className="font-bold text-right">{formatNum(inventory.stockQty)} kg</td></tr>
                                    <tr><td>Giá vốn hiện tại:</td><td className="font-bold text-right">{formatNum(inventory.stockAvgCost)} đ/kg</td></tr>
                                    <tr><td>Hàng đang về:</td><td className="font-bold text-right">{formatNum(inventory.transitQty)} kg</td></tr>
                                    <tr className="bg-gray-100">
                                        <td className="font-bold">Tổng tài sản hàng hóa:</td>
                                        <td className="font-bold text-right">{formatNum(inventory.stockQty + inventory.transitQty)} kg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm">B. Đề xuất Mua mới</h3>
                            <table className="w-full text-sm">
                                <tbody>
                                    <tr><td>Nhà cung cấp:</td><td className="text-right">{inputs.supplierName}</td></tr>
                                    <tr><td>Sản phẩm:</td><td className="text-right">{product.name}</td></tr>
                                    <tr><td>Khối lượng mua:</td><td className="font-bold text-right">{formatNum(product.weight)} kg</td></tr>
                                    <tr className="bg-green-50">
                                        <td className="font-bold">Giá vốn Lô này (Về kho):</td>
                                        <td className="font-bold text-right text-green-800">{formatNum(result.newBatchFullCost)} đ/kg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="mb-8">
                        <h3 className="font-bold border-b border-gray-400 mb-2 uppercase text-sm text-center">C. Tác động & Quyết định (Impact Analysis)</h3>
                        <table className="print-table">
                            <thead>
                                <tr>
                                    <th>Chỉ số</th>
                                    <th>Trước khi nhập</th>
                                    <th>Sau khi nhập (Dự kiến)</th>
                                    <th>Thay đổi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td className="text-left font-semibold">1. Tổng Khối Lượng</td>
                                    <td>{formatNum(result.currentTotalQty)} kg</td>
                                    <td className="font-bold">{formatNum(result.newTotalQty)} kg</td>
                                    <td className="italic text-green-700">+ {formatNum(product.weight)}</td>
                                </tr>
                                <tr className="bg-yellow-50">
                                    <td className="text-left font-bold text-blue-900">2. GIÁ VỐN BÌNH QUÂN</td>
                                    <td className="font-bold text-lg">{formatNum(result.currentAvgCost)}</td>
                                    <td className="font-bold text-lg text-blue-800 border-2 border-blue-500">{formatNum(result.newAvgCost)}</td>
                                    <td className={`font-bold ${result.deltaCost < 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {result.deltaCost > 0 ? '+' : ''}{formatNum(result.deltaCost)}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div className="mt-4 border p-4 bg-gray-50">
                            <div className="font-bold underline mb-2">ĐÁNH GIÁ HIỆU QUẢ:</div>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span className="block text-gray-500">So với Giá Hợp đồng ({formatNum(inputs.contractPrice)}):</span>
                                    <span className={`font-bold ${result.newAvgCost <= inputs.contractPrice ? 'text-green-700' : 'text-red-700'}`}>
                                        {result.newAvgCost <= inputs.contractPrice ? 'ĐẠT (Có lãi)' : 'KHÔNG ĐẠT (Lỗ hợp đồng)'}
                                    </span>
                                </div>
                                <div>
                                    <span className="block text-gray-500">So với Giá Thị trường ({formatNum(inputs.marketPrice)}):</span>
                                    <span className={`font-bold ${result.newAvgCost <= inputs.marketPrice ? 'text-green-700' : 'text-red-700'}`}>
                                        {result.newAvgCost <= inputs.marketPrice ? 'CẠNH TRANH TỐT' : 'RỦI RO CAO'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between text-center mt-12 pt-8">
                        <div className="w-1/3"><strong>Người Lập</strong><br/><br/>{inputs.creator}</div>
                        <div className="w-1/3"><strong>Trưởng Phòng Mua Hàng</strong><br/><br/>(Ký duyệt)</div>
                        <div className="w-1/3"><strong>Ban Giám Đốc</strong><br/><br/>(Phê duyệt Chiến lược)</div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const PAKD_BUY_V2 = () => {
            // 1. STATE: KHO HÀNG (Inventory)
            const [inventory, setInventory] = useState({
                stockQty: 500000,
                stockAvgCost: 15800,
                transitQty: 100000,
                transitAvgCost: 15600
            });

            // 2. STATE: LÔ MUA MỚI (New Batch Params)
            const [inputs, setInputs] = useState({
                supplierName: 'Rizhao Steel', origin: 'China', creator: 'Nguyễn Văn A',
                // Payment & Finance
                paymentMethod: 'LC',
                ttRatio: 100, capitalCostPercent: 6.5,
                lcMargin: 10, lcDays: 90, lcOpenFee: 0.2, lcInterest: 5.8,
                // Logistics
                exchangeRate: 25450, leadTime: 30, holdingTime: 60, // Total cycle
                freightTotal: 45000000, importTax: 0, processingCost: 200,
                // Reference Prices
                contractPrice: 16500, // Giá đã ký với khách
                marketPrice: 16200    // Giá thị trường hiện tại
            });

            const [product, setProduct] = useState({
                name: 'Thép cuộn HRC Q235',
                weight: 200000,
                priceFC: 575 // USD
            });

            const [result, setResult] = useState({});
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // --- ENGINE BÌNH QUÂN (WEIGHTED AVERAGE ENGINE) ---
            useEffect(() => {
                // A. Tính Giá Vốn Lô Mới (Như v1.0)
                const totalBaseVND = product.weight * product.priceFC * inputs.exchangeRate;
                const priceBaseKg = totalBaseVND / product.weight;
                
                // Logistics & Tax
                const taxVND = totalBaseVND * (inputs.importTax / 100);
                const freightKg = inputs.freightTotal / product.weight;
                const importCostKg = (taxVND / product.weight) + freightKg;
                
                // Finance Cost (Cho lô mới)
                let finCostVND = 0;
                const totalDays = inputs.leadTime + inputs.holdingTime;
                
                if (inputs.paymentMethod === 'TT') {
                    finCostVND = totalBaseVND * (inputs.capitalCostPercent / 100) * (totalDays / 365);
                } else {
                    const openFee = totalBaseVND * (inputs.lcOpenFee / 100);
                    const lcInterest = totalBaseVND * (inputs.lcInterest / 100) * (inputs.lcDays / 365);
                    const marginCost = (totalBaseVND * inputs.lcMargin / 100) * (inputs.capitalCostPercent / 100) * (totalDays / 365);
                    let excessCost = 0;
                    if (totalDays > inputs.lcDays) {
                         excessCost = totalBaseVND * (7.0 / 100) * ((totalDays - inputs.lcDays) / 365); 
                    }
                    finCostVND = openFee + lcInterest + marginCost + excessCost;
                }
                const finCostKg = finCostVND / product.weight;

                // Giá vốn đầy đủ của lô mới (về đến kho + tài chính)
                const newBatchFullCost = priceBaseKg + importCostKg + inputs.processingCost + finCostKg;

                // B. ENGINE BÌNH QUÂN (THE NEW CORE)
                const currentTotalQty = inventory.stockQty + inventory.transitQty;
                const currentTotalValue = (inventory.stockQty * inventory.stockAvgCost) + (inventory.transitQty * inventory.transitAvgCost);
                const currentAvgCost = currentTotalQty > 0 ? currentTotalValue / currentTotalQty : 0;

                const newTotalQty = currentTotalQty + product.weight;
                const newTotalValue = currentTotalValue + (product.weight * newBatchFullCost);
                const newAvgCost = newTotalValue / newTotalQty;

                const deltaCost = newAvgCost - currentAvgCost;

                // C. RECOMMENDATION LOGIC
                let recommendation = "";
                let recColor = "";
                
                if (newAvgCost <= inputs.contractPrice) {
                    recommendation = "NHẬP BẢO TOÀN"; // Lời so với HĐ
                    recColor = "text-green-600";
                } else if (newAvgCost <= inputs.marketPrice) {
                    recommendation = "NHẬP CÂN BẰNG"; // Cạnh tranh được
                    recColor = "text-blue-600";
                } else {
                    // Nếu giá BQ cao hơn thị trường -> Xem xét có bị đứt hàng không
                    recommendation = "RỦI RO CAO";
                    recColor = "text-red-600";
                }

                setResult({
                    newBatchFullCost, finCostKg,
                    currentTotalQty, currentAvgCost,
                    newTotalQty, newAvgCost,
                    deltaCost, recommendation, recColor
                });

                // D. UPDATE CHART
                updateChart(currentAvgCost, newBatchFullCost, newAvgCost);

            }, [inputs, inventory, product]);

            const updateChart = (oldAvg, newBatch, newAvg) => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Giá vốn Hiện tại', 'Giá Lô Mới', 'GIÁ BÌNH QUÂN SAU NHẬP'],
                        datasets: [{
                            label: 'VND/kg',
                            data: [oldAvg, newBatch, newAvg],
                            backgroundColor: [
                                '#94a3b8', // Slate 400
                                newBatch < oldAvg ? '#22c55e' : '#ef4444', // Green if cheap, Red if expensive
                                '#4f46e5'  // Corporate Indigo
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'TÁC ĐỘNG PHA LOÃNG GIÁ VỐN' }
                        },
                        scales: {
                            y: { beginAtZero: false, min: Math.min(oldAvg, newBatch) * 0.9 }
                        }
                    }
                });
            };

            const handleInvChange = (e) => setInventory({...inventory, [e.target.name]: parseFloat(e.target.value)||0});
            const handleInputChange = (e) => setInputs({...inputs, [e.target.name]: parseFloat(e.target.value)||e.target.value});

            return (
                <div className="flex h-full screen-container font-sans">
                    {/* --- LEFT: INPUTS --- */}
                    <div className="w-1/3 bg-slate-50 border-r border-slate-200 h-full overflow-y-auto custom-scroll p-5 flex flex-col gap-6">
                        <div className="flex items-center gap-2 text-corporate-900">
                            <Icons.Warehouse />
                            <h1 className="text-xl font-bold tracking-tight">PAKD BUY 2.0 <span className="text-xs font-normal text-slate-500 block">Corporate Inventory Engine</span></h1>
                        </div>

                        {/* A. INVENTORY STATE (NEW) */}
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-blue-400">
                            <div className="section-header">A. Hiện Trạng Kho (Cốt Lõi)</div>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="input-label">Tồn kho Thực (Kg)</label><input type="number" name="stockQty" value={inventory.stockQty} onChange={handleInvChange} className="input-field font-bold" /></div>
                                    <div><label className="input-label">Giá vốn BQ (VND)</label><input type="number" name="stockAvgCost" value={inventory.stockAvgCost} onChange={handleInvChange} className="input-field" /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="input-label text-slate-500">Hàng đang về (Kg)</label><input type="number" name="transitQty" value={inventory.transitQty} onChange={handleInvChange} className="input-field bg-slate-50" /></div>
                                    <div><label className="input-label text-slate-500">Giá vốn Về (VND)</label><input type="number" name="transitAvgCost" value={inventory.transitAvgCost} onChange={handleInvChange} className="input-field bg-slate-50" /></div>
                                </div>
                            </div>
                        </div>

                        {/* B. NEW BATCH */}
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-green-400">
                            <div className="section-header">B. Lô Mua Mới (Batch)</div>
                            <div className="space-y-3">
                                <div><label className="input-label">Tên hàng</label><input type="text" value={product.name} onChange={e=>setProduct({...product, name: e.target.value})} className="input-field" /></div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="input-label">Khối lượng Mua</label><input type="number" value={product.weight} onChange={e=>setProduct({...product, weight: parseFloat(e.target.value)})} className="input-field font-bold text-green-700" /></div>
                                    <div><label className="input-label">Giá Invoice (USD)</label><input type="number" value={product.priceFC} onChange={e=>setProduct({...product, priceFC: parseFloat(e.target.value)})} className="input-field" /></div>
                                </div>
                                
                                <div className="pt-2 border-t border-dashed">
                                    <div className="flex gap-2 mb-2">
                                        <button onClick={()=>setInputs({...inputs, paymentMethod:'TT'})} className={`text-xs px-2 py-1 rounded border ${inputs.paymentMethod==='TT'?'bg-blue-600 text-white':'bg-gray-100'}`}>T/T</button>
                                        <button onClick={()=>setInputs({...inputs, paymentMethod:'LC'})} className={`text-xs px-2 py-1 rounded border ${inputs.paymentMethod==='LC'?'bg-indigo-600 text-white':'bg-gray-100'}`}>L/C</button>
                                    </div>
                                    {inputs.paymentMethod === 'LC' ? (
                                        <div className="grid grid-cols-3 gap-2 text-xs">
                                            <div><label>Margin %</label><input name="lcMargin" value={inputs.lcMargin} onChange={handleInputChange} className="input-field h-6 px-1" /></div>
                                            <div><label>Days</label><input name="lcDays" value={inputs.lcDays} onChange={handleInputChange} className="input-field h-6 px-1" /></div>
                                            <div><label>Int %</label><input name="lcInterest" value={inputs.lcInterest} onChange={handleInputChange} className="input-field h-6 px-1" /></div>
                                        </div>
                                    ) : (
                                        <div className="text-xs text-gray-500 italic">Sử dụng vốn tự có (Chi phí cơ hội {inputs.capitalCostPercent}%)</div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* C. REFERENCES */}
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                            <div className="section-header">C. Tham Chiếu Thị Trường</div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="input-label text-orange-600">Giá Hợp Đồng Đã Ký</label><input type="number" name="contractPrice" value={inputs.contractPrice} onChange={handleInputChange} className="input-field font-bold text-orange-700 bg-orange-50" /></div>
                                <div><label className="input-label text-green-600">Giá Thị trường Spot</label><input type="number" name="marketPrice" value={inputs.marketPrice} onChange={handleInputChange} className="input-field font-bold text-green-700 bg-green-50" /></div>
                            </div>
                        </div>
                    </div>

                    {/* --- RIGHT: DASHBOARD --- */}
                    <div className="w-2/3 bg-slate-100 h-full overflow-y-auto custom-scroll p-6">
                        
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-corporate-900">Bảng Điều Khiển Chiến Lược</h2>
                                <p className="text-sm text-slate-500">Phân tích tác động của lô hàng mới lên giá vốn toàn công ty</p>
                            </div>
                            <button onClick={()=>window.print()} className="bg-corporate-800 text-white px-4 py-2 rounded shadow hover:bg-corporate-900 flex items-center gap-2 text-sm font-bold">
                                <Icons.Print /> In Tờ Trình
                            </button>
                        </div>

                        {/* 1. BIG NUMBERS: IMPACT ANALYSIS */}
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            {/* CURRENT */}
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 opacity-70">
                                <div className="text-xs font-bold text-slate-500 uppercase">Giá Vốn Hiện Tại</div>
                                <div className="text-2xl font-bold text-slate-700 mt-1">{formatNum(result.currentAvgCost)}</div>
                                <div className="text-xs mt-1">Tổng kho: {formatNum(result.currentTotalQty)} kg</div>
                            </div>
                            
                            {/* NEW BATCH */}
                            <div className={`p-5 rounded-xl shadow-sm border-2 ${result.newBatchFullCost < result.currentAvgCost ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400'}`}>
                                <div className={`text-xs font-bold uppercase ${result.newBatchFullCost < result.currentAvgCost ? 'text-green-700' : 'text-red-700'}`}>Giá Lô Mới (Landed)</div>
                                <div className="text-2xl font-bold mt-1">{formatNum(result.newBatchFullCost)}</div>
                                <div className="text-xs mt-1">
                                    {result.newBatchFullCost < result.currentAvgCost ? '▼ Rẻ hơn giá kho' : '▲ Đắt hơn giá kho'}
                                </div>
                            </div>

                            {/* RESULT BLENDED */}
                            <div className="bg-corporate-800 text-white p-5 rounded-xl shadow-lg relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-xs font-bold text-indigo-200 uppercase flex items-center gap-1">
                                        <Icons.Chart /> Giá Bình Quân Mới
                                    </div>
                                    <div className="text-3xl font-bold mt-1">{formatNum(result.newAvgCost)}</div>
                                    <div className="text-sm mt-1 font-medium text-indigo-200">
                                        {result.deltaCost > 0 ? `▲ Tăng ${formatNum(result.deltaCost)} đ/kg` : `▼ Giảm ${formatNum(Math.abs(result.deltaCost))} đ/kg`}
                                    </div>
                                </div>
                                {/* Background decoration */}
                                <div className="absolute right-0 top-0 h-full w-16 bg-white opacity-5 transform skew-x-12"></div>
                            </div>
                        </div>

                        {/* 2. CHART & DECISION MATRIX */}
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            
                            {/* CHART */}
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 h-64 flex flex-col">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Biểu đồ Tác động Giá</h3>
                                <div className="flex-1 relative">
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </div>

                            {/* DECISION */}
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Kết luận Quản trị</h3>
                                    
                                    {/* Scenario 1: Contract */}
                                    <div className="flex justify-between items-center mb-3 pb-3 border-b border-dashed">
                                        <span className="text-sm text-slate-600">Vs. Hợp đồng ({formatNum(inputs.contractPrice)})</span>
                                        {result.newAvgCost <= inputs.contractPrice ? (
                                            <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">✅ BẢO TOÀN LÃI</span>
                                        ) : (
                                            <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold">⚠️ LỖ HỢP ĐỒNG</span>
                                        )}
                                    </div>
                                    
                                    {/* Scenario 2: Market */}
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-slate-600">Vs. Thị trường ({formatNum(inputs.marketPrice)})</span>
                                        {result.newAvgCost <= inputs.marketPrice ? (
                                            <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">✅ CẠNH TRANH</span>
                                        ) : (
                                            <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold">⚠️ RỦI RO CAO</span>
                                        )}
                                    </div>
                                </div>

                                <div className={`mt-4 text-center p-3 rounded-lg border-2 ${result.recColor === 'text-green-600' ? 'bg-green-50 border-green-200' : result.recColor === 'text-blue-600' ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'}`}>
                                    <div className="text-xs text-slate-500 uppercase">Khuyến nghị Hệ thống</div>
                                    <div className={`text-xl font-bold ${result.recColor}`}>{result.recommendation}</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    {/* HIDDEN PRINT */}
                    <PrintTemplate inputs={inputs} inventory={inventory} product={product} result={result} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PAKD_BUY_V2 />);
    </script>
</body>
</html>
