<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAKD BUY 3.0 ‚Äì Advanced Aluminum Import Strategy</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#070c14;color:#c9d4e8;height:100vh;overflow:hidden;}
.mono{font-family:'JetBrains Mono',monospace;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:#0d1520;}
::-webkit-scrollbar-thumb{background:#1e2d45;border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:#2a3f5f;}

/* Inputs */
.inp{width:100%;background:#0d1824;border:1px solid #1a2d45;color:#c9d4e8;border-radius:4px;padding:5px 8px;font-size:0.8rem;transition:border-color .15s,box-shadow .15s;font-family:'Inter',sans-serif;}
.inp:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15);}
.inp.mono-inp{font-family:'JetBrains Mono',monospace;}
.inp-xs{padding:3px 6px;font-size:0.72rem;}
.inp-sm{padding:4px 7px;font-size:0.77rem;}
select.inp option{background:#0d1824;color:#c9d4e8;}
.inp[readonly]{background:#080e18;color:#4a5e78;cursor:not-allowed;}

/* Labels */
.lbl{display:block;font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#4a6080;margin-bottom:3px;}
.lbl-accent{color:#3b82f6;}

/* Cards */
.card{background:#0d1824;border:1px solid #162030;border-radius:8px;padding:12px;}
.card-dark{background:#080e18;border:1px solid #111e2d;border-radius:8px;padding:12px;}

/* Section headers */
.sh{font-size:.6rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#3a5070;border-bottom:1px solid #111e2d;padding-bottom:6px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:5px;font-size:.75rem;font-weight:700;cursor:pointer;border:none;transition:all .15s;}
.btn-ghost{background:transparent;border:1px dashed #1a3050;color:#3b82f6;}
.btn-ghost:hover{background:#0d1f35;border-color:#2563eb;}
.btn-solid{background:#1d3557;color:#93c5fd;border:1px solid #2563eb;}
.btn-solid:hover{background:#2563eb;color:#fff;}
.btn-danger{background:transparent;border:none;color:#2d4060;padding:2px 6px;cursor:pointer;border-radius:3px;font-size:.8rem;}
.btn-danger:hover{color:#f87171;background:#3b0f0f22;}
.btn-sm{padding:3px 8px;font-size:.68rem;}
.btn-success{background:#0f2d1a;border:1px solid #166534;color:#4ade80;}
.btn-success:hover{background:#166534;color:#fff;}
.btn-warn{background:#1a1a00;border:1px solid #713f12;color:#fbbf24;}
.btn-warn:hover{background:#713f12;color:#fff;}

/* Tabs */
.tab{padding:7px 14px;font-size:.72rem;font-weight:700;cursor:pointer;border-radius:5px 5px 0 0;border:1px solid transparent;border-bottom:none;color:#4a6080;transition:all .15s;}
.tab.active{background:#0d1824;border-color:#162030;color:#93c5fd;}
.tab:not(.active):hover{color:#7ea8d0;}

/* Tags */
.tag{display:inline-flex;align-items:center;padding:1px 7px;border-radius:3px;font-size:.62rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.tag-g{background:#052a14;color:#4ade80;border:1px solid #14532d;}
.tag-r{background:#2a0505;color:#f87171;border:1px solid #7f1d1d;}
.tag-b{background:#05153a;color:#60a5fa;border:1px solid #1e3a5f;}
.tag-y{background:#1a1500;color:#fbbf24;border:1px solid #713f12;}
.tag-p{background:#1a0528;color:#c084fc;border:1px solid #6b21a8;}

/* Tables */
.tbl{width:100%;border-collapse:collapse;font-size:.78rem;}
.tbl th{background:#080e18;color:#3a5070;font-size:.58rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;padding:6px 8px;text-align:center;border-bottom:1px solid #111e2d;white-space:nowrap;}
.tbl td{padding:3px 4px;border-bottom:1px solid #0d1520;vertical-align:middle;}
.tbl tbody tr:hover td{background:#0a1220;}
.tbl tfoot td{border-top:1px solid #1e3a5f;font-weight:700;padding:6px 8px;}

/* Sensitivity chart wrapper */
.chart-wrap{position:relative;width:100%;border-radius:6px;overflow:hidden;background:#080e18;border:1px solid #111e2d;}

/* Tooltip */
[data-tip]{position:relative;}
[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:#0d1824;border:1px solid #1a2d45;color:#93c5fd;padding:4px 8px;border-radius:4px;font-size:.65rem;white-space:nowrap;z-index:100;pointer-events:none;}

/* KPI */
.kpi{padding:10px 12px;background:#080e18;border:1px solid #111e2d;border-radius:6px;}
.kpi-v{font-size:1.3rem;font-weight:800;line-height:1.1;font-family:'JetBrains Mono',monospace;}
.kpi-l{font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#3a5070;margin-bottom:3px;}
.kpi-s{font-size:.63rem;color:#3a5070;margin-top:2px;}

/* Scenario pill */
.scenario-pill{background:#080e18;border:1px solid #1a2d45;border-radius:6px;padding:8px 10px;cursor:pointer;transition:all .15s;}
.scenario-pill:hover{border-color:#2563eb;}
.scenario-pill.active{border-color:#2563eb;background:#05153a;}

/* Print */
@media print{
  .no-print{display:none!important;}
  body{background:#fff;color:#000;overflow:auto;height:auto;}
  .print-show{display:block!important;}
  .card,.card-dark{background:#fff;border:1px solid #ccc;}
}
.print-show{display:none;}

/* Sensitivity row hover */
.sens-row:hover{background:#0a1422;}

/* Range input */
input[type=range]{-webkit-appearance:none;height:4px;border-radius:2px;background:#1a2d45;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#2563eb;cursor:pointer;}
</style>
</head>
<body>
<div id="root" style="height:100vh;display:flex;flex-direction:column;overflow:hidden;"></div>

<script type="text/babel">
const {useState, useEffect, useRef, useMemo, useCallback} = React;

// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ALLOYS = ["A1050 H14","A1050 O","A1060 H14","A3003 H14","A3003 CT H16","A3105 H14","A5052 H32","A5052 H34","A5083 H111","A6061 T6","A6063 T5","Kh√°c"];
const THICK  = ["0.4mm","0.5mm","0.6mm","0.7mm","0.8mm","0.9mm","1.0mm","1.2mm","1.5mm","2.0mm","2.5mm","3.0mm","4.0mm","5.0mm","6.0mm"];
const WIDTHS = ["600mm","800mm","1000mm","1200mm","1220mm","1250mm","1500mm","1524mm","Cu·ªôn","T·∫•m","Kh√°c"];

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fv  = v => isNaN(v)||!isFinite(v) ? '0' : new Intl.NumberFormat('vi-VN').format(Math.round(v));
const fu  = v => isNaN(v)||!isFinite(v) ? '$0' : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:1}).format(v);
const pct = v => (v>=0?'+':'')+v.toFixed(1)+'%';
const pn  = s => parseFloat(String(s).replace(/\./g,'').replace(/,/g,''))||0;
const uid = () => Date.now()+Math.random();

// ‚îÄ‚îÄ‚îÄ ENGINE (pure functions ‚Äì testable, no side effects) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const calcInvoice = (products, exchangeRate) => {
  const usd = products.reduce((s,p)=>(s + (p.weight/1000)*p.priceFC), 0);
  return { invoiceUSD: usd, invoiceVND: usd * exchangeRate };
};

const calcLanded = (invoiceVND, totalWeight, inputs) => {
  const {managementFee, importTax, freightTotal, processingCost} = inputs;
  const mgmt = invoiceVND * (managementFee/100);
  const tax  = invoiceVND * (importTax/100);
  const freight = Math.max(0, freightTotal);
  const proc = processingCost * totalWeight;
  const total = invoiceVND + mgmt + tax + freight + proc;
  return { mgmtVND:mgmt, taxVND:tax, freightVND:freight, procVND:proc,
           landedVND:total, landedPerKg: totalWeight>0 ? total/totalWeight : 0 };
};

const calcFinance = (invoiceVND, landed, totalWeight, inputs) => {
  const {paymentMethod, capitalCostPercent, lcMargin, lcDays, lcOpenFee, lcInterest, leadTime, holdingTime} = inputs;
  const days = leadTime + holdingTime;
  let fin = 0;
  if (paymentMethod==='TT') {
    fin = (invoiceVND + landed.taxVND + landed.freightVND) * (capitalCostPercent/100) * (days/365);
  } else {
    const openFee = invoiceVND * (lcOpenFee/100);
    const intLC   = invoiceVND * (lcInterest/100) * (lcDays/365);
    const equity  = (invoiceVND*lcMargin/100) + landed.taxVND + landed.freightVND;
    fin = openFee + intLC + equity*(capitalCostPercent/100)*(days/365);
  }
  return { finVND:fin, finPerKg: totalWeight>0 ? fin/totalWeight : 0 };
};

const calcInventoryBlend = (invRows, landedVND, totalWeight) => {
  const totalStockQty = invRows.reduce((s,r)=>s+r.qty, 0);
  const totalStockVal = invRows.reduce((s,r)=>s+r.qty*r.avgCost, 0);
  const curAvg = totalStockQty>0 ? totalStockVal/totalStockQty : 0;
  const newQty = totalStockQty + totalWeight;
  const newVal = totalStockVal + landedVND;
  const newAvg = newQty>0 ? newVal/newQty : 0;
  return { totalStockQty, curAvg, newQty, newAvg, delta: newAvg-curAvg };
};

const calcProfit = (economicCost, inputs) => {
  const {lendingRate, customerCreditDays, businessRiskPercent, contractPrice} = inputs;
  const custFin  = economicCost * (lendingRate/100) * (customerCreditDays/365);
  const breakEven = economicCost + custFin;
  const sellRisk = contractPrice * (1 - businessRiskPercent/100);
  const realProfit = sellRisk - economicCost - custFin;
  return { custFin, breakEven, sellRisk, realProfit };
};

// Per-product breakdown (for table display)
const calcRowBreakdown = (products, invoiceVND, totalWeight, landed, inputs) => {
  return products.map(p => {
    const rowInv = (p.weight/1000)*p.priceFC*inputs.exchangeRate;
    const rowRatio = totalWeight>0 ? p.weight/totalWeight : 0;
    const rowMgmt = rowInv*(inputs.managementFee/100);
    const rowTax  = rowInv*(inputs.importTax/100);
    const rowFreight = landed.freightVND * rowRatio;
    const rowProc = inputs.processingCost*p.weight;
    const rowLanded = rowInv+rowMgmt+rowTax+rowFreight+rowProc;
    const perKg = p.weight>0 ? rowLanded/p.weight : 0;
    // Per-alloy selling price
    const sp = inputs.sellingPrices?.find(s=>s.alloy===p.alloy);
    const sellPrice = sp ? sp.price : inputs.contractPrice;
    return {...p, rowInv, rowLanded, perKg, sellPrice};
  });
};

// Sensitivity: vary one param
const runSensitivity = (baseInputs, baseProducts, baseInv, param, steps) => {
  return steps.map(delta => {
    const inp = {...baseInputs};
    const prods = baseProducts.map(p=>({...p}));
    if (param==='exchangeRate') inp.exchangeRate = baseInputs.exchangeRate * (1 + delta/100);
    if (param==='priceFC') prods.forEach(p=>{ p.priceFC = p.priceFC*(1+delta/100); });
    if (param==='freightTotal') inp.freightTotal = baseInputs.freightTotal*(1+delta/100);
    if (param==='managementFee') inp.managementFee = baseInputs.managementFee + delta*0.5;

    const totalW = prods.reduce((s,p)=>s+p.weight,0);
    const inv = calcInvoice(prods, inp.exchangeRate);
    const land = calcLanded(inv.invoiceVND, totalW, inp);
    const fin  = calcFinance(inv.invoiceVND, land, totalW, inp);
    const blend = calcInventoryBlend(baseInv, land.landedVND, totalW);
    const profit = calcProfit(land.landedPerKg + fin.finPerKg, inp);
    return { delta, newAvg: blend.newAvg, breakEven: profit.breakEven, realProfit: profit.realProfit };
  });
};

// ‚îÄ‚îÄ‚îÄ DEFAULT STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const defaultInventory = [
  {id:1, alloy:'A5052 H32', thickness:'1.0mm', qty:800,  avgCost:102000},
  {id:2, alloy:'A3003 H14', thickness:'0.8mm', qty:400,  avgCost: 96000},
  {id:3, alloy:'A1050 H14', thickness:'1.2mm', qty:200,  avgCost: 93000},
];

const defaultSellingPrices = [
  {id:1, alloy:'A5052 H32', price:107000},
  {id:2, alloy:'A3003 H14', price:101000},
  {id:3, alloy:'A1050 H14', price: 97000},
  {id:4, alloy:'A5052 H34', price:108000},
  {id:5, alloy:'A6061 T6',  price:112000},
];

const defaultInputs = {
  supplierName:'Yuwon Steel', creator:'Nguy·ªÖn VƒÉn A',
  paymentMethod:'LC',
  capitalCostPercent:6.5,
  lcMargin:10, lcDays:90, lcOpenFee:0.2, lcInterest:5.8,
  exchangeRate:26150,
  managementFee:1.0,
  leadTime:30, holdingTime:60,
  freightTotal:45000000, importTax:0, processingCost:200,
  contractPrice:102000, marketPrice:99500,
  businessRiskPercent:2.0, customerCreditDays:30, lendingRate:12.0,
};

const defaultProducts = [
  {id:1, alloy:'A5052 H32', thickness:'1.0mm', width:'1200mm', weight:3000, priceFC:4120},
  {id:2, alloy:'A3003 H14', thickness:'0.8mm', width:'1000mm', weight:2000, priceFC:3980},
];

const SENS_STEPS = [-6,-4,-2,0,2,4,6];
const SENS_PARAMS = [
  {key:'exchangeRate', label:'T·ª∑ gi√° USD/VND', unit:'%'},
  {key:'priceFC',      label:'Gi√° nh√¥m LME',   unit:'%'},
  {key:'freightTotal', label:'C∆∞·ªõc v·∫≠n chuy·ªÉn', unit:'%'},
  {key:'managementFee',label:'Ph√≠ qu·∫£n l√Ω',    unit:'√ó0.5%'},
];

// ‚îÄ‚îÄ‚îÄ CHART HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHART_DEFAULTS = {
  responsive:true, maintainAspectRatio:false,
  plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fv(c.parsed.y)+' ƒë/kg'}}},
  scales:{
    x:{grid:{color:'#111e2d'},ticks:{color:'#3a5070',font:{size:10}}},
    y:{grid:{color:'#111e2d'},ticks:{color:'#3a5070',font:{size:10},callback:v=>fv(v)}}
  }
};

// ‚îÄ‚îÄ‚îÄ SMALL COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Icon = {
  Plus:  ()=><svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>,
  Trash: ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
  Box:   ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
  Ship:  ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
  Chart: ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
  Save:  ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>,
  Refresh:()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
  Tag:   ()=><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
};

// ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const App = () => {
  const [tab, setTab]         = useState('main');
  const [inputs, setInputs]   = useState(defaultInputs);
  const [products, setProducts] = useState(defaultProducts);
  const [inventory, setInventory] = useState(defaultInventory);
  const [sellingPrices, setSellingPrices] = useState(defaultSellingPrices);
  const [scenarios, setScenarios] = useState([]);
  const [sensParam, setSensParam] = useState('exchangeRate');

  const chartBarRef  = useRef(null);
  const chartSensRef = useRef(null);
  const chartBarInst = useRef(null);
  const chartSensInst= useRef(null);

  const setInp = useCallback((f,v) => setInputs(p=>({...p,[f]:v})), []);

  // ‚îÄ‚îÄ‚îÄ COMPUTE (useMemo ‚Äì only re-runs when deps change) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const result = useMemo(()=>{
    const totalWeight = products.reduce((s,p)=>s+p.weight,0);
    if (totalWeight<=0) return null;

    const inpWithSP = {...inputs, sellingPrices};
    const inv  = calcInvoice(products, inputs.exchangeRate);
    const land = calcLanded(inv.invoiceVND, totalWeight, inputs);
    const fin  = calcFinance(inv.invoiceVND, land, totalWeight, inputs);
    const blend = calcInventoryBlend(inventory, land.landedVND, totalWeight);
    const econCost = land.landedPerKg + fin.finPerKg;
    const profit = calcProfit(econCost, inputs);
    const rows = calcRowBreakdown(products, inv.invoiceVND, totalWeight, land, inpWithSP);

    const rec = blend.newAvg <= inputs.contractPrice ? {txt:'NH·∫¨P B·∫¢O TO√ÄN', cls:'tag-g'}
              : blend.newAvg <= inputs.marketPrice   ? {txt:'NH·∫¨P C√ÇN B·∫∞NG', cls:'tag-b'}
              : {txt:'R·ª¶I RO CAO', cls:'tag-r'};

    return {
      totalWeight, ...inv, ...land, ...fin, ...blend,
      econCost, ...profit, rows, rec,
    };
  }, [inputs, products, inventory, sellingPrices]);

  // Sensitivity data
  const sensData = useMemo(()=>{
    if (!result) return [];
    return runSensitivity(inputs, products, inventory, sensParam, SENS_STEPS);
  }, [inputs, products, inventory, sensParam, result]);

  // ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(()=>{
    if (!result || !chartBarRef.current) return;
    if (chartBarInst.current) chartBarInst.current.destroy();
    chartBarInst.current = new Chart(chartBarRef.current.getContext('2d'),{
      type:'bar',
      data:{
        labels:['T·ªìn kho BQ','L√¥ m·ªõi','BQ sau nh·∫≠p','ƒêi·ªÉm h√≤a v·ªën'],
        datasets:[{
          data:[result.curAvg, result.landedPerKg, result.newAvg, result.breakEven],
          backgroundColor:['#1e3a5f','#1a4d2e', result.newAvg > result.curAvg?'#7f1d1d':'#14532d','#4a1d96'],
          borderRadius:5, borderSkipped:false
        }]
      },
      options:{...CHART_DEFAULTS,
        plugins:{...CHART_DEFAULTS.plugins,
          tooltip:{callbacks:{label:c=>fv(c.parsed.y)+' ƒë/kg'}}
        },
        scales:{
          x:{grid:{color:'#0d1520'},ticks:{color:'#3a5070',font:{size:9}}},
          y:{beginAtZero:false, min:Math.min(result.curAvg,result.landedPerKg,result.newAvg,result.breakEven)*0.97,
             grid:{color:'#0d1520'},ticks:{color:'#3a5070',font:{size:9},callback:v=>fv(v)}}
        }
      }
    });
  },[result]);

  useEffect(()=>{
    if (!sensData.length || !chartSensRef.current) return;
    if (chartSensInst.current) chartSensInst.current.destroy();
    const labels = sensData.map(d=>(d.delta>=0?'+':'')+d.delta+(SENS_PARAMS.find(p=>p.key===sensParam)?.unit||'%'));
    chartSensInst.current = new Chart(chartSensRef.current.getContext('2d'),{
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'Gi√° BQ m·ªõi',data:sensData.map(d=>d.newAvg),borderColor:'#3b82f6',backgroundColor:'#3b82f620',tension:.35,fill:true,pointRadius:4,pointBackgroundColor:'#3b82f6'},
          {label:'ƒêi·ªÉm h√≤a v·ªën',data:sensData.map(d=>d.breakEven),borderColor:'#a855f7',backgroundColor:'transparent',tension:.35,borderDash:[4,3],pointRadius:3,pointBackgroundColor:'#a855f7'},
          {label:'Gi√° Hƒê',data:sensData.map(()=>inputs.contractPrice),borderColor:'#22c55e',backgroundColor:'transparent',borderDash:[6,4],pointRadius:0},
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:true, position:'bottom', labels:{color:'#4a6080',font:{size:10},padding:15,usePointStyle:true}},
          tooltip:{callbacks:{label:c=>c.dataset.label+': '+fv(c.parsed.y)+' ƒë/kg'}}
        },
        scales:{
          x:{grid:{color:'#0d1520'},ticks:{color:'#3a5070',font:{size:9}}},
          y:{beginAtZero:false,grid:{color:'#0d1520'},ticks:{color:'#3a5070',font:{size:9},callback:v=>fv(v)}}
        }
      }
    });
  },[sensData, sensParam]);

  // ‚îÄ‚îÄ‚îÄ INVENTORY CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const addInvRow    = () => setInventory(p=>[...p,{id:uid(),alloy:'A5052 H32',thickness:'1.0mm',qty:0,avgCost:0}]);
  const removeInvRow = id => setInventory(p=>p.filter(r=>r.id!==id));
  const setInvRow    = (id,f,v) => setInventory(p=>p.map(r=>r.id===id?{...r,[f]:v}:r));

  // ‚îÄ‚îÄ‚îÄ SELLING PRICE CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const addSP    = () => setSellingPrices(p=>[...p,{id:uid(),alloy:'A5052 H32',price:0}]);
  const removeSP = id => setSellingPrices(p=>p.filter(r=>r.id!==id));
  const setSP    = (id,f,v) => setSellingPrices(p=>p.map(r=>r.id===id?{...r,[f]:v}:r));

  // ‚îÄ‚îÄ‚îÄ PRODUCT CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const addRow    = () => setProducts(p=>[...p,{id:uid(),alloy:'A5052 H32',thickness:'1.0mm',width:'1200mm',weight:1000,priceFC:4000}]);
  const removeRow = id => { if(products.length>1) setProducts(p=>p.filter(r=>r.id!==id)); };
  const setRow    = (id,f,v) => setProducts(p=>p.map(r=>r.id===id?{...r,[f]:v}:r));

  // ‚îÄ‚îÄ‚îÄ SCENARIO SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const saveScenario = () => {
    if (!result) return;
    const name = `T${new Date().getMonth()+1}/${new Date().getFullYear().toString().slice(2)} ‚Äì ${products.map(p=>p.alloy.split(' ')[0]).join('+')}`;
    setScenarios(p=>[...p,{
      id:uid(), name,
      date: new Date().toLocaleDateString('vi-VN'),
      totalWeight:result.totalWeight, invoiceUSD:result.invoiceUSD,
      landedPerKg:result.landedPerKg, newAvg:result.newAvg,
      breakEven:result.breakEven, realProfit:result.realProfit,
      products:[...products], inputs:{...inputs}
    }]);
  };
  const loadScenario = s => { setProducts(s.products); setInputs(s.inputs); setTab('main'); };
  const removeScenario = id => setScenarios(p=>p.filter(s=>s.id!==id));

  // ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  return (
    <div style={{height:'100vh',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
      <div style={{background:'#080e18',borderBottom:'1px solid #111e2d',padding:'8px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
        <div style={{display:'flex',alignItems:'center',gap:'12px'}}>
          <div style={{background:'#2563eb',borderRadius:'6px',width:'28px',height:'28px',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:900,fontSize:'14px',color:'#fff',fontFamily:'JetBrains Mono'}}>P</div>
          <div>
            <div style={{fontWeight:900,fontSize:'15px',letterSpacing:'-0.02em'}}>PAKD BUY <span className="mono" style={{color:'#3b82f6',fontSize:'12px'}}>3.0</span></div>
            <div style={{fontSize:'10px',color:'#3a5070',fontWeight:600,textTransform:'uppercase',letterSpacing:'.06em'}}>Advanced Aluminum Import Strategy ¬∑ H&D</div>
          </div>
          <div style={{width:'1px',height:'24px',background:'#111e2d',margin:'0 4px'}}></div>
          {/* TABS */}
          {[
            {k:'main',     l:'üìä Ph√¢n t√≠ch ch√≠nh'},
            {k:'inventory',l:'üì¶ T·ªìn kho theo m√£'},
            {k:'selling',  l:'üè∑Ô∏è Gi√° b√°n theo m√£'},
            {k:'sens',     l:'üìà Sensitivity'},
            {k:'scenario', l:'üíæ Scenarios'},
          ].map(t=>(
            <button key={t.k} onClick={()=>setTab(t.k)}
              style={{background:tab===t.k?'#0d1824':'transparent',border:`1px solid ${tab===t.k?'#162030':'transparent'}`,
                borderRadius:'5px',padding:'4px 10px',fontSize:'.7rem',fontWeight:700,cursor:'pointer',
                color:tab===t.k?'#93c5fd':'#3a5070',transition:'all .15s'}}>
              {t.l}
            </button>
          ))}
        </div>
        <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
          {result && <span className={`tag ${result.rec.cls}`} style={{fontSize:'.7rem'}}>{result.rec.txt}</span>}
          <button className="btn btn-success btn-sm" onClick={saveScenario} style={{display:'flex',alignItems:'center',gap:'4px'}}>
            <Icon.Save/> L∆∞u Scenario
          </button>
          <button className="btn btn-solid btn-sm" onClick={()=>window.print()} style={{display:'flex',alignItems:'center',gap:'4px'}}>
            üñ®Ô∏è In A4
          </button>
        </div>
      </div>

      {/* ‚îÄ‚îÄ BODY ‚îÄ‚îÄ */}
      <div style={{flex:1,display:'flex',minHeight:0,overflow:'hidden'}}>

        {/* ‚ïê‚ïê‚ïê‚ïê TAB: MAIN ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='main' && (
          <div style={{display:'flex',width:'100%',height:'100%',minHeight:0}}>

            {/* LEFT: Config chung */}
            <div style={{width:'252px',flexShrink:0,background:'#080e18',borderRight:'1px solid #111e2d',overflowY:'auto',padding:'12px',display:'flex',flexDirection:'column',gap:'10px'}}>

              {/* Th√¥ng s·ªë l√¥ h√†ng */}
              <div className="card">
                <div className="sh"><Icon.Ship/>Th√¥ng s·ªë l√¥ h√†ng</div>
                <div className="lbl lbl-accent" style={{marginBottom:3}}>T·ª∑ gi√° USD/VND</div>
                <input className="inp mono-inp" style={{fontSize:'1rem',fontWeight:800,color:'#60a5fa',marginBottom:8,textAlign:'right'}}
                  value={fv(inputs.exchangeRate)} onChange={e=>setInp('exchangeRate',pn(e.target.value))} />

                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px',marginBottom:8}}>
                  <div>
                    <label className="lbl" style={{color:'#a855f7'}}>H·ªá s·ªë QL (%)</label>
                    <input type="number" step=".1" className="inp" value={inputs.managementFee} onChange={e=>setInp('managementFee',parseFloat(e.target.value)||0)} style={{color:'#c084fc'}}/>
                  </div>
                  <div>
                    <label className="lbl">Thu·∫ø NK (%)</label>
                    <input type="number" className="inp" value={inputs.importTax} onChange={e=>setInp('importTax',parseFloat(e.target.value)||0)}/>
                  </div>
                  <div>
                    <label className="lbl">C∆∞·ªõc + Logs (VND)</label>
                    <input className="inp mono-inp inp-xs" style={{textAlign:'right'}} value={fv(inputs.freightTotal)} onChange={e=>setInp('freightTotal',pn(e.target.value))}/>
                  </div>
                  <div>
                    <label className="lbl">Gia c√¥ng (ƒë/kg)</label>
                    <input type="number" className="inp" value={inputs.processingCost} onChange={e=>setInp('processingCost',pn(e.target.value))}/>
                  </div>
                  <div>
                    <label className="lbl">Lead time (ng√†y)</label>
                    <input type="number" className="inp" value={inputs.leadTime} onChange={e=>setInp('leadTime',parseInt(e.target.value)||0)}/>
                  </div>
                  <div>
                    <label className="lbl">Hold time (ng√†y)</label>
                    <input type="number" className="inp" value={inputs.holdingTime} onChange={e=>setInp('holdingTime',parseInt(e.target.value)||0)}/>
                  </div>
                </div>

                {/* Payment */}
                <div style={{display:'flex',gap:'4px',marginBottom:6}}>
                  {['TT','LC'].map(m=>(
                    <button key={m} onClick={()=>setInp('paymentMethod',m)}
                      style={{flex:1,padding:'4px',fontSize:'.68rem',fontWeight:700,borderRadius:'4px',cursor:'pointer',transition:'all .15s',
                        background:inputs.paymentMethod===m?(m==='TT'?'#1e2d3d':'#0d1f40'):'transparent',
                        border:`1px solid ${inputs.paymentMethod===m?(m==='TT'?'#334155':'#1e3a5f'):'#111e2d'}`,
                        color:inputs.paymentMethod===m?(m==='TT'?'#cbd5e1':'#93c5fd'):'#3a5070'}}>
                      {m==='TT'?'T/T Ti·ªÅn m·∫∑t':'L/C T√≠n d·ª•ng'}
                    </button>
                  ))}
                </div>
                {inputs.paymentMethod==='LC' ? (
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px',background:'#050b14',padding:'6px',borderRadius:'5px',border:'1px solid #0d1f35'}}>
                    <div><label className="lbl">Margin%</label><input type="number" className="inp inp-xs" value={inputs.lcMargin} onChange={e=>setInp('lcMargin',parseFloat(e.target.value)||0)}/></div>
                    <div><label className="lbl">Days</label><input type="number" className="inp inp-xs" value={inputs.lcDays} onChange={e=>setInp('lcDays',parseInt(e.target.value)||0)}/></div>
                    <div><label className="lbl">Int%</label><input type="number" step=".1" className="inp inp-xs" value={inputs.lcInterest} onChange={e=>setInp('lcInterest',parseFloat(e.target.value)||0)}/></div>
                  </div>
                ) : (
                  <div><label className="lbl">L√£i su·∫•t v·ªën (%/nƒÉm)</label><input type="number" step=".1" className="inp inp-xs" value={inputs.capitalCostPercent} onChange={e=>setInp('capitalCostPercent',parseFloat(e.target.value)||0)}/></div>
                )}
              </div>

              {/* Tham chi·∫øu gi√° b√°n */}
              <div className="card">
                <div className="sh"><Icon.Tag/>Tham chi·∫øu gi√° b√°n</div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px',marginBottom:8}}>
                  <div>
                    <label className="lbl" style={{color:'#4ade80'}}>Gi√° Hƒê/KH (ƒë/kg)</label>
                    <input className="inp mono-inp" style={{textAlign:'right',color:'#4ade80'}} value={fv(inputs.contractPrice)} onChange={e=>setInp('contractPrice',pn(e.target.value))}/>
                  </div>
                  <div>
                    <label className="lbl">Gi√° TT Spot</label>
                    <input className="inp mono-inp" style={{textAlign:'right'}} value={fv(inputs.marketPrice)} onChange={e=>setInp('marketPrice',pn(e.target.value))}/>
                  </div>
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px'}}>
                  <div>
                    <label className="lbl" style={{color:'#f87171'}}>R·ªßi ro KD (%)</label>
                    <input type="number" step=".1" className="inp" style={{color:'#f87171'}} value={inputs.businessRiskPercent} onChange={e=>setInp('businessRiskPercent',parseFloat(e.target.value)||0)}/>
                  </div>
                  <div>
                    <label className="lbl" style={{color:'#c084fc'}}>C√¥ng n·ª£ KH (ng√†y)</label>
                    <input type="number" className="inp" style={{color:'#c084fc'}} value={inputs.customerCreditDays} onChange={e=>setInp('customerCreditDays',parseInt(e.target.value)||0)}/>
                  </div>
                  <div>
                    <label className="lbl" style={{color:'#fbbf24'}}>L√£i vay (%/nƒÉm)</label>
                    <input type="number" step=".1" className="inp" style={{color:'#fbbf24'}} value={inputs.lendingRate} onChange={e=>setInp('lendingRate',parseFloat(e.target.value)||0)}/>
                  </div>
                </div>
              </div>
            </div>

            {/* CENTER: B·∫£ng m√£ nh√¥m */}
            <div style={{flex:1,minWidth:0,display:'flex',flexDirection:'column',background:'#070c14',borderRight:'1px solid #111e2d'}}>
              <div style={{padding:'8px 14px',borderBottom:'1px solid #111e2d',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
                <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                  <Icon.Ship/>
                  <span style={{fontWeight:800,fontSize:'.82rem'}}>Danh s√°ch m√£ nh√¥m ‚Äì L√¥ mua</span>
                  <span className="tag tag-g">{products.length} m√£</span>
                  {result && <span className="tag tag-b mono">{fv(result.totalWeight)} kg</span>}
                  {result && <span className="tag tag-y mono">{fu(result.invoiceUSD)}</span>}
                </div>
                <button className="btn btn-ghost" onClick={addRow}><Icon.Plus/> Th√™m m√£ nh√¥m</button>
              </div>

              <div style={{flex:1,overflowY:'auto',padding:'10px 14px'}}>
                <table className="tbl">
                  <thead>
                    <tr>
                      <th>#</th><th>M√°c nh√¥m</th><th>D√†y</th><th>Kh·ªï/D·∫°ng</th>
                      <th>KL (kg)</th><th>USD/T·∫•n</th><th>Invoice USD</th>
                      <th>Gi√° v·ªÅ kho<br/><span style={{fontWeight:400,textTransform:'none',fontSize:'.55rem',color:'#2a4060'}}>(ƒë/kg v·∫≠t l√Ω)</span></th>
                      <th>Break-even<br/><span style={{fontWeight:400,textTransform:'none',fontSize:'.55rem',color:'#2a4060'}}>(ƒë/kg)</span></th>
                      <th>Gi√° b√°n Hƒê<br/><span style={{fontWeight:400,textTransform:'none',fontSize:'.55rem',color:'#2a4060'}}>(ƒë/kg)</span></th>
                      <th>L√£i/L·ªó<br/><span style={{fontWeight:400,textTransform:'none',fontSize:'.55rem',color:'#2a4060'}}>(ƒë/kg)</span></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {products.map((p,i)=>{
                      const rb = result?.rows?.find(r=>r.id===p.id);
                      const loi = rb ? rb.sellPrice - (rb.perKg + (result.finPerKg||0) + (result.custFin||0)) : null;
                      return (
                        <tr key={p.id}>
                          <td style={{textAlign:'center',color:'#2a4060',fontSize:'.7rem'}} className="mono">{i+1}</td>
                          <td><select className="inp inp-xs" value={p.alloy} onChange={e=>setRow(p.id,'alloy',e.target.value)}>{ALLOYS.map(a=><option key={a}>{a}</option>)}</select></td>
                          <td><select className="inp inp-xs" value={p.thickness} onChange={e=>setRow(p.id,'thickness',e.target.value)}>{THICK.map(t=><option key={t}>{t}</option>)}</select></td>
                          <td><select className="inp inp-xs" value={p.width} onChange={e=>setRow(p.id,'width',e.target.value)}>{WIDTHS.map(w=><option key={w}>{w}</option>)}</select></td>
                          <td><input className="inp inp-xs mono-inp" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(p.weight)} onChange={e=>setRow(p.id,'weight',pn(e.target.value))}/></td>
                          <td><input type="number" className="inp inp-xs mono-inp" style={{textAlign:'right',color:'#fbbf24'}} value={p.priceFC} onChange={e=>setRow(p.id,'priceFC',parseFloat(e.target.value)||0)}/></td>
                          <td style={{textAlign:'right',paddingRight:8}} className="mono" style={{color:'#64748b',fontSize:'.72rem',textAlign:'right',paddingRight:6}}>{fu((p.weight/1000)*p.priceFC)}</td>
                          <td style={{textAlign:'right',paddingRight:8}}>
                            {rb ? <span className={`mono`} style={{fontSize:'.75rem',fontWeight:700,color:rb.perKg>(result.curAvg||0)?'#f87171':'#4ade80'}}>{fv(rb.perKg)}</span> : '‚Äî'}
                          </td>
                          <td style={{textAlign:'right',paddingRight:8}}>
                            {result ? <span className="mono" style={{fontSize:'.75rem',color:'#c084fc',fontWeight:700}}>{fv(result.breakEven)}</span> : '‚Äî'}
                          </td>
                          <td style={{textAlign:'right',paddingRight:8}}>
                            {rb ? <span className="mono" style={{fontSize:'.75rem',color:'#60a5fa'}}>{fv(rb.sellPrice)}</span> : '‚Äî'}
                          </td>
                          <td style={{textAlign:'right',paddingRight:8}}>
                            {loi!==null ? <span className="mono" style={{fontSize:'.75rem',fontWeight:800,color:loi>=0?'#4ade80':'#f87171'}}>{loi>=0?'+':''}{fv(loi)}</span> : '‚Äî'}
                          </td>
                          <td><button className="btn-danger" onClick={()=>removeRow(p.id)}><Icon.Trash/></button></td>
                        </tr>
                      );
                    })}
                  </tbody>
                  {result && (
                    <tfoot>
                      <tr>
                        <td colSpan={4} style={{textAlign:'right',color:'#3a5070',fontSize:'.68rem'}}>T·ªîNG / B√åNH QU√ÇN</td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#4ade80'}} className="mono">{fv(result.totalWeight)}</td>
                        <td></td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#fbbf24'}} className="mono">{fu(result.invoiceUSD)}</td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#60a5fa'}} className="mono">{fv(result.landedPerKg)}</td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#c084fc'}} className="mono">{fv(result.breakEven)}</td>
                        <td colSpan={3}></td>
                      </tr>
                    </tfoot>
                  )}
                </table>
              </div>

              {/* Cost Breakdown Bar */}
              {result && (
                <div style={{padding:'8px 14px 10px',borderTop:'1px solid #111e2d',flexShrink:0}}>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:'6px'}}>
                    {[
                      {l:'Invoice quy ƒë·ªïi', v:result.invoiceVND,   c:'#4a6080'},
                      {l:`Ph√≠ QL (${inputs.managementFee}%)`,v:result.mgmtVND,     c:'#7c3aed'},
                      {l:'Thu·∫ø NK',          v:result.taxVND,       c:'#b45309'},
                      {l:'C∆∞·ªõc + Logs',      v:result.freightVND,   c:'#0369a1'},
                      {l:'Gia c√¥ng',         v:result.procVND,      c:'#0f766e'},
                      {l:'CP t√†i ch√≠nh',     v:result.finVND,       c:'#9f1239'},
                    ].map((x,i)=>(
                      <div key={i} style={{background:'#080e18',border:'1px solid #111e2d',borderRadius:'5px',padding:'6px 8px',textAlign:'center'}}>
                        <div className="mono" style={{fontSize:'.72rem',fontWeight:700,color:x.c}}>{fv(x.v)}</div>
                        <div style={{fontSize:'.55rem',color:'#2a4060',marginTop:2}}>{x.l}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* RIGHT: KPI Dashboard */}
            <div style={{width:'238px',flexShrink:0,background:'#080e18',overflowY:'auto',padding:'10px',display:'flex',flexDirection:'column',gap:'8px'}}>

              {result ? (
                <>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px'}}>
                    <div className="kpi">
                      <div className="kpi-l">Gi√° BQ hi·ªán t·∫°i</div>
                      <div className="kpi-v" style={{fontSize:'1rem',color:'#94a3b8'}}>{fv(result.curAvg)}</div>
                      <div className="kpi-s">ƒë/kg ¬∑ {fv(result.totalStockQty)} kg t·ªìn</div>
                    </div>
                    <div className="kpi" style={{borderColor:result.landedPerKg>result.curAvg?'#7f1d1d':'#14532d'}}>
                      <div className="kpi-l">L√¥ m·ªõi v·ªÅ kho</div>
                      <div className="kpi-v" style={{fontSize:'1rem',color:result.landedPerKg>result.curAvg?'#f87171':'#4ade80'}}>{fv(result.landedPerKg)}</div>
                      <div className="kpi-s">ƒë/kg v·∫≠t l√Ω</div>
                    </div>
                  </div>

                  <div className="kpi" style={{background:'#050f25',borderColor:'#1e3a5f'}}>
                    <div className="kpi-l" style={{color:'#2563eb'}}>Gi√° B√¨nh Qu√¢n Sau Nh·∫≠p</div>
                    <div className="kpi-v" style={{fontSize:'1.4rem',color:'#60a5fa'}}>{fv(result.newAvg)}</div>
                    <div style={{display:'flex',alignItems:'center',gap:'6px',marginTop:4}}>
                      <span className="kpi-s">ƒë/kg</span>
                      <span className={`tag ${result.delta>0?'tag-r':'tag-g'} mono`} style={{fontSize:'.6rem'}}>
                        {result.delta>0?'‚ñ≤':'‚ñº'} {fv(Math.abs(result.delta))}
                      </span>
                    </div>
                  </div>

                  <div className="kpi" style={{background:'#0d0520',borderColor:'#6b21a8'}}>
                    <div className="kpi-l" style={{color:'#a855f7'}}>Break-even Price (H√≤a v·ªën)</div>
                    <div className="kpi-v" style={{fontSize:'1.1rem',color:'#c084fc'}}>{fv(result.breakEven)}</div>
                    <div className="kpi-s">ƒë/kg ¬∑ Gi√° b√°n t·ªëi thi·ªÉu</div>
                    <div style={{marginTop:6,background:'#050b14',borderRadius:4,padding:'4px 6px'}}>
                      <div style={{display:'flex',justifyContent:'space-between',fontSize:'.62rem'}}>
                        <span style={{color:'#3a5070'}}>Gi√° KT kinh t·∫ø</span>
                        <span className="mono" style={{color:'#7c3aed'}}>{fv(result.econCost)}</span>
                      </div>
                      <div style={{display:'flex',justifyContent:'space-between',fontSize:'.62rem',marginTop:2}}>
                        <span style={{color:'#3a5070'}}>CP c√¥ng n·ª£ KH</span>
                        <span className="mono" style={{color:'#6d28d9'}}>{fv(result.custFin)}</span>
                      </div>
                    </div>
                  </div>

                  <div className="kpi" style={{background:result.realProfit>0?'#050f08':'#140505',borderColor:result.realProfit>0?'#14532d':'#7f1d1d'}}>
                    <div className="kpi-l">{result.realProfit>0?'L·ª£i nhu·∫≠n th·ª±c':'L·ªó th·ª±c t·∫ø'}</div>
                    <div className="kpi-v" style={{fontSize:'1.2rem',color:result.realProfit>0?'#4ade80':'#f87171'}}>
                      {result.realProfit>0?'+':''}{fv(result.realProfit)}
                    </div>
                    <div className="kpi-s">ƒë/kg ¬∑ sau CP t√†i ch√≠nh & r·ªßi ro</div>
                  </div>

                  {/* Bar Chart */}
                  <div className="chart-wrap" style={{height:'160px',padding:'8px'}}>
                    <div style={{fontSize:'.58rem',color:'#2a4060',fontWeight:700,marginBottom:4,textTransform:'uppercase'}}>So s√°nh gi√° v·ªën</div>
                    <canvas ref={chartBarRef} style={{height:'130px'}}></canvas>
                  </div>

                  {/* Decision */}
                  <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
                    {[
                      {l:'vs H·ª£p ƒë·ªìng', ref:inputs.contractPrice, ok: result.newAvg<=inputs.contractPrice, yTxt:'C√ì L√ÉI', nTxt:'L·ªñ V·ªä TH·∫æ'},
                      {l:'vs Th·ªã tr∆∞·ªùng',ref:inputs.marketPrice,  ok: result.newAvg<=inputs.marketPrice,   yTxt:'C·∫†NH TRANH',nTxt:'CAO H∆†N TT'},
                    ].map((d,i)=>(
                      <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',background:'#050b14',border:'1px solid #111e2d',borderRadius:'5px',padding:'6px 8px'}}>
                        <div>
                          <div style={{fontSize:'.58rem',color:'#2a4060'}}>{d.l}</div>
                          <div className="mono" style={{fontSize:'.78rem',fontWeight:700,color:'#c9d4e8'}}>{fv(d.ref)}</div>
                        </div>
                        <span className={`tag ${d.ok?'tag-g':'tag-r'}`}>{d.ok?d.yTxt:d.nTxt}</span>
                      </div>
                    ))}
                  </div>

                  <div style={{textAlign:'center',padding:'8px',borderRadius:'6px',border:`1px solid ${result.rec.cls==='tag-g'?'#14532d':result.rec.cls==='tag-b'?'#1e3a5f':'#7f1d1d'}`,background:result.rec.cls==='tag-g'?'#040d07':result.rec.cls==='tag-b'?'#040d1a':'#0d0404'}}>
                    <div style={{fontSize:'.58rem',color:'#2a4060',marginBottom:2}}>KHUY·∫æN NGH·ªä</div>
                    <div style={{fontSize:'1rem',fontWeight:900,color:result.rec.cls==='tag-g'?'#4ade80':result.rec.cls==='tag-b'?'#60a5fa':'#f87171'}}>{result.rec.txt}</div>
                  </div>
                </>
              ) : (
                <div style={{textAlign:'center',padding:'24px',color:'#2a4060',fontSize:'.8rem'}}>Nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ xem k·∫øt qu·∫£</div>
              )}
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB: INVENTORY ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='inventory' && (
          <div style={{flex:1,padding:'20px',overflowY:'auto'}}>
            <div style={{maxWidth:'800px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                <div>
                  <h2 style={{fontWeight:800,fontSize:'1.1rem'}}>üì¶ T·ªìn kho theo t·ª´ng m√£ nh√¥m</h2>
                  <p style={{fontSize:'.75rem',color:'#3a5070',marginTop:3}}>Nh·∫≠p ch√≠nh x√°c theo alloy + thickness ƒë·ªÉ t√≠nh b√¨nh qu√¢n ƒë√∫ng nghi·ªáp v·ª•</p>
                </div>
                <button className="btn btn-ghost" onClick={addInvRow}><Icon.Plus/> Th√™m m√£ t·ªìn kho</button>
              </div>

              <table className="tbl" style={{background:'#080e18',borderRadius:'8px',overflow:'hidden'}}>
                <thead>
                  <tr>
                    <th>#</th><th>M√°c nh√¥m</th><th>ƒê·ªô d√†y</th>
                    <th>T·ªìn kho (kg)</th><th>Gi√° v·ªën (ƒë/kg)</th>
                    <th>T·ªïng gi√° tr·ªã (VND)</th><th>% T·ªïng t·ªìn</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {inventory.map((r,i)=>{
                    const totalVal = inventory.reduce((s,x)=>s+x.qty*x.avgCost,0);
                    const myVal = r.qty*r.avgCost;
                    const pct2 = totalVal>0 ? myVal/totalVal*100 : 0;
                    return (
                      <tr key={r.id}>
                        <td style={{textAlign:'center',color:'#2a4060',fontSize:'.7rem'}} className="mono">{i+1}</td>
                        <td><select className="inp inp-xs" value={r.alloy} onChange={e=>setInvRow(r.id,'alloy',e.target.value)}>{ALLOYS.map(a=><option key={a}>{a}</option>)}</select></td>
                        <td><select className="inp inp-xs" value={r.thickness} onChange={e=>setInvRow(r.id,'thickness',e.target.value)}>{THICK.map(t=><option key={t}>{t}</option>)}</select></td>
                        <td><input className="inp inp-xs mono-inp" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(r.qty)} onChange={e=>setInvRow(r.id,'qty',pn(e.target.value))}/></td>
                        <td><input className="inp inp-xs mono-inp" style={{textAlign:'right'}} value={fv(r.avgCost)} onChange={e=>setInvRow(r.id,'avgCost',pn(e.target.value))}/></td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#60a5fa'}} className="mono">{fv(myVal)}</td>
                        <td>
                          <div style={{display:'flex',alignItems:'center',gap:'6px'}}>
                            <div style={{flex:1,height:'4px',background:'#111e2d',borderRadius:'2px'}}>
                              <div style={{width:pct2+'%',height:'100%',background:'#2563eb',borderRadius:'2px',transition:'width .3s'}}></div>
                            </div>
                            <span className="mono" style={{fontSize:'.65rem',color:'#3a5070',minWidth:'30px'}}>{pct2.toFixed(0)}%</span>
                          </div>
                        </td>
                        <td><button className="btn-danger" onClick={()=>removeInvRow(r.id)}><Icon.Trash/></button></td>
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot>
                  <tr>
                    <td colSpan={3} style={{textAlign:'right',color:'#3a5070',fontSize:'.68rem',paddingRight:8}}>T·ªîNG</td>
                    <td style={{textAlign:'right',paddingRight:8,color:'#4ade80'}} className="mono">
                      {fv(inventory.reduce((s,r)=>s+r.qty,0))} kg
                    </td>
                    <td style={{textAlign:'right',paddingRight:8,color:'#94a3b8'}} className="mono">
                      {fv(inventory.reduce((s,r)=>s+r.qty*r.avgCost,0)>0 ? inventory.reduce((s,r)=>s+r.qty*r.avgCost,0)/inventory.reduce((s,r)=>s+r.qty,1) : 0)} ƒë/kg avg
                    </td>
                    <td style={{textAlign:'right',paddingRight:8,color:'#60a5fa'}} className="mono">
                      {fv(inventory.reduce((s,r)=>s+r.qty*r.avgCost,0))} VND
                    </td>
                    <td colSpan={2}></td>
                  </tr>
                </tfoot>
              </table>

              {/* Per-alloy summary cards */}
              <div style={{marginTop:16}}>
                <div style={{fontSize:'.7rem',fontWeight:700,color:'#2a4060',marginBottom:8,textTransform:'uppercase',letterSpacing:'.06em'}}>T√≥m t·∫Øt theo m√°c nh√¥m</div>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(180px,1fr))',gap:'8px'}}>
                  {Object.entries(inventory.reduce((acc,r)=>{
                    if (!acc[r.alloy]) acc[r.alloy]={qty:0,val:0};
                    acc[r.alloy].qty += r.qty;
                    acc[r.alloy].val += r.qty*r.avgCost;
                    return acc;
                  },{})).map(([alloy,d])=>(
                    <div key={alloy} className="card-dark" style={{border:'1px solid #0f1e2d'}}>
                      <div style={{fontSize:'.7rem',fontWeight:800,color:'#4a6080',marginBottom:6}}>{alloy}</div>
                      <div className="mono" style={{fontSize:'1.1rem',fontWeight:800,color:'#4ade80'}}>{fv(d.qty)} <span style={{fontSize:'.65rem',color:'#2a4060'}}>kg</span></div>
                      <div className="mono" style={{fontSize:'.75rem',color:'#60a5fa',marginTop:2}}>{fv(d.qty>0?d.val/d.qty:0)} <span style={{fontSize:'.6rem',color:'#2a4060'}}>ƒë/kg avg</span></div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB: SELLING PRICES ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='selling' && (
          <div style={{flex:1,padding:'20px',overflowY:'auto'}}>
            <div style={{maxWidth:'700px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                <div>
                  <h2 style={{fontWeight:800,fontSize:'1.1rem'}}>üè∑Ô∏è Gi√° b√°n theo t·ª´ng m√£ nh√¥m</h2>
                  <p style={{fontSize:'.75rem',color:'#3a5070',marginTop:3}}>A5052 v√† A3003 c√≥ gi√° b√°n kh√°c nhau ‚Äì c·∫•u h√¨nh ·ªü ƒë√¢y ƒë·ªÉ t√≠nh l√£i/l·ªó ƒë√∫ng</p>
                </div>
                <button className="btn btn-ghost" onClick={addSP}><Icon.Plus/> Th√™m m√£ gi√°</button>
              </div>

              <table className="tbl" style={{background:'#080e18',borderRadius:'8px',overflow:'hidden'}}>
                <thead>
                  <tr>
                    <th>#</th><th>M√°c nh√¥m</th><th>Gi√° b√°n Hƒê/KH (ƒë/kg)</th>
                    <th>Ch√™nh vs contractPrice m·∫∑c ƒë·ªãnh</th><th>Premium/Discount</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  {sellingPrices.map((sp,i)=>{
                    const diff = sp.price - inputs.contractPrice;
                    return (
                      <tr key={sp.id}>
                        <td style={{textAlign:'center',color:'#2a4060',fontSize:'.7rem'}} className="mono">{i+1}</td>
                        <td><select className="inp inp-xs" value={sp.alloy} onChange={e=>setSP(sp.id,'alloy',e.target.value)}>{ALLOYS.map(a=><option key={a}>{a}</option>)}</select></td>
                        <td><input className="inp inp-sm mono-inp" style={{textAlign:'right',color:'#4ade80',fontWeight:700}} value={fv(sp.price)} onChange={e=>setSP(sp.id,'price',pn(e.target.value))}/></td>
                        <td style={{textAlign:'center'}}>
                          <span className={`tag ${diff>=0?'tag-g':'tag-r'} mono`}>{diff>=0?'+':''}{fv(diff)} ƒë/kg</span>
                        </td>
                        <td style={{textAlign:'center'}}>
                          <span className={`tag ${diff>=0?'tag-g':'tag-r'}`} style={{fontSize:'.6rem'}}>
                            {diff>=0?'+':''}{inputs.contractPrice>0?(diff/inputs.contractPrice*100).toFixed(1):'0'}%
                          </span>
                        </td>
                        <td><button className="btn-danger" onClick={()=>removeSP(sp.id)}><Icon.Trash/></button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>

              <div className="card" style={{marginTop:16,background:'#050f1a',borderColor:'#0f1e30'}}>
                <div style={{fontSize:'.72rem',color:'#3a5070',lineHeight:1.6}}>
                  üí° <strong style={{color:'#4a6080'}}>C√°ch ho·∫°t ƒë·ªông:</strong> Khi nh·∫≠p m√£ nh√¥m ·ªü tab Ph√¢n t√≠ch ch√≠nh, h·ªá th·ªëng s·∫Ω tra b·∫£ng n√†y ƒë·ªÉ t√≠nh l√£i/l·ªó ch√≠nh x√°c theo t·ª´ng m√£. N·∫øu kh√¥ng c√≥ trong b·∫£ng, h·ªá th·ªëng d√πng <strong style={{color:'#60a5fa'}}>Gi√° Hƒê m·∫∑c ƒë·ªãnh ({fv(inputs.contractPrice)} ƒë/kg)</strong>.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB: SENSITIVITY ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='sens' && (
          <div style={{flex:1,padding:'20px',overflowY:'auto'}}>
            <div style={{maxWidth:'900px',margin:'0 auto'}}>
              <div style={{marginBottom:'16px'}}>
                <h2 style={{fontWeight:800,fontSize:'1.1rem'}}>üìà Sensitivity Analysis ‚Äì Ph√¢n t√≠ch ƒê·ªô nh·∫°y</h2>
                <p style={{fontSize:'.75rem',color:'#3a5070',marginTop:3}}>Xem Gi√° BQ m·ªõi & Break-even thay ƒë·ªïi nh∆∞ th·∫ø n√†o khi c√°c bi·∫øn s·ªë dao ƒë·ªông</p>
              </div>

              {/* Param selector */}
              <div style={{display:'flex',gap:'8px',marginBottom:'16px'}}>
                {SENS_PARAMS.map(p=>(
                  <button key={p.key} onClick={()=>setSensParam(p.key)}
                    style={{padding:'6px 14px',fontSize:'.72rem',fontWeight:700,borderRadius:'5px',cursor:'pointer',transition:'all .15s',
                      background:sensParam===p.key?'#0d1f40':'#080e18',
                      border:`1px solid ${sensParam===p.key?'#2563eb':'#111e2d'}`,
                      color:sensParam===p.key?'#93c5fd':'#3a5070'}}>
                    {p.label}
                  </button>
                ))}
              </div>

              {/* Chart */}
              <div className="chart-wrap" style={{height:'280px',padding:'12px',marginBottom:'16px'}}>
                <canvas ref={chartSensRef}></canvas>
              </div>

              {/* Table */}
              <div style={{fontSize:'.72rem',fontWeight:700,color:'#2a4060',marginBottom:'8px',textTransform:'uppercase'}}>Chi ti·∫øt theo k·ªãch b·∫£n</div>
              <table className="tbl" style={{background:'#080e18',borderRadius:'8px',overflow:'hidden'}}>
                <thead>
                  <tr>
                    <th>Bi·∫øn ƒë·ªông ({SENS_PARAMS.find(p=>p.key===sensParam)?.unit})</th>
                    <th>Gi√° BQ m·ªõi (ƒë/kg)</th>
                    <th>Break-even (ƒë/kg)</th>
                    <th>L√£i th·ª±c (ƒë/kg)</th>
                    <th>vs Gi√° Hƒê</th>
                    <th>Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody>
                  {sensData.map((d,i)=>{
                    const ok = d.newAvg <= inputs.contractPrice;
                    const isBase = d.delta===0;
                    return (
                      <tr key={i} className="sens-row" style={{background:isBase?'#080e18':''}}>
                        <td style={{textAlign:'center',fontWeight:isBase?800:400}}>
                          <span className={`tag ${d.delta===0?'tag-b':d.delta<0?'tag-g':'tag-r'} mono`}>
                            {d.delta>=0?'+':''}{d.delta}{SENS_PARAMS.find(p=>p.key===sensParam)?.unit}
                          </span>
                          {isBase && <span style={{fontSize:'.58rem',color:'#2563eb',marginLeft:4}}>(Base)</span>}
                        </td>
                        <td style={{textAlign:'right',paddingRight:8}} className="mono" style={{color:d.newAvg>=(result?.curAvg||0)?'#f87171':'#4ade80',fontWeight:700,textAlign:'right',paddingRight:8}}>{fv(d.newAvg)}</td>
                        <td style={{textAlign:'right',paddingRight:8,color:'#c084fc'}} className="mono">{fv(d.breakEven)}</td>
                        <td style={{textAlign:'right',paddingRight:8}} className="mono" style={{color:d.realProfit>0?'#4ade80':'#f87171',fontWeight:700,textAlign:'right',paddingRight:8}}>{d.realProfit>0?'+':''}{fv(d.realProfit)}</td>
                        <td style={{textAlign:'center'}}>
                          <span className="mono" style={{fontSize:'.7rem',color:d.newAvg<=inputs.contractPrice?'#4ade80':'#f87171'}}>
                            {d.newAvg<=inputs.contractPrice?'+':''}{fv(inputs.contractPrice-d.newAvg)} ƒë/kg
                          </span>
                        </td>
                        <td style={{textAlign:'center'}}>
                          <span className={`tag ${ok?'tag-g':'tag-r'}`}>{ok?'C√ì L√ÉI':'R·ª¶I RO'}</span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>

              <div className="card" style={{marginTop:12,background:'#050a14',borderColor:'#0f1e30'}}>
                <div style={{fontSize:'.72rem',color:'#3a5070',lineHeight:1.7}}>
                  <strong style={{color:'#4a6080'}}>H∆∞·ªõng d·∫´n ƒë·ªçc:</strong> D√≤ng <span className="tag tag-b" style={{fontSize:'.6rem'}}>+0</span> l√† k·ªãch b·∫£n hi·ªán t·∫°i (Base). C√°c d√≤ng c√≤n l·∫°i cho th·∫•y n·∫øu bi·∫øn s·ªë tƒÉng/gi·∫£m th√¨ Break-even v√† L√£i th·ª±c thay ƒë·ªïi nh∆∞ th·∫ø n√†o. ƒê∆∞·ªùng <span style={{color:'#22c55e',fontWeight:700}}>xanh l√°</span> tr√™n chart l√† Gi√° H·ª£p ƒë·ªìng ‚Äì khi n√†o Gi√° BQ v∆∞·ª£t qua ƒë∆∞·ªùng ƒë√≥ l√† r·ªßi ro l·ªó v·ªã th·∫ø.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê‚ïê TAB: SCENARIOS ‚ïê‚ïê‚ïê‚ïê */}
        {tab==='scenario' && (
          <div style={{flex:1,padding:'20px',overflowY:'auto'}}>
            <div style={{maxWidth:'900px',margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                <div>
                  <h2 style={{fontWeight:800,fontSize:'1.1rem'}}>üíæ Scenarios ƒë√£ l∆∞u</h2>
                  <p style={{fontSize:'.75rem',color:'#3a5070',marginTop:3}}>So s√°nh c√°c ph∆∞∆°ng √°n nh·∫≠p h√†ng kh√°c nhau</p>
                </div>
                <button className="btn btn-success" onClick={saveScenario}><Icon.Save/> L∆∞u scenario hi·ªán t·∫°i</button>
              </div>

              {scenarios.length===0 ? (
                <div className="card" style={{textAlign:'center',padding:'48px',border:'1px dashed #1a2d45'}}>
                  <div style={{fontSize:'2rem',marginBottom:'12px'}}>üíæ</div>
                  <div style={{fontWeight:700,color:'#3a5070',marginBottom:8}}>Ch∆∞a c√≥ scenario n√†o</div>
                  <div style={{fontSize:'.75rem',color:'#2a4060'}}>Nh·∫≠p d·ªØ li·ªáu ·ªü tab Ph√¢n t√≠ch ch√≠nh r·ªìi nh·∫•n "L∆∞u Scenario" ·ªü thanh tr√™n</div>
                </div>
              ) : (
                <>
                  {/* Comparison table */}
                  <table className="tbl" style={{background:'#080e18',borderRadius:'8px',overflow:'hidden',marginBottom:'16px'}}>
                    <thead>
                      <tr>
                        <th>#</th><th style={{textAlign:'left',paddingLeft:8}}>T√™n Scenario</th><th>Ng√†y</th>
                        <th>KL (kg)</th><th>Invoice</th><th>Gi√° v·ªÅ kho</th><th>Gi√° BQ m·ªõi</th>
                        <th>Break-even</th><th>L√£i/L·ªó</th><th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody>
                      {scenarios.map((s,i)=>(
                        <tr key={s.id}>
                          <td style={{textAlign:'center',color:'#2a4060',fontSize:'.7rem'}} className="mono">{i+1}</td>
                          <td style={{paddingLeft:8,fontWeight:700,color:'#c9d4e8',fontSize:'.78rem'}}>{s.name}</td>
                          <td style={{textAlign:'center',color:'#3a5070',fontSize:'.7rem'}}>{s.date}</td>
                          <td style={{textAlign:'right',paddingRight:8}} className="mono" style={{color:'#4ade80',textAlign:'right',paddingRight:8}}>{fv(s.totalWeight)}</td>
                          <td style={{textAlign:'right',paddingRight:8,color:'#fbbf24'}} className="mono">{fu(s.invoiceUSD)}</td>
                          <td style={{textAlign:'right',paddingRight:8,color:'#60a5fa'}} className="mono">{fv(s.landedPerKg)}</td>
                          <td style={{textAlign:'right',paddingRight:8,color:'#93c5fd',fontWeight:700}} className="mono">{fv(s.newAvg)}</td>
                          <td style={{textAlign:'right',paddingRight:8,color:'#c084fc'}} className="mono">{fv(s.breakEven)}</td>
                          <td style={{textAlign:'right',paddingRight:8}}>
                            <span className="mono" style={{color:s.realProfit>=0?'#4ade80':'#f87171',fontWeight:700}}>
                              {s.realProfit>=0?'+':''}{fv(s.realProfit)}
                            </span>
                          </td>
                          <td style={{textAlign:'center'}}>
                            <div style={{display:'flex',gap:'4px',justifyContent:'center'}}>
                              <button className="btn btn-solid btn-sm" onClick={()=>loadScenario(s)} style={{fontSize:'.6rem',padding:'2px 7px'}}>T·∫£i</button>
                              <button className="btn-danger" onClick={()=>removeScenario(s.id)}><Icon.Trash/></button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>

                  {/* Mini comparison cards */}
                  {scenarios.length>=2 && (
                    <div>
                      <div style={{fontSize:'.7rem',fontWeight:700,color:'#2a4060',marginBottom:'8px',textTransform:'uppercase'}}>So s√°nh Break-even & L√£i th·ª±c</div>
                      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(220px,1fr))',gap:'8px'}}>
                        {scenarios.map((s,i)=>(
                          <div key={s.id} className="card-dark" style={{border:'1px solid #0f1e2d'}}>
                            <div style={{fontSize:'.68rem',fontWeight:800,color:'#4a6080',marginBottom:8,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                              <span>{s.name}</span>
                              <span style={{color:'#2a4060',fontWeight:400}}>{s.date}</span>
                            </div>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px'}}>
                              {[
                                {l:'Break-even',v:s.breakEven,c:'#c084fc'},
                                {l:'L√£i th·ª±c',v:s.realProfit,c:s.realProfit>=0?'#4ade80':'#f87171'},
                                {l:'Gi√° BQ',v:s.newAvg,c:'#60a5fa'},
                                {l:'Landed/kg',v:s.landedPerKg,c:'#94a3b8'},
                              ].map((x,j)=>(
                                <div key={j}>
                                  <div style={{fontSize:'.55rem',color:'#2a4060'}}>{x.l}</div>
                                  <div className="mono" style={{fontSize:'.82rem',fontWeight:700,color:x.c}}>{fv(x.v)}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        )}

      </div>{/* end body */}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
